<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T-ANIME | Premium Streaming</title>
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Icons (Phosphor Icons) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* ==========================================================================
           1. CSS VARIABLES & THEME
           ========================================================================== */
        :root {
            --bg-main: #05050A;
            --bg-sidebar: rgba(10, 10, 18, 0.6);
            --bg-card: rgba(20, 20, 30, 0.4);
            --bg-glass: rgba(255, 255, 255, 0.04);
            --bg-glass-hover: rgba(255, 255, 255, 0.08);
            
            --text-light: #E2E2EC;
            --text-muted: #8A8A9D;
            --text-white: #FFFFFF;
            
            --accent-purple: #B026FF;
            --accent-cyan: #00D1F5;
            --accent-yellow: #FFB800;
            --accent-red: #FF3B30;

            --border-glass: rgba(255, 255, 255, 0.05);
            --border-glass-strong: rgba(255, 255, 255, 0.1);

            --shadow-glow-purple: 0 0 24px rgba(176, 38, 255, 0.3);
            --shadow-glow-cyan: 0 0 24px rgba(0, 209, 245, 0.3);
            --shadow-panel: 0 24px 48px rgba(0, 0, 0, 0.8);
            
            --font-main: 'Inter', sans-serif;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --sidebar-width: 260px;
        }

        /* --- LIGHT MODE VARIABLES --- */
        [data-theme="light"] {
            --bg-main: #F4F4F9;
            --bg-sidebar: rgba(255, 255, 255, 0.8);
            --bg-card: rgba(255, 255, 255, 0.6);
            --bg-glass: rgba(0, 0, 0, 0.03);
            --bg-glass-hover: rgba(0, 0, 0, 0.06);
            
            --text-light: #1A1A2E;
            --text-muted: #6B6B80;
            --text-white: #000000;
            
            --accent-purple: #9000FF;
            --accent-cyan: #0088A8;
            
            --border-glass: rgba(0, 0, 0, 0.06);
            --border-glass-strong: rgba(0, 0, 0, 0.12);
            --shadow-panel: 0 12px 32px rgba(0, 0, 0, 0.08);
        }

        /* --- COLOR THEMES --- */
        [data-color="emerald"] { --accent-purple: #10B981; --accent-cyan: #14B8A6; --shadow-glow-purple: 0 0 24px rgba(16,185,129,0.3); --shadow-glow-cyan: 0 0 24px rgba(20,184,166,0.3); }
        [data-color="rose"] { --accent-purple: #F43F5E; --accent-cyan: #F97316; --shadow-glow-purple: 0 0 24px rgba(244,63,94,0.3); --shadow-glow-cyan: 0 0 24px rgba(249,115,22,0.3); }
        [data-color="amber"] { --accent-purple: #F59E0B; --accent-cyan: #EF4444; --shadow-glow-purple: 0 0 24px rgba(245,158,11,0.3); --shadow-glow-cyan: 0 0 24px rgba(239,68,68,0.3); }
        [data-color="blue"] { --accent-purple: #3B82F6; --accent-cyan: #6366F1; --shadow-glow-purple: 0 0 24px rgba(59,130,246,0.3); --shadow-glow-cyan: 0 0 24px rgba(99,102,241,0.3); }

        /* ==========================================================================
           2. BASE & RESET
           ========================================================================== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* Tự động thu nhỏ toàn bộ giao diện (rem units) trên thiết bị nhỏ */
        html { font-size: 16px; }
        @media (max-width: 1024px) { html { font-size: 15px; } }
        @media (max-width: 768px) { html { font-size: 14px; } }
        @media (max-width: 480px) { html { font-size: 13.5px; } }

        body { font-family: var(--font-main); background-color: var(--bg-main); color: var(--text-light); line-height: 1.6; overflow-x: hidden; scroll-behavior: smooth; transition: background-color 0.5s ease; -webkit-tap-highlight-color: transparent;}
        body.modal-open { overflow: hidden; }
        ::selection { background-color: var(--accent-purple); color: #fff; }
        a { text-decoration: none; color: inherit; }
        button { border: none; background: none; cursor: pointer; font-family: inherit; outline: none; }
        ul { list-style: none; }
        img { max-width: 100%; height: auto; display: block; }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(138, 138, 157, 0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-cyan); }

        /* Ambient Background */
        #app-bg { position: fixed; inset: -50px; z-index: -2; background-size: cover; background-position: center; filter: blur(70px) brightness(0.3); transition: background-image 1.5s ease-in-out; transform: scale(1.1); }
        #app-bg-overlay { position: fixed; inset: 0; z-index: -1; background: linear-gradient(to bottom, rgba(5,5,10,0.7) 0%, rgba(5,5,10,0.98) 100%); transition: background 0.5s ease; }
        [data-theme="light"] #app-bg { filter: blur(70px) brightness(0.85); }
        [data-theme="light"] #app-bg-overlay { background: linear-gradient(to bottom, rgba(244,244,249,0.7) 0%, rgba(244,244,249,0.98) 100%); }

        .gradient-text { background: linear-gradient(to right, var(--accent-purple), var(--accent-cyan)); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        .flex-between { display: flex; align-items: center; justify-content: space-between; }
        
        .glass-panel { background: var(--bg-card); border: 1px solid var(--border-glass); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border-radius: 24px; box-shadow: var(--shadow-panel); }

        /* Loader */
        #loader { position: fixed; inset: 0; background: var(--bg-main); z-index: 9999; flex-direction: column; }
        .spinner { width: 56px; height: 56px; border: 3px solid rgba(0,209,245,0.2); border-top-color: var(--accent-cyan); border-radius: 50%; animation: spin 1s linear infinite; }
        .loader-text { margin-top: 24px; font-size: 0.875rem; font-weight: 700; letter-spacing: 0.2em; color: var(--text-muted); animation: pulse 2s infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }

        /* ==========================================================================
           3. APP LAYOUT (SIDEBAR + MAIN)
           ========================================================================== */
        .app-wrapper { display: flex; min-height: 100vh; }
        
        /* SIDEBAR (Desktop) */
        .sidebar { 
            position: fixed; top: 0; left: 0; width: var(--sidebar-width); height: 100vh; 
            background: var(--bg-sidebar); border-right: 1px solid var(--border-glass);
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            display: flex; flex-direction: column; padding: 32px 24px; z-index: 100;
        }
        .sidebar-logo { font-size: 2rem; font-weight: 900; font-style: italic; letter-spacing: -1px; margin-bottom: 48px; text-align: center; cursor: pointer;}
        
        .nav-menu { display: flex; flex-direction: column; gap: 8px; flex: 1;}
        .nav-label { font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin: 16px 0 8px 12px; }
        
        .nav-item { 
            display: flex; align-items: center; gap: 14px; padding: 14px 16px; 
            border-radius: 16px; color: var(--text-muted); font-weight: 600; font-size: 0.95rem;
            transition: var(--transition); cursor: pointer; border: 1px solid transparent;
        }
        .nav-item i { font-size: 1.4rem; transition: transform 0.3s; }
        .nav-item:hover { color: var(--text-white); background: var(--bg-glass); transform: translateX(4px);}
        .nav-item:hover i { transform: scale(1.1); color: var(--accent-cyan);}
        
        .nav-item.active { 
            background: linear-gradient(135deg, rgba(176,38,255,0.1), rgba(0,209,245,0.1)); 
            border-color: rgba(0, 209, 245, 0.2); color: var(--text-white); box-shadow: inset 0 0 20px rgba(0, 209, 245, 0.05);
        }
        .nav-item.active i { color: var(--accent-cyan); }
        .nav-item.story-btn { background: linear-gradient(45deg, var(--accent-purple), var(--accent-cyan)); color: white; border: none; margin-top: 8px; box-shadow: var(--shadow-glow-purple); justify-content: center;}
        .nav-item.story-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(176,38,255,0.4); }

        .sidebar-footer { margin-top: auto; display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--bg-glass); border-radius: 16px; border: 1px solid var(--border-glass-strong); cursor: pointer; transition: var(--transition);}
        .sidebar-footer:hover { background: var(--bg-glass-hover); }
        .sf-avatar { width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan)); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;}
        .sf-info { flex: 1; overflow: hidden; }
        .sf-name { font-size: 0.9rem; font-weight: 700; color: var(--text-white); white-space: nowrap; text-overflow: ellipsis; overflow: hidden;}
        .sf-sub { font-size: 0.75rem; color: var(--text-muted); }

        /* MAIN COLUMN */
        .main-column { margin-left: var(--sidebar-width); flex: 1; display: flex; flex-direction: column; min-height: 100vh; position: relative;}
        
        /* TOP HEADER (Search & Actions) */
        .top-header { 
            position: sticky; top: 0; left: 0; width: 100%; height: 88px; 
            display: flex; align-items: center; justify-content: space-between; padding: 0 40px;
            background: linear-gradient(to bottom, var(--bg-main) 0%, transparent 100%);
            z-index: 90;
        }
        
        .mobile-logo { display: none; }
        
        .search-container { position: relative; width: 100%; max-width: 400px; }
        .search-box { display: flex; align-items: center; gap: 12px; background: var(--bg-glass); border: 1px solid var(--border-glass-strong); border-radius: 999px; padding: 12px 24px; transition: var(--transition); backdrop-filter: blur(10px);}
        .search-box:focus-within { background: var(--bg-card); border-color: var(--accent-cyan); box-shadow: var(--shadow-glow-cyan); }
        .search-box input { background: transparent; border: none; color: var(--text-white); width: 100%; font-family: inherit; outline: none;}
        /* Khoá zoom trên mobile */
        .search-box input[type="text"] { font-size: 16px !important; }
        .search-box input::placeholder { color: var(--text-muted); font-weight: 500;}
        
        .search-dropdown { position: absolute; top: calc(100% + 12px); left: 0; width: 150%; background: var(--bg-card); border: 1px solid var(--border-glass-strong); border-radius: 20px; box-shadow: var(--shadow-panel); max-height: 60vh; overflow-y: auto; display: none; z-index: 101; backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); padding: 12px; }
        [data-theme="light"] .search-dropdown { background: rgba(255,255,255,0.95); }
        .search-item { display: flex; gap: 16px; padding: 12px; border-radius: 16px; cursor: pointer; transition: var(--transition); }
        .search-item:hover { background: var(--bg-glass-hover); transform: translateX(4px);}
        .search-thumb { width: 54px; height: 76px; border-radius: 10px; background: #1F2937; overflow: hidden; flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.3);}
        .search-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .search-info { display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .search-title { font-size: 0.95rem; font-weight: 800; color: var(--text-white); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .search-origin { font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;}
        .search-msg { padding: 32px; text-align: center; font-size: 0.95rem; color: var(--text-muted); font-weight: 500;}

        .header-actions { display: flex; align-items: center; gap: 16px; }
        .header-btn { width: 44px; height: 44px; border-radius: 50%; background: var(--bg-glass); border: 1px solid var(--border-glass); display: flex; align-items: center; justify-content: center; color: var(--text-white); font-size: 1.3rem; transition: var(--transition); position: relative;}
        .header-btn:hover { background: var(--bg-glass-hover); color: var(--accent-cyan); transform: translateY(-2px);}
        .header-btn .badge { position: absolute; top: 10px; right: 10px; width: 8px; height: 8px; background: var(--accent-red); border-radius: 50%; box-shadow: 0 0 8px var(--accent-red);}

        /* ==========================================================================
           4. RIGHT SIDE-PANEL (Trình Quản Lý Cá Nhân)
           ========================================================================== */
        .side-panel-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; backdrop-filter: blur(4px); display: none; opacity: 0; transition: opacity 0.3s; }
        .side-panel { 
            position: fixed; top: 0; right: 0; width: 400px; height: 100vh; 
            background: rgba(15,15,22,0.85); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
            border-left: 1px solid var(--border-glass-strong); z-index: 2001; 
            transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column; box-shadow: -20px 0 50px rgba(0,0,0,0.5);
        }
        [data-theme="light"] .side-panel { background: rgba(255,255,255,0.9); }
        .side-panel.open { transform: translateX(0); }
        .side-panel-overlay.show { display: block; opacity: 1; }

        .sp-header { display: flex; align-items: center; justify-content: space-between; padding: 24px 32px; border-bottom: 1px solid var(--border-glass); }
        .sp-title { font-size: 1.2rem; font-weight: 800; color: var(--text-white); display: flex; align-items: center; gap: 10px;}
        .sp-close { font-size: 1.5rem; color: var(--text-muted); cursor: pointer; transition: var(--transition); padding: 8px; border-radius: 50%; background: var(--bg-glass);}
        .sp-close:hover { color: var(--text-white); background: var(--accent-red); transform: rotate(90deg);}

        .sp-content { flex: 1; overflow-y: auto; padding: 24px 32px; }

        .sp-list-item { display: flex; gap: 16px; padding: 16px; border-radius: 16px; background: var(--bg-glass); border: 1px solid var(--border-glass); margin-bottom: 12px; transition: var(--transition); cursor: pointer; position: relative; overflow: hidden;}
        .sp-list-item:hover { background: var(--bg-glass-hover); border-color: var(--border-glass-strong); transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.2);}
        .sp-thumb { width: 64px; height: 90px; border-radius: 10px; overflow: hidden; flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.3);}
        .sp-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .sp-info { flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 6px;}
        .sp-item-title { font-size: 1rem; font-weight: 800; color: var(--text-white); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.3;}
        .sp-item-sub { font-size: 0.85rem; color: var(--accent-cyan); font-weight: 600;}
        .sp-item-time { font-size: 0.75rem; color: var(--text-muted); }
        
        .sp-btn-remove { position: absolute; top: 16px; right: 16px; width: 32px; height: 32px; border-radius: 50%; background: rgba(0,0,0,0.5); color: white; display: flex; align-items: center; justify-content: center; transition: var(--transition); opacity: 0; backdrop-filter: blur(4px);}
        .sp-list-item:hover .sp-btn-remove { opacity: 1; }
        .sp-btn-remove:hover { background: var(--accent-red); transform: scale(1.1);}
        .sp-empty { text-align: center; color: var(--text-muted); padding: 60px 20px; font-size: 1rem; font-weight: 500;}

        .theme-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-top: 16px;}
        .theme-swatch { aspect-ratio: 1; border-radius: 16px; cursor: pointer; transition: var(--transition); border: 2px solid transparent;}
        .theme-swatch.active { border-color: var(--text-white); transform: scale(1.05);}

        /* ==========================================================================
           5. MAIN CONTENT (PLAYER & INFO)
           ========================================================================== */
        .content-wrapper { padding: 0 40px 60px; max-width: 1600px; margin: 0 auto; display: flex; flex-direction: column; gap: 40px;}
        
        /* Grid cho PC: Ép phần chọn tập nằm bên phải nếu màn hình > 1024px */
        .hero-section { display: grid; grid-template-columns: 1fr; gap: 32px; align-items: start; }
        @media (min-width: 1025px) { .hero-section { grid-template-columns: 1fr 320px; gap: 24px;} }
        @media (min-width: 1280px) { .hero-section { grid-template-columns: 1fr 380px; gap: 40px;} }

        /* Player */
        .player-container { position: relative; width: 100%; aspect-ratio: 16 / 9; background: #000; border-radius: 24px; box-shadow: var(--shadow-panel), 0 0 0 1px rgba(255,255,255,0.05); overflow: hidden; }
        [data-theme="light"] .player-container { box-shadow: var(--shadow-panel), 0 0 0 1px rgba(0,0,0,0.1); }
        .player-container iframe { width: 100%; height: 100%; border: none; position: absolute; top: 0; left: 0; }
        .player-glow { position: absolute; top: -10px; left: -10px; right: -10px; bottom: -10px; background: inherit; filter: blur(40px) opacity(0.5); z-index: -1; }
        
        /* Movie Info Below Player */
        .movie-info-panel { display: flex; flex-direction: column; gap: 24px; margin-top: 32px;}
        .movie-title { font-size: 3rem; font-weight: 900; color: var(--text-white); line-height: 1.1; letter-spacing: -1.5px; text-shadow: 0 4px 20px rgba(0,0,0,0.6);}
        [data-theme="light"] .movie-title { text-shadow: none; }
        
        .action-bar { display: flex; flex-wrap: wrap; gap: 16px; align-items: center;}
        .btn-pill { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 14px 28px; background: var(--bg-glass); border: 1px solid var(--border-glass-strong); border-radius: 999px; font-size: 0.95rem; font-weight: 700; transition: var(--transition); color: var(--text-white); backdrop-filter: blur(10px);}
        .btn-pill:hover { background: var(--bg-glass-hover); transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.2);}
        .btn-pill.primary { background: var(--text-white); color: var(--bg-main); border: none; box-shadow: 0 8px 20px rgba(255,255,255,0.2);}
        .btn-pill.primary:hover { background: var(--accent-cyan); color: #fff; box-shadow: var(--shadow-glow-cyan);}
        .btn-pill.saved { border-color: var(--accent-red); color: var(--accent-red); background: rgba(255,59,48,0.1);}
        
        .meta-tags { display: flex; flex-wrap: wrap; gap: 12px; font-size: 0.95rem; font-weight: 600; color: var(--text-white); align-items: center;}
        .tag-rating { color: #000; background: var(--accent-yellow); padding: 4px 12px; border-radius: 8px; font-weight: 900; display: flex; align-items: center; gap: 6px;}
        .tag-box { background: rgba(255,255,255,0.1); padding: 4px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05);}
        
        .movie-desc { font-size: 1.05rem; color: var(--text-muted); line-height: 1.8;}

        /* Right Col (Episodes) */
        .episodes-panel { display: flex; flex-direction: column; height: 100%; max-height: 650px; padding: 24px;}
        .ep-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
        .ep-title { font-size: 1.4rem; font-weight: 900; color: var(--text-white); display: flex; align-items: center; gap: 12px; }
        .ep-title i { color: var(--accent-purple); font-size: 1.8rem;}
        
        .ep-controls { display: flex; gap: 8px; align-items: center;}
        .ep-chunk-select { background: rgba(0,0,0,0.3); border: 1px solid var(--border-glass-strong); color: var(--text-white); border-radius: 12px; padding: 8px 12px; font-size: 0.85rem; font-weight: 700; outline: none; cursor: pointer; transition: var(--transition);}
        .ep-chunk-select:hover { border-color: var(--accent-cyan); }
        .ep-chunk-select option { background: var(--bg-main); color: var(--text-white); }
        .ep-count { font-size: 0.85rem; font-weight: 700; background: var(--bg-glass-hover); padding: 8px 16px; border-radius: 999px; color: var(--text-white); }
        
        .episodes-grid { flex: 1; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); gap: 12px; align-content: start; padding-right: 8px;}
        
        .btn-episode { 
            aspect-ratio: 2/1; border-radius: 14px; font-size: 0.95rem; font-weight: 700;
            background: var(--bg-glass); border: 1px solid var(--border-glass-strong); 
            color: var(--text-muted); transition: var(--transition);
            display: flex; align-items: center; justify-content: center;
        }
        .btn-episode:hover { background: var(--bg-glass-hover); color: var(--text-white); transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.2);}
        .btn-episode.active { 
            background: var(--text-white); color: #000; border-color: transparent; 
            box-shadow: 0 8px 24px rgba(255,255,255,0.3); transform: scale(1.05);
        }

        /* ==========================================================================
           6. KHÁM PHÁ (EXPLORE SECTION)
           ========================================================================== */
        .explore-section { margin-top: 20px;}
        .section-heading { font-size: 2.2rem; font-weight: 900; color: var(--text-white); letter-spacing: -1px; margin-bottom: 32px; display: flex; align-items: center; gap: 16px;}
        .section-heading::before { content: ''; display: block; width: 8px; height: 32px; background: linear-gradient(to bottom, var(--accent-purple), var(--accent-cyan)); border-radius: 8px;}

        .genre-tabs { display: flex; gap: 16px; overflow-x: auto; padding-bottom: 20px; scrollbar-width: none; margin-bottom: 16px;}
        .genre-tabs::-webkit-scrollbar { display: none; }
        .tab-btn { padding: 14px 28px; border-radius: 999px; background: var(--bg-glass); border: 1px solid var(--border-glass-strong); color: var(--text-muted); font-weight: 700; font-size: 1rem; white-space: nowrap; transition: var(--transition); }
        .tab-btn:hover { background: var(--bg-glass-hover); color: var(--text-white); transform: translateY(-2px);}
        .tab-btn.active { background: var(--text-white); color: #000; box-shadow: 0 10px 30px rgba(255,255,255,0.2); border-color: transparent;}
        
        .tab-btn.recommended { position: relative; border-color: rgba(0, 209, 245, 0.4); color: var(--text-light); }
        .tab-btn.recommended::after { content: '★ GỢI Ý'; position: absolute; top: -10px; right: 10px; background: var(--accent-cyan); color: #000; font-size: 0.65rem; padding: 2px 8px; border-radius: 8px; font-weight: 900; box-shadow: 0 4px 10px rgba(0,209,245,0.4);}
        .tab-btn.recommended.active::after { background: #000; color: #fff; box-shadow: none;}

        .anime-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
        @media (min-width: 640px) { .anime-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 1024px) { .anime-grid { grid-template-columns: repeat(4, 1fr); } }
        @media (min-width: 1400px) { .anime-grid { grid-template-columns: repeat(5, 1fr); } }

        .anime-card { background: transparent; border-radius: 20px; overflow: hidden; transition: var(--transition); cursor: pointer; display: flex; flex-direction: column; position: relative;}
        .anime-card:hover { transform: translateY(-10px); }
        .ac-thumb { position: relative; width: 100%; aspect-ratio: 2/3; overflow: hidden; background: #1F2937; border-radius: 20px; box-shadow: 0 12px 30px rgba(0,0,0,0.6);}
        .ac-thumb img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .anime-card:hover .ac-thumb img { transform: scale(1.1); }
        
        .ac-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(5,5,10,0.95) 0%, rgba(5,5,10,0.2) 50%, transparent 100%); opacity: 0.9; transition: opacity 0.4s;}
        .anime-card:hover .ac-overlay { opacity: 1; background: linear-gradient(to top, rgba(5,5,10,1) 0%, rgba(5,5,10,0.5) 60%, transparent 100%);}
        
        .ac-ep { position: absolute; top: 16px; right: 16px; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); color: white; font-size: 0.85rem; font-weight: 800; padding: 6px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); box-shadow: 0 4px 12px rgba(0,0,0,0.3);}
        
        .ac-play-btn { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(0.8); width: 64px; height: 64px; border-radius: 50%; background: var(--accent-cyan); color: #000; display: flex; align-items: center; justify-content: center; font-size: 2rem; opacity: 0; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: var(--shadow-glow-cyan);}
        .anime-card:hover .ac-play-btn { opacity: 1; transform: translate(-50%, -50%) scale(1); }

        .ac-info { position: absolute; bottom: 0; left: 0; width: 100%; padding: 24px 20px; display: flex; flex-direction: column; z-index: 10; transform: translateY(10px); transition: transform 0.4s;}
        .anime-card:hover .ac-info { transform: translateY(0); }
        .ac-title { font-size: 1.15rem; font-weight: 900; color: white; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-shadow: 0 2px 8px rgba(0,0,0,0.8);}
        .ac-year { font-size: 0.9rem; color: var(--accent-cyan); margin-top: 6px; font-weight: 700;}

        .lazy-loader { text-align: center; padding: 60px 0; color: var(--text-muted); font-weight: 700; display: none; font-size: 1.1rem;}
        .lazy-loader i { animation: spin 1s linear infinite; display: inline-block; margin-right: 12px; font-size: 1.8rem; color: var(--accent-cyan); vertical-align: middle;}

        /* ==========================================================================
           7. ONBOARDING MODAL
           ========================================================================== */
        .modal-overlay { position: fixed; inset: 0; background: rgba(5,5,10,0.95); z-index: 3000; backdrop-filter: blur(30px); display: none; align-items: center; justify-content: center; }
        [data-theme="light"] .modal-overlay { background: rgba(244,244,249,0.9); }
        .modal-content.onboarding { background: var(--bg-card); border: 1px solid var(--border-glass-strong); border-radius: 40px; padding: 60px 48px; width: 90%; max-width: 800px; text-align: center; box-shadow: var(--shadow-panel); position: relative; overflow: hidden;}
        .modal-content.onboarding::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(176,38,255,0.1) 0%, transparent 60%); z-index: -1; pointer-events: none; }
        
        .ob-title { font-size: 3rem; font-weight: 900; margin-bottom: 16px; letter-spacing: -1.5px;}
        .ob-desc { color: var(--text-muted); margin-bottom: 48px; font-size: 1.2rem; max-width: 600px; margin-left: auto; margin-right: auto;}
        
        .ob-grid { display: flex; flex-wrap: wrap; gap: 16px; justify-content: center; margin-bottom: 48px; }
        .ob-pill { padding: 16px 32px; border-radius: 20px; border: 1px solid var(--border-glass-strong); background: var(--bg-glass); color: var(--text-light); font-weight: 700; font-size: 1.05rem; cursor: pointer; transition: var(--transition); }
        .ob-pill:hover { background: var(--bg-glass-hover); transform: translateY(-3px);}
        .ob-pill.active { background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan)); color: #fff; border-color: transparent; box-shadow: var(--shadow-glow-cyan); transform: scale(1.05); }

        .btn-primary { background: var(--text-white); color: #000; border: none; padding: 20px 60px; border-radius: 20px; font-size: 1.2rem; font-weight: 900; cursor: pointer; transition: var(--transition); width: auto; min-width: 300px; display: inline-flex; align-items: center; justify-content: center; gap: 12px;}
        .btn-primary:hover { transform: translateY(-4px); box-shadow: 0 15px 40px rgba(255,255,255,0.3); }
        .btn-primary:disabled { background: var(--bg-glass-hover); color: var(--text-muted); cursor: not-allowed; box-shadow: none; transform: none;}

        /* ==========================================================================
           8. MOBILE OPTIMIZATION
           ========================================================================== */
        .mobile-bottom-nav { display: none; }
        .mobile-search-wrapper { display: none; }
        
        /* Tablet & Mobile Layout Shifts */
        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-100%); transition: transform 0.3s; }
            .main-column { margin-left: 0; padding-bottom: 80px;}
            
            /* Show Mobile Nav */
            .mobile-bottom-nav {
                display: flex; position: fixed; bottom: 0; left: 0; width: 100%;
                background: rgba(10,10,18,0.95); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
                border-top: 1px solid var(--border-glass-strong); z-index: 1000;
                padding: 12px 24px calc(12px + env(safe-area-inset-bottom)); justify-content: space-between;
            }
            [data-theme="light"] .mobile-bottom-nav { background: rgba(255,255,255,0.95); }
            
            .mobile-nav-item { display: flex; flex-direction: column; align-items: center; gap: 6px; color: var(--text-muted); font-size: 0.75rem; font-weight: 700; transition: var(--transition); padding: 4px 12px;}
            .mobile-nav-item.active { color: var(--text-white); transform: translateY(-4px);}
            .mobile-nav-item.active i { color: var(--accent-cyan); filter: drop-shadow(0 0 15px rgba(0, 209, 245, 0.6)); }
            .mobile-nav-item i { font-size: 1.6rem; transition: var(--transition); }
            
            .top-header { padding: 0 24px; height: 80px;}
            .content-wrapper { padding: 0 24px 40px; }
            .side-panel { width: 100%; max-width: 400px; }
            
            /* Bỏ max-height của panel chọn tập để trên Tablet hiển thị tự do dưới player */
            .episodes-panel { max-height: none; min-height: 350px; padding: 24px; }
            .episodes-grid { max-height: 400px; }
        }

        /* Pure Mobile Optimizations */
        @media (max-width: 768px) {
            .top-header { 
                height: 70px; padding: 0 20px; 
                background: rgba(5,5,10,0.85); backdrop-filter: blur(20px); 
                border-bottom: 1px solid var(--border-glass);
            }
            [data-theme="light"] .top-header { background: rgba(244,244,249,0.9); }
            
            .mobile-logo { display: block !important; font-size: 1.6rem; font-weight: 900; font-style: italic; cursor: pointer; }
            #desktop-search { display: none; } /* Hide Desktop Search Input */
            .mobile-search-wrapper { display: block; padding: 0 20px; margin-top: -10px; margin-bottom: 24px;}
            .mobile-search-wrapper .search-container { max-width: 100%; }
            .mobile-search-wrapper .search-box { border-radius: 16px; padding: 12px 20px; background: var(--bg-card); border: 1px solid var(--border-glass-strong);}
            .mobile-search-wrapper .search-dropdown { width: 100%; left: 0; top: calc(100% + 8px); }
            
            .content-wrapper { padding: 20px 0 60px; gap: 24px;}
            .hero-section { gap: 20px; padding: 0 20px;}
            
            .player-container { border-radius: 16px; }
            .movie-info-panel { margin-top: 16px; gap: 16px; }
            .movie-title { font-size: 2rem; letter-spacing: -0.5px; }
            .movie-desc { font-size: 1.05rem; line-height: 1.6; }
            
            /* Action Bar Grid for Mobile */
            .action-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%;}
            .btn-pill { padding: 12px 4px; font-size: 0.9rem; width: 100%; border-radius: 12px; gap: 6px;}
            .btn-pill.primary { grid-column: span 3; font-size: 1.1rem; padding: 14px;} /* Play button spans full width */
            
            /* Episodes constrained box */
            .episodes-panel { padding: 20px; min-height: auto; border-radius: 20px;}
            .ep-title { font-size: 1.2rem; }
            .episodes-grid { max-height: 350px; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px; }
            .btn-episode { padding: 10px 4px; font-size: 0.95rem; border-radius: 10px;}
            
            .explore-section { padding: 0 20px; }
            .section-heading { font-size: 1.8rem; margin-bottom: 20px;}
            .anime-grid { grid-template-columns: repeat(2, 1fr); gap: 16px; }
            .ac-title { font-size: 1.05rem; }
            .ac-info { padding: 12px 4px 0; }
            
            /* Onboarding Scale down */
            .modal-content.onboarding { padding: 40px 24px; border-radius: 28px; width: 95%;}
            .ob-title { font-size: 2.2rem; }
            .ob-desc { font-size: 1.1rem; margin-bottom: 32px;}
            .ob-grid { gap: 10px; margin-bottom: 32px;}
            .ob-pill { padding: 12px 20px; font-size: 0.95rem; border-radius: 14px;}
            .btn-primary { padding: 16px 20px; font-size: 1.1rem; min-width: 100%;}
        }

        /* ==========================================================================
           9. T-STORY (GIỮ NGUYÊN CSS)
           ========================================================================== */
        .story-modal { position: fixed; inset: 0; background: #000; z-index: 4000; display: none; flex-direction: column; }
        .story-header { position: absolute; top: 0; left: 0; width: 100%; padding: 24px; display: flex; justify-content: space-between; align-items: center; z-index: 4010; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); }
        .story-logo { font-size: 1.5rem; font-weight: 900; font-style: italic; color: white; text-transform: uppercase;}
        .btn-close-story { color: white; background: rgba(255,255,255,0.1); border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); transition: var(--transition); }
        .btn-close-story:hover { background: rgba(255,255,255,0.2); transform: scale(1.1); }
        .story-container { flex: 1; width: 100%; height: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; scrollbar-width: none; }
        .story-container::-webkit-scrollbar { display: none; }
        .story-item { position: relative; width: 100%; height: 100vh; scroll-snap-align: start; background: #05050A; display: flex; align-items: center; justify-content: center; }
        .story-video-wrapper { position: relative; width: 100%; height: 100%; max-width: 500px; margin: 0 auto; background: #000; }
        @media (max-width: 768px) { .story-video-wrapper { max-width: 100%; } }
        .story-video-wrapper iframe { width: 100%; height: 100%; border: none; object-fit: cover; } 
        .story-overlay { position: absolute; inset: 0; z-index: 4005; pointer-events: none; display: flex; flex-direction: column; justify-content: flex-end; padding: 32px 24px calc(32px + env(safe-area-inset-bottom)); background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.4) 40%, transparent 100%); }
        .story-info { flex: 1; display: flex; flex-direction: column; justify-content: flex-end; pointer-events: auto; padding-right: 70px;}
        .story-title { font-size: 1.75rem; font-weight: 900; color: white; margin-bottom: 12px; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .story-desc { font-size: 0.95rem; color: #D1D5DB; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 24px; line-height: 1.5; }
        .btn-watch-now { align-self: flex-start; background: #FFF; color: #000; padding: 12px 24px; border-radius: 16px; font-weight: 800; display: flex; align-items: center; gap: 8px; transition: var(--transition); font-size: 1rem;}
        .btn-watch-now:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(255,255,255,0.2); }
        .story-actions { position: absolute; right: 16px; bottom: calc(100px + env(safe-area-inset-bottom)); display: flex; flex-direction: column; gap: 28px; pointer-events: auto; align-items: center; }
        .action-icon { display: flex; flex-direction: column; align-items: center; gap: 6px; color: white; background: none; border: none; cursor: pointer; transition: var(--transition); }
        .action-icon i { font-size: 2.2rem; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5)); transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .action-icon:hover i { transform: scale(1.15); }
        .action-icon span { font-size: 0.8rem; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.8);}
        .action-icon.liked i { color: var(--accent-red); animation: heartPop 0.4s ease; }
        .story-hint { position: absolute; bottom: calc(24px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; color: rgba(255,255,255,0.4); font-size: 0.8rem; font-weight: 600; pointer-events: none; animation: bounce 2s infinite; }

    </style>
</head>
<body>

    <!-- AMBIENT BACKGROUND -->
    <div id="app-bg"></div>
    <div id="app-bg-overlay"></div>

    <!-- LOADER -->
    <div id="loader" class="flex-center">
        <div class="spinner"></div>
        <div class="loader-text">ĐANG KHỞI ĐỘNG...</div>
    </div>

    <!-- ONBOARDING MODAL -->
    <div id="onboarding-modal" class="modal-overlay">
        <div class="modal-content onboarding">
            <h2 class="ob-title"><span class="gradient-text">T-ANIME</span> VISION</h2>
            <p class="ob-desc">Chào mừng bạn đến với kỷ nguyên Streaming mới. Hãy chọn những thể loại bạn yêu thích để Trang tối ưu hoá trải nghiệm dành riêng cho bạn!</p>
            <div class="ob-grid" id="ob-genres-grid"></div>
            <button class="btn-primary" id="btn-save-prefs" disabled onclick="savePreferences()">
                Kích Hoạt Trải Nghiệm <i class="ph-bold ph-rocket-launch"></i>
            </button>
        </div>
    </div>

    <!-- APP WRAPPER -->
    <div class="app-wrapper" id="app-wrapper" style="display: none;">
        
        <!-- SIDEBAR (Desktop) -->
        <aside class="sidebar">
            <div class="sidebar-logo gradient-text" onclick="window.scrollTo(0,0)">T-ANIME</div>
            
            <div class="nav-label">Menu Chính</div>
            <div class="nav-menu">
                <a href="#" class="nav-item active" id="nav-home">
                    <i class="ph-fill ph-house"></i> Trang Chủ
                </a>
                <a href="#explore-section" class="nav-item" id="nav-explore">
                    <i class="ph-fill ph-compass"></i> Khám Phá
                </a>
                <button class="nav-item story-btn" onclick="openStoryMode()">
                    <i class="ph-fill ph-play-circle"></i> T-Story
                </button>
            </div>

            <div class="nav-label" style="margin-top: 32px;">Thư Viện</div>
            <div class="nav-menu">
                <button class="nav-item" onclick="openSidePanel('fav')">
                    <i class="ph-fill ph-heart"></i> Phim Yêu Thích
                </button>
                <button class="nav-item" onclick="openSidePanel('history')">
                    <i class="ph-fill ph-clock-counter-clockwise"></i> Lịch Sử Xem
                </button>
                <button class="nav-item" onclick="openSidePanel('download')">
                    <i class="ph-fill ph-download-simple"></i> Đã Tải Xuống
                </button>
            </div>

            <div class="nav-label" style="margin-top: 32px;">Cài Đặt</div>
            <div class="nav-menu" style="margin-bottom: 24px;">
                <button class="nav-item" onclick="toggleTheme()">
                    <i class="ph-fill ph-moon" id="theme-icon"></i> <span id="theme-text">Giao Diện Tối</span>
                </button>
                <button class="nav-item" onclick="openSidePanel('theme')">
                    <i class="ph-fill ph-palette"></i> Màu Sắc Chủ Đạo
                </button>
            </div>

            <!-- Nút User / Mở Panel -->
            <div class="sidebar-footer" onclick="openSidePanel('fav')">
                <div class="sf-avatar"><i class="ph-fill ph-user"></i></div>
                <div class="sf-info">
                    <div class="sf-name">Guest User</div>
                    <div class="sf-sub">Premium Plan</div>
                </div>
                <i class="ph-bold ph-caret-right" style="color: var(--text-muted);"></i>
            </div>
        </aside>

        <!-- MAIN COLUMN -->
        <main class="main-column">
            
            <!-- TOP HEADER -->
            <header class="top-header">
                <!-- Mobile Logo -->
                <div class="mobile-logo gradient-text" onclick="window.scrollTo(0,0)">T-ANIME</div>
                
                <div class="search-container" id="desktop-search">
                    <div class="search-box">
                        <i class="ph-bold ph-magnifying-glass" style="color: var(--text-muted); font-size: 1.2rem;"></i>
                        <input type="text" id="search-input" placeholder="Tìm kiếm hàng ngàn bộ Anime..." autocomplete="off">
                    </div>
                    <div class="search-dropdown" id="search-dropdown"></div>
                </div>

                <div class="header-actions">
                    <button class="header-btn"><i class="ph-bold ph-bell"></i><span class="badge"></span></button>
                </div>
            </header>

            <!-- CONTENT WRAPPER -->
            <div class="content-wrapper">
                
                <!-- Mobile Search (Hiển thị khi màn hình nhỏ, giấu trên PC) -->
                <div class="mobile-search-wrapper">
                    <div class="search-container">
                        <div class="search-box">
                            <i class="ph-bold ph-magnifying-glass" style="color: var(--text-muted); font-size: 1.2rem;"></i>
                            <input type="text" id="m-search-input" placeholder="Tìm kiếm Anime..." autocomplete="off">
                        </div>
                        <div class="search-dropdown" id="m-search-dropdown"></div>
                    </div>
                </div>

                <!-- HERO SECTION: Player & Episodes -->
                <div class="hero-section">
                    <!-- Left: Video Player & Info -->
                    <div style="display: flex; flex-direction: column;">
                        <div class="player-container group">
                            <div class="player-glow"></div>
                            <div id="player-wrapper" style="width: 100%; height: 100%;"></div>
                        </div>
                        
                        <div class="movie-info-panel">
                            <div class="meta-tags" id="movie-meta"></div>
                            <h1 class="movie-title" id="movie-title">Loading...</h1>
                            
                            <!-- Bảng nút Action tự gập thành Grid trên Mobile -->
                            <div class="action-bar">
                                <button class="btn-pill primary" id="btn-play-now" onclick="document.querySelector('.btn-episode').click()">
                                    <i class="ph-fill ph-play-circle" style="font-size: 1.4rem;"></i> Xem Ngay
                                </button>
                                <button class="btn-pill" id="btn-save" onclick="toggleFavoriteFromMain()">
                                    <i class="ph-bold ph-heart"></i> Lưu
                                </button>
                                <button class="btn-pill" id="btn-download" onclick="downloadCurrentEpisode()">
                                    <i class="ph-bold ph-download-simple"></i> Tải Về
                                </button>
                                <button class="btn-pill" onclick="shareStory()">
                                    <i class="ph-bold ph-share-network"></i>
                                </button>
                            </div>

                            <p class="movie-desc" id="movie-desc"></p>
                        </div>
                    </div>

                    <!-- Right: Episodes Panel -->
                    <div class="glass-panel episodes-panel">
                        <div class="ep-header">
                            <div class="ep-title"><i class="ph-fill ph-monitor-play"></i> Chọn Tập</div>
                            <div class="ep-controls">
                                <span class="ep-count" id="ep-count">0</span>
                                <select id="ep-chunk-select" class="ep-chunk-select" style="display: none;" onchange="changeEpChunk(this.value)"></select>
                            </div>
                        </div>
                        <div class="episodes-grid custom-scrollbar" id="episodes-grid"></div>
                    </div>
                </div>

                <!-- EXPLORE SECTION -->
                <section class="explore-section" id="explore-section">
                    <h2 class="section-heading">Khám Phá Anime</h2>
                    <div class="genre-tabs custom-scrollbar" id="genre-tabs-container"></div>
                    <div class="anime-grid" id="explore-grid"></div>
                    <div class="lazy-loader" id="lazy-loader"><i class="ph-bold ph-spinner-gap"></i> Đang tải thêm dữ liệu...</div>
                    <div id="scroll-anchor" style="height: 10px; width: 100%;"></div>
                </section>
                
            </div> <!-- End Content Wrapper -->
        </main>
    </div>

    <!-- RIGHT SIDE-PANEL (Library / Profile) -->
    <div class="side-panel-overlay" id="sp-overlay" onclick="closeSidePanel()"></div>
    <aside class="side-panel" id="side-panel">
        <div class="sp-header">
            <div class="sp-title" id="sp-title"><i class="ph-fill ph-bookmark"></i> Thư Viện</div>
            <div class="sp-close" onclick="closeSidePanel()"><i class="ph-bold ph-x"></i></div>
        </div>
        <div class="sp-content custom-scrollbar" id="sp-content">
            <!-- Dynamic Content Injected via JS -->
        </div>
    </aside>

    <!-- MOBILE BOTTOM NAV -->
    <nav class="mobile-bottom-nav">
        <a href="#" class="mobile-nav-item active" id="m-nav-home">
            <i class="ph-fill ph-house"></i>
            <span>Trang Chủ</span>
        </a>
        <a href="#explore-section" class="mobile-nav-item" id="m-nav-explore">
            <i class="ph-fill ph-compass"></i>
            <span>Khám Phá</span>
        </a>
        <div class="mobile-nav-item story" onclick="openStoryMode()">
            <i class="ph-fill ph-play-circle"></i>
            <span>T-Story</span>
        </div>
        <div class="mobile-nav-item" onclick="openSidePanel('fav')">
            <i class="ph-fill ph-user"></i>
            <span>Cá Nhân</span>
        </div>
    </nav>

    <!-- T-STORY MODAL -->
    <div class="story-modal" id="story-modal">
        <div class="story-header">
            <div class="story-logo">T-STORY</div>
            <button class="btn-close-story" onclick="closeStoryMode()"><i class="ph-bold ph-x"></i></button>
        </div>
        <div class="story-container" id="story-container">
            <div class="story-item flex-center" id="story-loading-init">
                <div class="spinner" style="border-color: rgba(255,255,255,0.2); border-top-color: #fff;"></div>
            </div>
        </div>
    </div>

    <!-- ==========================================================================
         JAVASCRIPT LOGIC
         ========================================================================== -->
    <script>
        // --- XỬ LÝ SCROLL TRẠNG THÁI NAV ---
        window.addEventListener('scroll', () => {
            const exploreSec = document.getElementById('explore-section');
            const dNavHome = document.getElementById('nav-home');
            const dNavExplore = document.getElementById('nav-explore');
            const mNavHome = document.getElementById('m-nav-home');
            const mNavExplore = document.getElementById('m-nav-explore');
            
            if (exploreSec && exploreSec.style.display !== 'none') {
                if (window.scrollY >= exploreSec.offsetTop - 300) {
                    if(dNavHome) dNavHome.classList.remove('active');
                    if(dNavExplore) dNavExplore.classList.add('active');
                    if(mNavHome) mNavHome.classList.remove('active');
                    if(mNavExplore) mNavExplore.classList.add('active');
                } else {
                    if(dNavExplore) dNavExplore.classList.remove('active');
                    if(dNavHome) dNavHome.classList.add('active');
                    if(mNavExplore) mNavExplore.classList.remove('active');
                    if(mNavHome) mNavHome.classList.add('active');
                }
            }
        });

        // Hỗ trợ thanh search trên mobile
        document.addEventListener("DOMContentLoaded", () => {
            if(window.innerWidth <= 640) {
                // Liên kết 2 ô input search desktop và mobile
                const mainInput = document.getElementById('search-input');
                const mobInput = document.getElementById('m-search-input');
                mobInput.addEventListener('input', (e) => {
                    mainInput.value = e.target.value;
                    mainInput.dispatchEvent(new Event('input'));
                });
            }
        });

        // --- DATA DICTIONARY ---
        const ALL_GENRES = [
            { name: 'Hành Động', slug: 'hanh-dong' }, { name: 'Tình Cảm', slug: 'tinh-cam' },
            { name: 'Hài Hước', slug: 'hai-huoc' }, { name: 'Cổ Trang', slug: 'co-trang' },
            { name: 'Tâm Lý', slug: 'tam-ly' }, { name: 'Hình Sự', slug: 'hinh-su' },
            { name: 'Chiến Tranh', slug: 'chien-tranh' }, { name: 'Thể Thao', slug: 'the-thao' },
            { name: 'Võ Thuật', slug: 'vo-thuat' }, { name: 'Viễn Tưởng', slug: 'vien-tuong' },
            { name: 'Phiêu Lưu', slug: 'phieu-luu' }, { name: 'Khoa Học', slug: 'khoa-hoc' },
            { name: 'Kinh Dị', slug: 'kinh-di' }, { name: 'Âm Nhạc', slug: 'am-nhac' },
            { name: 'Thần Thoại', slug: 'than-thoai' }, { name: 'Tài Liệu', slug: 'tai-lieu' },
            { name: 'Gia Đình', slug: 'gia-dinh' }, { name: 'Chính kịch', slug: 'chinh-kich' },
            { name: 'Bí ẩn', slug: 'bi-an' }, { name: 'Học Đường', slug: 'hoc-duong' },
            { name: 'Kinh Điển', slug: 'kinh-dien' }, { name: 'Phim 18+', slug: 'phim-18' },
            { name: 'Short Drama', slug: 'short-drama' }
        ];

        // --- STATE ---
        let selectedPrefs = new Set(); 
        let userPrefsSlugs = []; 
        let favorites = []; 
        let historyList = [];
        let downloadList = [];
        let currentPanelTab = 'fav';
        
        let currentMovieData = null;
        let currentEpisodesList = [];
        let activeEpisode = null;
        let currentEpChunk = 0; 
        const EP_CHUNK_SIZE = 100;
        let exploreState = { currentTabSlug: '', apiPage: 1, localData: [], renderCount: 0, isFetching: false, hasMoreData: true };

        // --- DOM ---
        const ui = {
            appBg: document.getElementById('app-bg'),
            appWrapper: document.getElementById('app-wrapper'),
            loader: document.getElementById('loader'),
            onboardingModal: document.getElementById('onboarding-modal'),
            obGrid: document.getElementById('ob-genres-grid'),
            btnSavePrefs: document.getElementById('btn-save-prefs'),
            
            playerWrapper: document.getElementById('player-wrapper'),
            movieTitle: document.getElementById('movie-title'),
            movieMeta: document.getElementById('movie-meta'),
            movieDesc: document.getElementById('movie-desc'),
            btnSave: document.getElementById('btn-save'),
            
            epGrid: document.getElementById('episodes-grid'),
            epCount: document.getElementById('ep-count'),
            epChunkSelect: document.getElementById('ep-chunk-select'),
            
            genreTabs: document.getElementById('genre-tabs-container'),
            exploreGrid: document.getElementById('explore-grid'),
            lazyLoader: document.getElementById('lazy-loader'),
            scrollAnchor: document.getElementById('scroll-anchor'),

            spOverlay: document.getElementById('sp-overlay'),
            sidePanel: document.getElementById('side-panel'),
            spTitle: document.getElementById('sp-title'),
            spContent: document.getElementById('sp-content'),
            
            themeIcon: document.getElementById('theme-icon'),
            themeText: document.getElementById('theme-text')
        };

        // ==========================================
        // 0. LOGIC THEME (LIGHT/DARK MODE & COLORS)
        // ==========================================
        function initTheme() {
            const theme = localStorage.getItem('tanime_theme') || 'dark';
            if (theme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
                ui.themeIcon.className = 'ph-fill ph-moon';
                ui.themeText.textContent = 'Giao Diện Tối';
            }
            const color = localStorage.getItem('tanime_color') || 'default';
            if (color !== 'default') document.documentElement.setAttribute('data-color', color);
        }

        window.toggleTheme = () => {
            const current = document.documentElement.getAttribute('data-theme');
            if (current === 'light') {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('tanime_theme', 'dark');
                ui.themeIcon.className = 'ph-fill ph-sun';
                ui.themeText.textContent = 'Giao Diện Sáng';
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                localStorage.setItem('tanime_theme', 'light');
                ui.themeIcon.className = 'ph-fill ph-moon';
                ui.themeText.textContent = 'Giao Diện Tối';
            }
        };

        window.changeColorTheme = (themeId) => {
            document.documentElement.setAttribute('data-color', themeId);
            localStorage.setItem('tanime_color', themeId);
            renderSidePanel(); 
        };

        // ==========================================
        // 1. QUẢN LÝ RIGHT SIDE-PANEL (LIBRARY)
        // ==========================================
        function loadUserData() {
            const savedFavs = localStorage.getItem('tanime_favorites');
            if (savedFavs) favorites = JSON.parse(savedFavs);
            const savedHistory = localStorage.getItem('tanime_history');
            if (savedHistory) historyList = JSON.parse(savedHistory);
            const savedDownloads = localStorage.getItem('tanime_downloads');
            if (savedDownloads) downloadList = JSON.parse(savedDownloads);
        }

        window.openSidePanel = (tab) => {
            currentPanelTab = tab;
            const headers = { 
                'fav': '<i class="ph-fill ph-heart" style="color:var(--accent-red)"></i> Phim Yêu Thích', 
                'history': '<i class="ph-fill ph-clock-counter-clockwise" style="color:var(--accent-yellow)"></i> Lịch Sử Xem', 
                'download': '<i class="ph-fill ph-download-simple" style="color:var(--accent-cyan)"></i> Đã Tải Xuống', 
                'theme': '<i class="ph-fill ph-palette" style="color:var(--accent-purple)"></i> Chủ Đề Màu Sắc' 
            };
            ui.spTitle.innerHTML = headers[tab];
            
            ui.spOverlay.classList.add('show');
            ui.sidePanel.classList.add('open');
            renderSidePanel();
        };

        window.closeSidePanel = () => {
            ui.sidePanel.classList.remove('open');
            setTimeout(() => ui.spOverlay.classList.remove('show'), 300);
        };

        function renderSidePanel() {
            if (currentPanelTab === 'theme') {
                const themes = [
                    { id: 'default', color1: '#B026FF', color2: '#00D1F5', name: 'Cyberpunk' },
                    { id: 'emerald', color1: '#10B981', color2: '#14B8A6', name: 'Emerald' },
                    { id: 'blue', color1: '#3B82F6', color2: '#6366F1', name: 'Ocean' },
                    { id: 'rose', color1: '#F43F5E', color2: '#F97316', name: 'Sunset' },
                    { id: 'amber', color1: '#F59E0B', color2: '#EF4444', name: 'Volcano' }
                ];
                const currentTheme = localStorage.getItem('tanime_color') || 'default';
                ui.spContent.innerHTML = `
                    <div class="theme-grid">
                        ${themes.map(t => `
                            <div title="${t.name}" class="theme-swatch ${currentTheme === t.id ? 'active' : ''}" 
                                 style="background: linear-gradient(135deg, ${t.color1}, ${t.color2});"
                                 onclick="changeColorTheme('${t.id}')">
                            </div>
                        `).join('')}
                    </div>
                    <p style="margin-top:24px; color:var(--text-muted); font-size:0.9rem;">Chọn dải màu thể hiện đúng cá tính của bạn.</p>
                `;
                return;
            }

            let data = [];
            let emptyMsg = "";
            let onRemove = "";
            
            if (currentPanelTab === 'fav') { data = favorites; emptyMsg = "Kho phim trống."; onRemove = "removeFromFav"; } 
            else if (currentPanelTab === 'history') { data = historyList; emptyMsg = "Chưa có lịch sử."; onRemove = "removeFromHistory"; } 
            else if (currentPanelTab === 'download') { data = downloadList; emptyMsg = "Chưa có phim tải về."; onRemove = "removeFromDownloads"; }

            if (data.length === 0) {
                ui.spContent.innerHTML = `<div class="sp-empty"><i class="ph-fill ph-ghost" style="font-size:3rem; margin-bottom:16px; opacity:0.5;"></i><br>${emptyMsg}</div>`;
                return;
            }
            
            ui.spContent.innerHTML = data.map((item, index) => `
                <div class="sp-list-item" onclick="loadMovieDetailAndScroll('${item.slug}'); closeSidePanel();">
                    <div class="sp-thumb"><img src="${item.thumb_url.startsWith('http') ? item.thumb_url : 'https://img.ophim.live/uploads/movies/' + item.thumb_url}"></div>
                    <div class="sp-info">
                        <div class="sp-item-title">${item.name}</div>
                        ${item.epName ? `<div class="sp-item-sub">${item.epName}</div>` : ''}
                        ${item.time ? `<div class="sp-item-time">${item.time}</div>` : ''}
                    </div>
                    <button class="sp-btn-remove" onclick="event.stopPropagation(); window.${onRemove}(${index})"><i class="ph-bold ph-trash"></i></button>
                </div>
            `).join('');
        }

        window.removeFromFav = (idx) => { favorites.splice(idx, 1); localStorage.setItem('tanime_favorites', JSON.stringify(favorites)); renderSidePanel(); updateMainPlayerFavUI(); };
        window.removeFromHistory = (idx) => { historyList.splice(idx, 1); localStorage.setItem('tanime_history', JSON.stringify(historyList)); renderSidePanel(); };
        window.removeFromDownloads = (idx) => { downloadList.splice(idx, 1); localStorage.setItem('tanime_downloads', JSON.stringify(downloadList)); renderSidePanel(); };

        function toggleFavorite(movieObj) {
            const index = favorites.findIndex(f => f.slug === movieObj.slug);
            if (index > -1) favorites.splice(index, 1); 
            else favorites.unshift({ slug: movieObj.slug, name: movieObj.name, thumb_url: movieObj.thumb_url });
            localStorage.setItem('tanime_favorites', JSON.stringify(favorites));
            if(currentPanelTab === 'fav') renderSidePanel();
            updateMainPlayerFavUI();
            return index === -1; 
        }

        function addToHistory(movie, episode) {
            if (!movie || !episode) return;
            const now = new Date();
            const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')} - ${now.getDate()}/${now.getMonth()+1}/${now.getFullYear()}`;
            historyList = historyList.filter(h => h.slug !== movie.slug);
            historyList.unshift({ slug: movie.slug, name: movie.name, thumb_url: movie.thumb_url, epName: episode.name, time: timeStr });
            if (historyList.length > 30) historyList.pop(); 
            localStorage.setItem('tanime_history', JSON.stringify(historyList));
            if (currentPanelTab === 'history') renderSidePanel();
        }

        // ==========================================
        // 2. ONBOARDING & INIT
        // ==========================================
        function checkOnboarding() {
            initTheme();
            loadUserData(); 
            const saved = localStorage.getItem('tanime_prefs');
            if (saved) {
                userPrefsSlugs = JSON.parse(saved);
                initApp(); 
            } else {
                ui.obGrid.innerHTML = ALL_GENRES.map(g => `<div class="ob-pill" data-slug="${g.slug}" onclick="togglePref(this)">${g.name}</div>`).join('');
                ui.loader.style.display = 'none';
                ui.onboardingModal.style.display = 'flex';
            }
        }

        window.togglePref = (el) => {
            const slug = el.getAttribute('data-slug');
            if (selectedPrefs.has(slug)) { selectedPrefs.delete(slug); el.classList.remove('active'); } 
            else { selectedPrefs.add(slug); el.classList.add('active'); }
            ui.btnSavePrefs.disabled = selectedPrefs.size === 0;
        };

        window.savePreferences = () => {
            userPrefsSlugs = Array.from(selectedPrefs);
            localStorage.setItem('tanime_prefs', JSON.stringify(userPrefsSlugs));
            ui.onboardingModal.style.display = 'none';
            ui.loader.style.display = 'flex';
            initApp();
        };

        async function initApp() {
            try {
                const res = await fetch('https://ophim1.com/v1/api/danh-sach/hoat-hinh?page=1');
                const data = await res.json();
                if (data.status === 'success' && data.data.items.length > 0) {
                    await loadMovieDetail(data.data.items[0].slug);
                }
                renderGenreTabs();
                switchTab(userPrefsSlugs.length > 0 ? userPrefsSlugs[0] : ALL_GENRES[0].slug);
                
                ui.appWrapper.style.display = 'flex';
            } catch (error) { console.error(error); } 
            finally { ui.loader.style.display = 'none'; }
        }

        // ==========================================
        // 3. MAIN PLAYER LOGIC
        // ==========================================
        async function loadMovieDetail(slug) {
            try {
                const res = await fetch(`https://ophim1.com/phim/${slug}`);
                const data = await res.json();
                if (data.status) {
                    currentEpChunk = 0; 
                    currentMovieData = data.movie;
                    currentEpisodesList = data.episodes[0]?.server_data || [];
                    activeEpisode = currentEpisodesList.length > 0 ? currentEpisodesList[0] : null;

                    const bgUrl = `https://img.ophim.live/uploads/movies/${currentMovieData.poster_url || currentMovieData.thumb_url}`;
                    ui.appBg.style.backgroundImage = `url('${bgUrl}')`;

                    renderPlayer();
                    renderMovieInfo();
                    renderEpisodes();
                }
            } catch (error) { console.error(error); }
        }

        function renderPlayer() {
            if (activeEpisode) {
                ui.playerWrapper.innerHTML = `<iframe src="${activeEpisode.link_embed}" allowfullscreen title="Anime Player"></iframe>`;
            } else {
                ui.playerWrapper.innerHTML = `<div class="flex-center" style="width:100%;height:100%;color:var(--text-muted);"><i class="ph-bold ph-monitor-play" style="font-size:48px;animation:pulse 2s infinite;"></i></div>`;
            }
        }

        function renderMovieInfo() {
            const m = currentMovieData;
            ui.movieTitle.textContent = m.name;
            ui.movieDesc.innerHTML = m.content ? m.content.replace(/<[^>]*>?/gm, '').substring(0, 450) + '...' : 'Đang cập nhật...';
            
            ui.movieMeta.innerHTML = `
                <span class="tag-rating"><i class="ph-fill ph-star"></i> ${m.tmdb?.vote_average || '9.5'}</span>
                <span class="tag-box">${m.quality || 'FHD'}</span>
                <span class="tag-box">${m.lang || 'Vietsub'}</span>
                <span class="tag-box">${m.year}</span>
                <span style="color: var(--text-muted);"><i class="ph-bold ph-clock"></i> ${m.time || '24 Phút/Tập'}</span>
            `;
            updateMainPlayerFavUI();
        }

        function updateMainPlayerFavUI() {
            if(!currentMovieData) return;
            const isLiked = favorites.some(f => f.slug === currentMovieData.slug);
            ui.btnSave.className = `btn-pill ${isLiked ? 'saved' : ''}`;
            ui.btnSave.innerHTML = `<i class="${isLiked ? 'ph-fill' : 'ph-bold'} ph-heart"></i> ${isLiked ? 'Đã Lưu' : 'Lưu'}`;
        }
        window.toggleFavoriteFromMain = () => { if (currentMovieData) toggleFavorite({ slug: currentMovieData.slug, name: currentMovieData.name, thumb_url: currentMovieData.thumb_url }); };

        function renderEpisodes() {
            ui.epCount.textContent = `${currentEpisodesList.length} Tập`;
            const totalChunks = Math.ceil(currentEpisodesList.length / EP_CHUNK_SIZE);
            if (totalChunks > 1) {
                ui.epChunkSelect.style.display = 'block';
                ui.epChunkSelect.innerHTML = Array.from({length: totalChunks}).map((_, i) => {
                    const start = i * EP_CHUNK_SIZE + 1;
                    const end = Math.min((i + 1) * EP_CHUNK_SIZE, currentEpisodesList.length);
                    return `<option value="${i}" ${i === currentEpChunk ? 'selected' : ''}>Tập ${start} - ${end}</option>`;
                }).join('');
            } else ui.epChunkSelect.style.display = 'none';

            const startIdx = currentEpChunk * EP_CHUNK_SIZE;
            const endIdx = startIdx + EP_CHUNK_SIZE;
            const epsToRender = currentEpisodesList.slice(startIdx, endIdx);

            ui.epGrid.innerHTML = epsToRender.map((ep, idx) => {
                const realIdx = startIdx + idx; 
                const isActive = activeEpisode && activeEpisode.slug === ep.slug;
                return `<button class="btn-episode ${isActive ? 'active' : ''}" onclick="selectEpisode(${realIdx})">${isActive ? '<i class="ph-fill ph-play" style="margin-right:4px;"></i> ' : ''}${ep.name}</button>`;
            }).join('');
        }

        window.changeEpChunk = (val) => { currentEpChunk = parseInt(val); renderEpisodes(); };
        window.selectEpisode = (idx) => {
            activeEpisode = currentEpisodesList[idx];
            currentEpChunk = Math.floor(idx / EP_CHUNK_SIZE); 
            renderPlayer(); renderEpisodes(); addToHistory(currentMovieData, activeEpisode);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // --- TẢI VIDEO ---
        window.downloadCurrentEpisode = async () => {
            if (!currentMovieData || !activeEpisode) return;
            const btn = document.getElementById('btn-download');
            if (btn.classList.contains('downloading')) return;
            const m3u8Link = activeEpisode.link_m3u8;
            if (!m3u8Link) { alert("Lỗi tải video!"); return; }

            btn.classList.add('downloading');
            btn.innerHTML = `<i class="ph-bold ph-spinner-gap" style="animation: spin 1s linear infinite;"></i> Đang phân tích...`;
            try {
                const fetchText = async (url) => { const res = await fetch(url); return await res.text(); };
                let manifest = await fetchText(m3u8Link);
                let baseUrl = m3u8Link.substring(0, m3u8Link.lastIndexOf('/') + 1);

                if (manifest.includes('#EXT-X-STREAM-INF')) {
                    const lines = manifest.split('\n'); let bestUrl = '';
                    for (let i = 0; i < lines.length; i++) {
                        if (lines[i].includes('#EXT-X-STREAM-INF')) { let n = lines[i+1].trim(); if(n) bestUrl = n; }
                    }
                    if (bestUrl) {
                        if (!bestUrl.startsWith('http')) bestUrl = baseUrl + bestUrl;
                        manifest = await fetchText(bestUrl); baseUrl = bestUrl.substring(0, bestUrl.lastIndexOf('/') + 1);
                    }
                }

                const tsUrls = [];
                for (let line of manifest.split('\n')) {
                    line = line.trim(); if (line && !line.startsWith('#')) tsUrls.push(line.startsWith('http') ? line : baseUrl + line);
                }
                if (tsUrls.length === 0) throw new Error("No TS");

                const chunks = new Array(tsUrls.length); let dlCount = 0;
                for (let i = 0; i < tsUrls.length; i += 5) {
                    const batch = tsUrls.slice(i, i + 5);
                    const promises = batch.map(async (url, idx) => {
                        const res = await fetch(url); const buffer = await res.arrayBuffer();
                        return { index: i + idx, buffer };
                    });
                    const results = await Promise.all(promises);
                    for (const r of results) chunks[r.index] = r.buffer;
                    dlCount += batch.length;
                    btn.innerHTML = `<i class="ph-bold ph-spinner-gap" style="animation: spin 1s linear infinite;"></i> Đang tải ${Math.floor((dlCount / tsUrls.length) * 100)}%`;
                }

                btn.innerHTML = `<i class="ph-bold ph-spinner-gap" style="animation: spin 1s linear infinite;"></i> Đang ghép file...`;
                const blob = new Blob(chunks, { type: 'video/mp2t' });
                const url = window.URL.createObjectURL(blob);
                
                const a = document.createElement('a'); a.style.display = 'none'; a.href = url;
                a.download = `${currentMovieData.slug}-tap-${activeEpisode.name}.ts`;
                document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); document.body.removeChild(a);
                
                if (!downloadList.some(d => d.slug === currentMovieData.slug && d.epName === activeEpisode.name)) {
                    downloadList.unshift({ slug: currentMovieData.slug, name: currentMovieData.name, thumb_url: currentMovieData.thumb_url, epName: activeEpisode.name, time: `Đã tải hôm nay` });
                    localStorage.setItem('tanime_downloads', JSON.stringify(downloadList));
                    if (currentPanelTab === 'download') renderSidePanel();
                }
                
                btn.classList.remove('downloading'); btn.innerHTML = `<i class="ph-bold ph-check"></i> Hoàn tất`;
                setTimeout(() => { if(btn) btn.innerHTML = `<i class="ph-bold ph-download-simple"></i> Tải Về`; }, 3000);
            } catch (error) {
                if (confirm("Lỗi mạng/CORS. Mở link gốc để tải bằng IDM/Cốc Cốc?")) {
                    const a = document.createElement('a'); a.href = m3u8Link; a.target = '_blank'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
                }
                btn.classList.remove('downloading'); btn.innerHTML = `<i class="ph-bold ph-download-simple"></i> Tải Về`;
            }
        };

        // ==========================================
        // 4. BINDING SEARCH LOGIC
        // ==========================================
        function initSearchLogic(inputId, dropdownId) {
            let searchTimeout;
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            if(!input || !dropdown) return;

            input.addEventListener('input', (e) => {
                const query = e.target.value.trim(); clearTimeout(searchTimeout);
                if (!query) { dropdown.style.display = 'none'; return; }
                dropdown.style.display = 'block';
                dropdown.innerHTML = `<div class="search-msg"><i class="ph-bold ph-spinner-gap" style="animation:spin 1s linear infinite;"></i> Đang dò tìm...</div>`;
                
                searchTimeout = setTimeout(async () => {
                    try {
                        const res = await fetch(`https://ophim1.com/v1/api/tim-kiem?keyword=${encodeURIComponent(query)}`);
                        const data = await res.json();
                        if (data.status === 'success' && data.data.items.length > 0) {
                            dropdown.innerHTML = data.data.items.map(item => `
                                <div class="search-item" onclick="loadMovieDetailAndScroll('${item.slug}'); document.getElementById('${dropdownId}').style.display='none';">
                                    <div class="search-thumb"><img src="https://img.ophim.live/uploads/movies/${item.thumb_url}"></div>
                                    <div class="search-info">
                                        <div class="search-title">${item.name}</div>
                                        <div class="search-origin">${item.origin_name}</div>
                                    </div>
                                </div>
                            `).join('');
                        } else dropdown.innerHTML = `<div class="search-msg">Không tìm thấy Anime.</div>`;
                    } catch (error) {}
                }, 500);
            });

            document.addEventListener('click', (e) => { if (!input.contains(e.target) && !dropdown.contains(e.target)) dropdown.style.display = 'none'; });
        }

        initSearchLogic('search-input', 'search-dropdown'); // Desktop
        initSearchLogic('m-search-input', 'm-search-dropdown'); // Mobile

        // ==========================================
        // 5. LOGIC EXPLORE
        // ==========================================
        function renderGenreTabs() {
            const sortedGenres = [...ALL_GENRES].sort((a, b) => userPrefsSlugs.includes(b.slug) - userPrefsSlugs.includes(a.slug));
            ui.genreTabs.innerHTML = sortedGenres.map(g => `<button class="tab-btn ${userPrefsSlugs.includes(g.slug) ? 'recommended' : ''}" id="tab-${g.slug}" onclick="switchTab('${g.slug}')">${g.name}</button>`).join('');
        }

        window.switchTab = async (slug) => {
            if (exploreState.currentTabSlug === slug) return;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const aTab = document.getElementById(`tab-${slug}`);
            if(aTab) { aTab.classList.add('active'); aTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' }); }

            exploreState = { currentTabSlug: slug, apiPage: 1, localData: [], renderCount: 0, isFetching: false, hasMoreData: true };
            ui.exploreGrid.innerHTML = '';
            await fetchMoreGenreData();
        };

        async function fetchMoreGenreData() {
            if (exploreState.isFetching || !exploreState.hasMoreData) return;
            exploreState.isFetching = true; ui.lazyLoader.style.display = 'block';
            try {
                const res = await fetch(`https://ophim1.com/v1/api/the-loai/${exploreState.currentTabSlug}?page=${exploreState.apiPage}`);
                const data = await res.json();
                if (data.status === 'success' && data.data.items.length > 0) {
                    exploreState.localData.push(...data.data.items); exploreState.apiPage++; append10ItemsToGrid();
                } else exploreState.hasMoreData = false;
            } catch (error) { console.error(error); } 
            finally { exploreState.isFetching = false; ui.lazyLoader.style.display = 'none'; }
        }

        function append10ItemsToGrid() {
            const items = exploreState.localData.slice(exploreState.renderCount, exploreState.renderCount + 10);
            if (items.length === 0) { if(exploreState.hasMoreData) fetchMoreGenreData(); return; }

            const html = items.map(item => `
                <div class="anime-card" onclick="loadMovieDetailAndScroll('${item.slug}')">
                    <div class="ac-thumb">
                        <img src="https://img.ophim.live/uploads/movies/${item.thumb_url}" onerror="this.src='https://via.placeholder.com/200x300/1F2937/00D1F5'">
                        <div class="ac-overlay"></div>
                        <div class="ac-ep">${item.episode_current || 'Tập 1'}</div>
                        <div class="ac-play-btn"><i class="ph-fill ph-play"></i></div>
                    </div>
                    <div class="ac-info">
                        <div class="ac-title">${item.name}</div>
                        <div class="ac-year">${item.year}</div>
                    </div>
                </div>
            `).join('');
            ui.exploreGrid.insertAdjacentHTML('beforeend', html);
            exploreState.renderCount += items.length;
        }

        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting) { exploreState.renderCount >= exploreState.localData.length ? fetchMoreGenreData() : append10ItemsToGrid(); }
        }, { rootMargin: '0px 0px 400px 0px' });
        observer.observe(ui.scrollAnchor);

        // ==========================================
        // 6. T-STORY LOGIC
        // ==========================================
        const storyDOM = { modal: document.getElementById('story-modal'), container: document.getElementById('story-container'), loadingInit: document.getElementById('story-loading-init') };
        let storyCache = []; let isLoadingStory = false; let storyObserver; let videoPlaybackObserver;

        window.openStoryMode = () => { document.body.classList.add('modal-open'); storyDOM.modal.style.display = 'flex'; if (storyCache.length === 0) { initStoryObserver(); loadMoreStories(3); } };
        window.closeStoryMode = () => { document.body.classList.remove('modal-open'); storyDOM.modal.style.display = 'none'; storyDOM.container.querySelectorAll('iframe').forEach(iframe => iframe.src = ''); };

        function initStoryObserver() {
            storyObserver = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting && entry.target.dataset.isLast === 'true') { entry.target.dataset.isLast = 'false'; loadMoreStories(2); } }); }, { threshold: 0.5 });
            videoPlaybackObserver = new IntersectionObserver((entries) => { entries.forEach(entry => { const iframe = entry.target.querySelector('iframe'); if (!iframe) return; if (entry.isIntersecting) { if (!iframe.src || iframe.src.includes('about:blank')) iframe.src = iframe.dataset.src; } else iframe.src = ''; }); }, { threshold: 0.6 }); 
        }

        async function loadMoreStories(count) {
            if (isLoadingStory) return; isLoadingStory = true;
            try {
                const randomPage = Math.floor(Math.random() * 50) + 1;
                const listRes = await fetch(`https://ophim1.com/v1/api/danh-sach/hoat-hinh?page=${randomPage}`);
                const listData = await listRes.json();
                if (listData.status === 'success') {
                    const items = listData.data.items.sort(() => 0.5 - Math.random()).slice(0, count);
                    for (const item of items) {
                        const detailRes = await fetch(`https://ophim1.com/phim/${item.slug}`); const detailData = await detailRes.json();
                        if (detailData.status && detailData.episodes[0]?.server_data.length > 0) {
                            const m = detailData.movie; const eps = detailData.episodes[0].server_data; const randomEp = eps[Math.floor(Math.random() * eps.length)];
                            const storyObj = { slug: m.slug, name: m.name, content: m.content ? m.content.replace(/<[^>]*>?/gm, '').substring(0, 150) + '...' : '', thumb_url: m.thumb_url, poster_url: m.poster_url, link: randomEp.link_embed, isLiked: favorites.some(f => f.slug === m.slug) };
                            storyCache.push(storyObj); appendStoryToDOM(storyObj);
                        }
                    }
                }
            } catch (error) {} finally { isLoadingStory = false; if(storyDOM.loadingInit) storyDOM.loadingInit.style.display = 'none'; }
        }

        function appendStoryToDOM(story) {
            const itemDiv = document.createElement('div'); itemDiv.className = 'story-item';
            const safeObjStr = JSON.stringify({slug: story.slug, name: story.name, thumb_url: story.thumb_url}).replace(/"/g, '&quot;');
            itemDiv.innerHTML = `
                <div class="story-video-wrapper" style="background: url('https://img.ophim.live/uploads/movies/${story.poster_url || story.thumb_url}') center/cover no-repeat;">
                    <iframe data-src="${story.link}" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                    <div class="story-overlay">
                        <div class="story-info">
                            <h3 class="story-title">${story.name}</h3><p class="story-desc">${story.content}</p>
                            <button class="btn-watch-now" onclick="watchFromStory('${story.slug}')"><i class="ph-fill ph-play"></i> Xem Full Bộ</button>
                        </div>
                    </div>
                    <div class="story-actions">
                        <button class="action-icon ${story.isLiked ? 'liked' : ''}" onclick="toggleStoryLike(this, ${safeObjStr})"><i class="${story.isLiked ? 'ph-fill' : 'ph-bold'} ph-heart"></i><span>Thích</span></button>
                        <button class="action-icon" onclick="shareStory()"><i class="ph-fill ph-share-fat"></i><span>Chia sẻ</span></button>
                    </div>
                </div>
                <div class="story-hint"><i class="ph-bold ph-caret-up"></i> Vuốt xem tiếp</div>
            `;
            storyDOM.container.appendChild(itemDiv); itemDiv.dataset.isLast = 'true';
            storyObserver.observe(itemDiv); videoPlaybackObserver.observe(itemDiv); 
        }

        window.toggleStoryLike = (btnElement, movieObj) => { const isAdded = toggleFavorite(movieObj); if (isAdded) { btnElement.classList.add('liked'); btnElement.querySelector('i').className = 'ph-fill ph-heart'; } else { btnElement.classList.remove('liked'); btnElement.querySelector('i').className = 'ph-bold ph-heart'; } };
        window.watchFromStory = (slug) => { closeStoryMode(); loadMovieDetailAndScroll(slug); };
        window.shareStory = () => { alert("Đã copy link phim vào khay nhớ tạm!"); };

        // Init
        window.onload = checkOnboarding;
    </script>
</body>
</html>
