<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>T-ANIME | Premium Streaming</title>
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* ==========================================================================
           1. CSS VARIABLES & THEME
           ========================================================================== */
        :root {
            --bg-main: #0B0E17;
            --bg-sidebar: rgba(18, 22, 36, 0.8);
            --bg-card: rgba(26, 32, 53, 0.6);
            --bg-glass: rgba(255, 255, 255, 0.03);
            --bg-glass-hover: rgba(255, 255, 255, 0.08);
            
            --text-light: #F1F5F9;
            --text-muted: #94A3B8;
            --text-white: #FFFFFF;
            
            --accent-purple: #1E50FF; 
            --accent-cyan: #00D1F5;
            --accent-yellow: #F59E0B;
            --accent-red: #EF4444;

            --border-glass: rgba(255, 255, 255, 0.05);
            --border-glass-strong: rgba(255, 255, 255, 0.1);

            --shadow-glow-purple: 0 0 24px rgba(30, 80, 255, 0.4);
            --shadow-glow-cyan: 0 0 24px rgba(0, 209, 245, 0.4);
            --shadow-panel: 0 24px 48px rgba(0, 0, 0, 0.6);
            
            --font-main: 'Inter', sans-serif;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --sidebar-width: 240px; 
        }

        /* --- LIGHT MODE VARIABLES --- */
        [data-theme="light"] {
            --bg-main: #F4F4F9;
            --bg-sidebar: rgba(255, 255, 255, 0.8);
            --bg-card: rgba(255, 255, 255, 0.6);
            --bg-glass: rgba(0, 0, 0, 0.03);
            --bg-glass-hover: rgba(0, 0, 0, 0.06);
            
            --text-light: #1A1A2E;
            --text-muted: #6B6B80;
            --text-white: #000000;
            
            --accent-purple: #1E50FF;
            --accent-cyan: #0088A8;
            
            --border-glass: rgba(0, 0, 0, 0.06);
            --border-glass-strong: rgba(0, 0, 0, 0.12);
            --shadow-panel: 0 12px 32px rgba(0, 0, 0, 0.08);
        }

        /* --- COLOR THEMES --- */
        [data-color="emerald"] { --accent-purple: #10B981; --accent-cyan: #14B8A6; --shadow-glow-purple: 0 0 24px rgba(16,185,129,0.3); --shadow-glow-cyan: 0 0 24px rgba(20,184,166,0.3); }
        [data-color="rose"] { --accent-purple: #F43F5E; --accent-cyan: #F97316; --shadow-glow-purple: 0 0 24px rgba(244,63,94,0.3); --shadow-glow-cyan: 0 0 24px rgba(249,115,22,0.3); }
        [data-color="amber"] { --accent-purple: #F59E0B; --accent-cyan: #EF4444; --shadow-glow-purple: 0 0 24px rgba(245,158,11,0.3); --shadow-glow-cyan: 0 0 24px rgba(239,68,68,0.3); }
        [data-color="purple"] { --accent-purple: #9333EA; --accent-cyan: #D946EF; --shadow-glow-purple: 0 0 24px rgba(147,51,234,0.3); --shadow-glow-cyan: 0 0 24px rgba(217,70,239,0.3); }

        /* ==========================================================================
           2. BASE & RESET
           ========================================================================== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html, body { overflow-x: hidden; width: 100%; position: relative;}
        html { font-size: 14.5px; }
        @media (max-width: 1024px) { html { font-size: 13.5px; } }
        @media (max-width: 768px) { html { font-size: 13px; } }
        @media (max-width: 480px) { html { font-size: 12.5px; } }

        body { font-family: var(--font-main); background-color: var(--bg-main); color: var(--text-light); line-height: 1.6; scroll-behavior: smooth; transition: background-color 0.5s ease; -webkit-tap-highlight-color: transparent;}
        body.modal-open { overflow: hidden; }
        ::selection { background-color: var(--accent-purple); color: #fff; }
        a { text-decoration: none; color: inherit; }
        button { border: none; background: none; cursor: pointer; font-family: inherit; outline: none; }
        ul { list-style: none; }
        img { max-width: 100%; height: auto; display: block; }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(138, 138, 157, 0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-cyan); }

        /* Ambient Background */
        #app-bg { position: fixed; inset: -50px; z-index: -2; background-size: cover; background-position: center; filter: blur(70px) brightness(0.25); transition: background-image 1.5s ease-in-out; transform: scale(1.1); }
        #app-bg-overlay { position: fixed; inset: 0; z-index: -1; background: linear-gradient(to bottom, rgba(11,14,23,0.7) 0%, rgba(11,14,23,0.98) 100%); transition: background 0.5s ease; }
        [data-theme="light"] #app-bg { filter: blur(70px) brightness(0.85); }
        [data-theme="light"] #app-bg-overlay { background: linear-gradient(to bottom, rgba(244,244,249,0.7) 0%, rgba(244,244,249,0.98) 100%); }

        .gradient-text { background: linear-gradient(to right, var(--accent-purple), var(--accent-cyan)); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        .flex-between { display: flex; align-items: center; justify-content: space-between; }
        
        .glass-panel { background: var(--bg-card); border: 1px solid var(--border-glass); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border-radius: 20px; box-shadow: var(--shadow-panel); }

        /* Loader */
        #loader { position: fixed; inset: 0; background: var(--bg-main); z-index: 9999; flex-direction: column; }
        .spinner { width: 48px; height: 48px; border: 3px solid rgba(0,209,245,0.2); border-top-color: var(--accent-cyan); border-radius: 50%; animation: spin 1s linear infinite; }
        .loader-text { margin-top: 20px; font-size: 0.85rem; font-weight: 700; letter-spacing: 0.2em; color: var(--text-muted); animation: pulse 2s infinite; }
        
        .app-wrapper { display: flex; min-height: 100vh; width: 100%; opacity: 0; transition: opacity 0.5s ease; }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        @keyframes pulseSkeleton { 0% { background-color: rgba(255,255,255,0.05); } 50% { background-color: rgba(255,255,255,0.1); } 100% { background-color: rgba(255,255,255,0.05); } }

        /* ==========================================================================
           3. APP LAYOUT (SIDEBAR + MAIN)
           ========================================================================== */
        
        /* SIDEBAR (Desktop) */
        .sidebar { 
            position: fixed; top: 0; left: 0; width: var(--sidebar-width); height: 100vh; 
            background: var(--bg-sidebar); border-right: 1px solid var(--border-glass);
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            display: flex; flex-direction: column; padding: 28px 20px; z-index: 1000;
        }
        .sidebar-logo { font-size: 1.8rem; font-weight: 900; font-style: italic; letter-spacing: -1px; margin-bottom: 40px; text-align: center; cursor: pointer;}
        
        .nav-menu { display: flex; flex-direction: column; gap: 6px; flex: 1;}
        .nav-label { font-size: 0.7rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin: 12px 0 6px 12px; }
        
        .nav-item { 
            display: flex; align-items: center; gap: 12px; padding: 12px 14px; 
            border-radius: 14px; color: var(--text-muted); font-weight: 600; font-size: 0.95rem;
            transition: var(--transition); cursor: pointer; border: 1px solid transparent;
        }
        .nav-item i { font-size: 1.3rem; transition: transform 0.3s; }
        .nav-item:hover { color: var(--text-white); background: var(--bg-glass); transform: translateX(4px);}
        .nav-item:hover i { transform: scale(1.1); color: var(--accent-cyan);}
        
        .nav-item.active { 
            background: linear-gradient(135deg, rgba(30,80,255,0.1), rgba(0,209,245,0.1)); 
            border-color: rgba(0, 209, 245, 0.2); color: var(--text-white); box-shadow: inset 0 0 20px rgba(0, 209, 245, 0.05);
        }
        .nav-item.active i { color: var(--accent-cyan); }
        .nav-item.story-btn { background: linear-gradient(45deg, var(--accent-purple), var(--accent-cyan)); color: white; border: none; margin-top: 8px; box-shadow: var(--shadow-glow-purple); justify-content: center;}
        .nav-item.story-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(30,80,255,0.4); }

        .sidebar-footer { margin-top: auto; display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-glass); border-radius: 14px; border: 1px solid var(--border-glass-strong); cursor: pointer; transition: var(--transition);}
        .sidebar-footer:hover { background: var(--bg-glass-hover); }
        .sf-avatar { width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan)); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.1rem; overflow: hidden;}
        .sf-info { flex: 1; overflow: hidden; }
        .sf-name { font-size: 0.85rem; font-weight: 700; color: var(--text-white); white-space: nowrap; text-overflow: ellipsis; overflow: hidden;}
        .sf-sub { font-size: 0.7rem; color: var(--text-muted); }

        /* MAIN COLUMN */
        .main-column { margin-left: var(--sidebar-width); flex: 1; display: flex; flex-direction: column; min-height: 100vh; position: relative; width: calc(100% - var(--sidebar-width));}
        
        /* TOP HEADER */
        .top-header { 
            position: fixed; top: 0; right: 0; width: calc(100% - var(--sidebar-width)); height: 72px; 
            display: flex; align-items: center; justify-content: space-between; padding: 0 32px;
            background: linear-gradient(to bottom, var(--bg-main) 0%, transparent 100%);
            z-index: 500; transition: background 0.3s ease, width 0.3s ease;
        }
        .top-header.scrolled { background: rgba(11,14,23,0.9); border-bottom: 1px solid var(--border-glass); backdrop-filter: blur(20px);}
        [data-theme="light"] .top-header.scrolled { background: rgba(244,244,249,0.95); }
        
        .mobile-logo { display: none; }
        
        .search-container { position: relative; width: 100%; max-width: 360px; }
        .search-box { display: flex; align-items: center; gap: 12px; background: var(--bg-glass); border: 1px solid var(--border-glass-strong); border-radius: 999px; padding: 10px 20px; transition: var(--transition); backdrop-filter: blur(10px);}
        .search-box:focus-within { background: var(--bg-card); border-color: var(--accent-cyan); box-shadow: var(--shadow-glow-cyan); }
        .search-box input { background: transparent; border: none; color: var(--text-white); width: 100%; font-family: inherit; outline: none; font-size: 16px !important; }
        .search-box input::placeholder { color: var(--text-muted); font-weight: 500;}
        
        .search-dropdown { position: absolute; top: calc(100% + 8px); left: 0; width: 150%; background: var(--bg-card); border: 1px solid var(--border-glass-strong); border-radius: 16px; box-shadow: var(--shadow-panel); max-height: 60vh; overflow-y: auto; display: none; z-index: 101; backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); padding: 12px; }
        [data-theme="light"] .search-dropdown { background: rgba(255,255,255,0.95); }
        .search-item { display: flex; gap: 14px; padding: 10px; border-radius: 12px; cursor: pointer; transition: var(--transition); }
        .search-item:hover { background: var(--bg-glass-hover); transform: translateX(4px);}
        .search-thumb { width: 48px; height: 68px; border-radius: 8px; background: #1F2937; overflow: hidden; flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.3);}
        .search-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .search-info { display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .search-title { font-size: 0.9rem; font-weight: 800; color: var(--text-white); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .search-origin { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;}
        .search-msg { padding: 32px; text-align: center; font-size: 0.9rem; color: var(--text-muted); font-weight: 500;}

        .header-actions { display: flex; align-items: center; gap: 12px; }
        .header-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--bg-glass); border: 1px solid var(--border-glass); display: flex; align-items: center; justify-content: center; color: var(--text-white); font-size: 1.2rem; transition: var(--transition); position: relative; cursor: pointer;}
        .header-btn:hover { background: var(--bg-glass-hover); color: var(--accent-cyan); transform: translateY(-2px);}
        .header-btn .badge { position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; background: var(--accent-red); border-radius: 50%; box-shadow: 0 0 8px var(--accent-red);}

        /* ==========================================================================
           4. RIGHT SIDE-PANEL
           ========================================================================== */
        .side-panel-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; backdrop-filter: blur(4px); display: none; opacity: 0; transition: opacity 0.3s; }
        .side-panel { 
            position: fixed; top: 0; right: 0; width: 360px; height: 100vh; 
            background: rgba(15,15,22,0.85); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
            border-left: 1px solid var(--border-glass-strong); z-index: 2001; 
            transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column; box-shadow: -20px 0 50px rgba(0,0,0,0.5);
        }
        [data-theme="light"] .side-panel { background: rgba(255,255,255,0.9); }
        .side-panel.open { transform: translateX(0); }
        .side-panel-overlay.show { display: block; opacity: 1; }

        .sp-header { display: flex; align-items: center; justify-content: space-between; padding: 20px 24px; border-bottom: 1px solid var(--border-glass); }
        .sp-title { font-size: 1.1rem; font-weight: 800; color: var(--text-white); display: flex; align-items: center; gap: 8px;}
        .sp-close { font-size: 1.3rem; color: var(--text-muted); cursor: pointer; transition: var(--transition); padding: 6px; border-radius: 50%; background: var(--bg-glass);}
        .sp-close:hover { color: var(--text-white); background: var(--accent-red); transform: rotate(90deg);}

        .sp-content { flex: 1; overflow-y: auto; padding: 20px 24px; }

        .sp-list-item { display: flex; gap: 14px; padding: 12px; border-radius: 14px; background: var(--bg-glass); border: 1px solid var(--border-glass); margin-bottom: 10px; transition: var(--transition); cursor: pointer; position: relative; overflow: hidden;}
        .sp-list-item:hover { background: var(--bg-glass-hover); border-color: var(--border-glass-strong); transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.2);}
        .sp-thumb { width: 54px; height: 76px; border-radius: 8px; overflow: hidden; flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.3);}
        .sp-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .sp-info { flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 4px; overflow: hidden;}
        .sp-item-title { font-size: 0.95rem; font-weight: 800; color: var(--text-white); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.3;}
        .sp-item-sub { font-size: 0.8rem; color: var(--accent-cyan); font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .sp-item-time { font-size: 0.7rem; color: var(--text-muted); }
        
        .sp-btn-remove { position: absolute; top: 12px; right: 12px; width: 28px; height: 28px; border-radius: 50%; background: rgba(0,0,0,0.5); color: white; display: flex; align-items: center; justify-content: center; transition: var(--transition); opacity: 0; backdrop-filter: blur(4px);}
        .sp-list-item:hover .sp-btn-remove { opacity: 1; }
        .sp-btn-remove:hover { background: var(--accent-red); transform: scale(1.1);}
        .sp-empty { text-align: center; color: var(--text-muted); padding: 50px 20px; font-size: 0.95rem; font-weight: 500;}

        .theme-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-top: 12px;}
        .theme-card { display: flex; flex-direction: column; gap: 8px; cursor: pointer; }
        .theme-swatch-box { width: 100%; aspect-ratio: 2/1; border-radius: 12px; display: flex; overflow: hidden; border: 2px solid transparent; transition: var(--transition); box-shadow: 0 4px 10px rgba(0,0,0,0.2);}
        .theme-card:hover .theme-swatch-box { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.4); }
        .theme-card.active .theme-swatch-box { border-color: var(--accent-cyan); transform: scale(1.05); }
        .theme-swatch-box div { flex: 1; height: 100%; }
        .theme-name { font-size: 0.85rem; color: var(--text-muted); font-weight: 600; text-align: center; transition: var(--transition);}
        .theme-card:hover .theme-name, .theme-card.active .theme-name { color: var(--text-white); }

        /* ==========================================================================
           5. MAIN CONTENT (PLAYER & INFO) 
           ========================================================================== */
        .content-wrapper { padding: 90px 32px 40px; max-width: 1500px; margin: 0 auto; display: flex; flex-direction: column; gap: 32px; width: 100%;}
        
        .hero-section { display: flex; flex-direction: column; gap: 24px; align-items: stretch; width: 100%; }
        .hero-left { flex: 1; display: flex; flex-direction: column; min-width: 0; width: 100%; }
        .hero-right { width: 100%; display: flex; flex-direction: column; }

        @media (min-width: 1025px) { 
            .hero-section { flex-direction: row; align-items: flex-start;} 
            .hero-right { flex: 0 0 240px; position: sticky; top: 90px; max-height: calc(100vh - 120px); }
        }
        @media (min-width: 1280px) { 
            .hero-right { flex: 0 0 260px; } 
        }

        /* Player */
        .player-container { position: relative; width: 100%; aspect-ratio: 16 / 9; background: #000; border-radius: 20px; box-shadow: var(--shadow-panel), 0 0 0 1px rgba(255,255,255,0.05); overflow: hidden; }
        [data-theme="light"] .player-container { box-shadow: var(--shadow-panel), 0 0 0 1px rgba(0,0,0,0.1); }
        .player-container iframe { width: 100%; height: 100%; border: none; position: absolute; top: 0; left: 0; z-index: 10; }
        .player-glow { position: absolute; top: -10px; left: -10px; right: -10px; bottom: -10px; background: inherit; filter: blur(40px) opacity(0.5); z-index: -1; }
        
        .skeleton-block { animation: pulseSkeleton 1.5s infinite ease-in-out; border-radius: 10px; }
        
        /* Movie Info Below Player */
        .movie-info-panel { display: flex; flex-direction: column; gap: 20px; margin-top: 24px; min-width: 0; }
        .movie-title { font-size: 2.5rem; font-weight: 900; color: var(--text-white); line-height: 1.2; letter-spacing: -1px; text-shadow: 0 4px 20px rgba(0,0,0,0.6); word-break: break-word;}
        [data-theme="light"] .movie-title { text-shadow: none; }
        
        .action-bar { display: flex; flex-wrap: wrap; gap: 12px; align-items: center;}
        .btn-pill { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 24px; background: var(--bg-glass); border: 1px solid var(--border-glass-strong); border-radius: 999px; font-size: 0.9rem; font-weight: 700; transition: var(--transition); color: var(--text-white); backdrop-filter: blur(10px);}
        .btn-pill:hover { background: var(--bg-glass-hover); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.2);}
        
        .btn-pill.primary { 
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan), var(--accent-purple)); 
            background-size: 200% auto;
            color: #fff !important; 
            border: none; 
            box-shadow: 0 8px 24px rgba(30, 80, 255, 0.35);
            transition: 0.5s;
        }
        .btn-pill.primary:hover { 
            background-position: right center;
            color: #fff; 
            box-shadow: 0 12px 32px rgba(0, 209, 245, 0.5);
            transform: translateY(-3px) scale(1.02);
        }
        
        .btn-pill.saved { border-color: var(--accent-red); color: var(--accent-red); background: rgba(255,59,48,0.1);}
        
        .meta-tags { display: flex; flex-wrap: wrap; gap: 10px; font-size: 0.85rem; font-weight: 600; color: var(--text-white); align-items: center;}
        .tag-rating { color: #000; background: var(--accent-yellow); padding: 4px 10px; border-radius: 8px; font-weight: 900; display: flex; align-items: center; gap: 4px;}
        .tag-box { background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05);}
        
        .movie-desc { font-size: 0.95rem; color: var(--text-muted); line-height: 1.7; word-break: break-word;}

        /* Right Col (Episodes) */
        .episodes-panel { padding: 12px 16px; height: 100%; flex: 1; display: flex; flex-direction: column; overflow: hidden; border-radius: 16px;}
        
        .ep-header { display: flex; flex-direction: column; margin-bottom: 12px; gap: 8px; }
        .ep-title { font-size: 1rem; font-weight: 900; color: var(--text-white); display: flex; align-items: center; gap: 6px; }
        .ep-title i { color: var(--accent-purple); font-size: 1.2rem;}
        
        .ep-controls { display: flex; gap: 6px; align-items: center; width: 100%; justify-content: space-between;}
        .ep-chunk-select { background: rgba(0,0,0,0.3); border: 1px solid var(--border-glass-strong); color: var(--text-white); border-radius: 8px; padding: 4px 6px; font-size: 16px !important; font-weight: 700; outline: none; cursor: pointer; transition: var(--transition); flex: 1;}
        .ep-chunk-select:hover { border-color: var(--accent-cyan); }
        .ep-chunk-select option { background: var(--bg-main); color: var(--text-white); }
        .ep-count { font-size: 0.7rem; font-weight: 700; background: var(--bg-glass-hover); padding: 4px 8px; border-radius: 999px; color: var(--text-white); white-space: nowrap;}
        
        .episodes-grid { flex: 1; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 6px; align-content: start; padding-right: 4px;}
        
        .btn-episode { 
            padding: 6px 2px; border-radius: 8px; font-size: 0.8rem; font-weight: 700;
            background: var(--bg-glass); border: 1px solid var(--border-glass-strong); 
            color: var(--text-muted); transition: var(--transition);
            display: block; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;
        }
        .btn-episode:hover { background: var(--bg-glass-hover); color: var(--text-white); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2);}
        
        .btn-episode.active { 
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan));
            color: #ffffff !important; 
            border-color: transparent; 
            box-shadow: 0 6px 16px rgba(0,0,0,0.2); 
            transform: scale(1.05); z-index: 2;
        }

        /* ==========================================================================
           6. KHÁM PHÁ (EXPLORE SECTION)
           ========================================================================== */
        .explore-section { margin-top: 16px;}
        .section-heading { font-size: 1.8rem; font-weight: 900; color: var(--text-white); letter-spacing: -0.5px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px;}
        .section-heading::before { content: ''; display: block; width: 6px; height: 28px; background: linear-gradient(to bottom, var(--accent-purple), var(--accent-cyan)); border-radius: 6px;}

        .genre-tabs { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 16px; scrollbar-width: none; margin-bottom: 12px;}
        .genre-tabs::-webkit-scrollbar { display: none; }
        
        .tab-btn { padding: 12px 24px; border-radius: 999px; background: var(--bg-glass); border: 1px solid var(--border-glass-strong); color: var(--text-muted); font-weight: 700; font-size: 0.95rem; white-space: nowrap; transition: var(--transition); }
        .tab-btn:hover { background: var(--bg-glass-hover); color: var(--text-white); transform: translateY(-2px);}
        
        .tab-btn.active { background: var(--text-white); color: var(--bg-main) !important; box-shadow: 0 8px 20px rgba(255,255,255,0.2); border-color: transparent;}
        
        .tab-btn.recommended { position: relative; border-color: rgba(0, 209, 245, 0.4); color: var(--text-light); }
        .tab-btn.recommended::after { content: '★ GỢI Ý'; position: absolute; top: -8px; right: 10px; background: var(--accent-cyan); color: #000; font-size: 0.6rem; padding: 2px 6px; border-radius: 6px; font-weight: 900; box-shadow: 0 4px 8px rgba(0,209,245,0.4);}
        .tab-btn.recommended.active::after { background: var(--bg-main); color: var(--text-white); box-shadow: none;}

        .anime-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        @media (min-width: 640px) { .anime-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 1024px) { .anime-grid { grid-template-columns: repeat(4, 1fr); } }
        @media (min-width: 1400px) { .anime-grid { grid-template-columns: repeat(5, 1fr); } }

        .anime-card { background: transparent; border-radius: 16px; overflow: hidden; transition: var(--transition); cursor: pointer; display: flex; flex-direction: column; position: relative;}
        .anime-card:hover { transform: translateY(-8px); }
        .ac-thumb { position: relative; width: 100%; aspect-ratio: 2/3; overflow: hidden; background: #1F2937; border-radius: 16px; box-shadow: 0 10px 24px rgba(0,0,0,0.5);}
        .ac-thumb img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .anime-card:hover .ac-thumb img { transform: scale(1.1); }
        
        .ac-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(5,5,10,0.95) 0%, rgba(5,5,10,0.2) 50%, transparent 100%); opacity: 0.9; transition: opacity 0.4s;}
        .anime-card:hover .ac-overlay { opacity: 1; background: linear-gradient(to top, rgba(5,5,10,1) 0%, rgba(5,5,10,0.5) 60%, transparent 100%);}
        
        .ac-ep { position: absolute; top: 12px; right: 12px; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); color: white; font-size: 0.8rem; font-weight: 800; padding: 4px 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.15); box-shadow: 0 4px 10px rgba(0,0,0,0.3);}
        
        .ac-play-btn { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(0.8); width: 56px; height: 56px; border-radius: 50%; background: var(--accent-cyan); color: #000; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; opacity: 0; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: var(--shadow-glow-cyan);}
        .anime-card:hover .ac-play-btn { opacity: 1; transform: translate(-50%, -50%) scale(1); }

        .ac-info { position: absolute; bottom: 0; left: 0; width: 100%; padding: 20px 16px; display: flex; flex-direction: column; z-index: 10; transform: translateY(8px); transition: transform 0.4s;}
        .anime-card:hover .ac-info { transform: translateY(0); }
        .ac-title { font-size: 1.05rem; font-weight: 900; color: white; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-shadow: 0 2px 6px rgba(0,0,0,0.8);}
        .ac-year { font-size: 0.85rem; color: var(--accent-cyan); margin-top: 4px; font-weight: 700;}

        .lazy-loader { text-align: center; padding: 50px 0; color: var(--text-muted); font-weight: 700; display: none; font-size: 1rem;}
        .lazy-loader i { animation: spin 1s linear infinite; display: inline-block; margin-right: 10px; font-size: 1.6rem; color: var(--accent-cyan); vertical-align: middle;}

        /* ==========================================================================
           7. ONBOARDING & SCAN MODALS
           ========================================================================== */
        .modal-overlay { position: fixed; inset: 0; background: rgba(5, 8, 15, 0.95); z-index: 3000; backdrop-filter: blur(20px); display: none; align-items: center; justify-content: center; }
        [data-theme="light"] .modal-overlay { background: rgba(244,244,249,0.9); }
        
        .modal-content.onboarding { background: var(--bg-card); border: 1px solid var(--border-glass-strong); border-radius: 24px; padding: 40px 32px; width: 90%; max-width: 650px; text-align: center; box-shadow: var(--shadow-panel); position: relative; overflow: hidden;}
        .modal-content.onboarding::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(30,80,255,0.08) 0%, transparent 60%); z-index: -1; pointer-events: none; }
        
        .ob-title { font-size: 2rem; font-weight: 900; margin-bottom: 8px; letter-spacing: -1px;}
        .ob-desc { color: var(--text-muted); margin-bottom: 24px; font-size: 0.95rem; max-width: 500px; margin-left: auto; margin-right: auto;}
        
        .ob-avatar-section { display: flex; flex-direction: column; align-items: center; gap: 16px; margin-bottom: 24px; }
        .ob-avatar-preview { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--accent-cyan); overflow: hidden; box-shadow: var(--shadow-glow-cyan); position: relative; background: var(--bg-main); display: flex; align-items: center; justify-content: center;}
        .ob-avatar-preview img { width: 100%; height: 100%; object-fit: cover; }
        .ob-preset-avatars { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
        .ob-preset-avatars img { width: 44px; height: 44px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: var(--transition); background: var(--bg-glass); padding: 2px;}
        .ob-preset-avatars img:hover { transform: scale(1.1); border-color: var(--accent-purple); }
        
        .ob-divider { display: flex; align-items: center; text-align: center; color: var(--text-muted); font-size: 0.8rem; margin: 16px 0; width: 100%; }
        .ob-divider::before, .ob-divider::after { content: ''; flex: 1; border-bottom: 1px solid var(--border-glass-strong); margin: 0 10px; }

        .ob-profile-setup { display: flex; flex-direction: column; gap: 12px; text-align: left; margin-bottom: 24px;}
        .ob-profile-setup input { width: 100%; border-radius: 12px; padding: 14px 16px; background: var(--bg-glass); border: 1px solid var(--border-glass-strong); color: var(--text-white); outline: none; font-size: 16px !important; transition: var(--transition); font-family: inherit;}
        .ob-profile-setup input:focus { border-color: var(--accent-cyan); background: var(--bg-glass-hover); box-shadow: var(--shadow-glow-cyan); }
        .ob-profile-setup input::placeholder { color: var(--text-muted); }

        .ob-grid { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 30px; max-height: 150px; overflow-y: auto; padding-right: 4px;}
        .ob-pill { padding: 8px 16px; border-radius: 12px; border: 1px solid var(--border-glass-strong); background: var(--bg-glass); color: var(--text-light); font-weight: 700; font-size: 0.85rem; cursor: pointer; transition: var(--transition); }
        .ob-pill:hover { background: var(--bg-glass-hover); transform: translateY(-2px);}
        .ob-pill.active { background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan)); color: #fff; border-color: transparent; box-shadow: var(--shadow-glow-cyan); transform: scale(1.05); }

        .btn-primary { background: var(--text-white); color: var(--bg-main) !important; border: none; padding: 14px 40px; border-radius: 16px; font-size: 1.1rem; font-weight: 900; cursor: pointer; transition: var(--transition); width: auto; min-width: 200px; display: inline-flex; align-items: center; justify-content: center; gap: 8px;}
        .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(255,255,255,0.3); }
        .btn-primary:disabled { background: var(--bg-glass-hover); color: var(--text-muted) !important; cursor: not-allowed; box-shadow: none; transform: none;}

        /* ==========================================================================
           8. MOBILE OPTIMIZATION
           ========================================================================== */
        .mobile-bottom-nav { display: none; }
        .mobile-search-wrapper { display: none; }

        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-100%); transition: transform 0.3s; }
            .main-column { margin-left: 0; padding-bottom: 80px; width: 100%;}
            
            .mobile-bottom-nav {
                display: flex; position: fixed; bottom: 0; left: 0; width: 100%;
                background: rgba(10,10,18,0.95); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
                border-top: 1px solid var(--border-glass-strong); z-index: 1000;
                padding: 10px 20px calc(10px + env(safe-area-inset-bottom)); justify-content: space-between;
            }
            [data-theme="light"] .mobile-bottom-nav { background: rgba(255,255,255,0.95); }
            
            .mobile-nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text-muted); font-size: 0.7rem; font-weight: 700; transition: var(--transition); padding: 4px 8px;}
            .mobile-nav-item.active { color: var(--text-white); transform: translateY(-4px);}
            .mobile-nav-item.active i { color: var(--accent-cyan); filter: drop-shadow(0 0 12px rgba(0, 209, 245, 0.6)); }
            .mobile-nav-item i { font-size: 1.5rem; transition: var(--transition); }
            
            .top-header { padding: 0 20px; height: 72px; width: 100%; right: 0;}
            .content-wrapper { padding: 90px 20px 32px; }
            .side-panel { width: 100%; max-width: 360px; }
            .episodes-panel { position: relative; top: 0; max-height: none; min-height: 350px; }
        }

        @media (max-width: 768px) {
            .top-header { height: 64px; padding: 0 16px; background: rgba(11,14,23,0.85); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border-glass); }
            [data-theme="light"] .top-header { background: rgba(244,244,249,0.9); }
            
            .mobile-logo { display: block !important; font-size: 1.4rem; font-weight: 900; font-style: italic; cursor: pointer; }
            #desktop-search { display: none; }
            
            .mobile-search-wrapper { display: block; padding: 0 16px; margin-top: -8px; margin-bottom: 20px;}
            .mobile-search-wrapper .search-container { max-width: 100%; }
            .mobile-search-wrapper .search-box { border-radius: 14px; padding: 10px 16px; background: var(--bg-card); border: 1px solid var(--border-glass-strong);}
            .mobile-search-wrapper .search-dropdown { width: 100%; left: 0; top: calc(100% + 8px); }
            
            .content-wrapper { padding: 74px 0 60px; gap: 20px;}
            .hero-section { gap: 12px; padding: 0;}
            
            .player-container { border-radius: 0; border: none; box-shadow: none; }
            .player-glow { display: none; }
            
            .movie-info-panel { margin-top: 8px; gap: 12px; padding: 0 16px;}
            .movie-title { font-size: 1.8rem; letter-spacing: -0.5px; }
            .movie-desc { font-size: 0.95rem; line-height: 1.5; }
            
            .action-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; width: 100%;}
            .btn-pill { padding: 12px 4px; font-size: 0.8rem; width: 100%; border-radius: 10px; gap: 4px;}
            .btn-pill.primary { grid-column: span 3; font-size: 1rem; padding: 12px;}
            
            .episodes-panel { padding: 16px; margin: 0 16px; min-height: auto; border-radius: 16px;}
            .ep-title { font-size: 1.1rem; }
            .episodes-grid { max-height: 250px; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 6px; }
            .btn-episode { padding: 8px 4px; font-size: 0.8rem; border-radius: 8px;}
            
            .explore-section { padding: 0 16px; }
            .section-heading { font-size: 1.5rem; margin-bottom: 16px;}
            .anime-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
            .ac-title { font-size: 0.95rem; }
            .ac-info { padding: 10px 4px 0; }
            
            .modal-content.onboarding { padding: 30px 20px; border-radius: 20px; width: 95%;}
            .ob-profile-setup { grid-template-columns: 1fr; gap: 12px; }
            .ob-title { font-size: 1.8rem; }
            .ob-desc { font-size: 0.9rem; margin-bottom: 16px;}
            .btn-primary { padding: 14px 16px; font-size: 1rem; min-width: 100%;}
        }

        /* ==========================================================================
           9. T-STORY REDESIGN (HIỆN ĐẠI, CHIA ĐÔI PC, BOTTOM SHEET MOBILE)
           ========================================================================== */
        .story-modal { position: fixed; inset: 0; background: rgba(5, 8, 15, 0.98); z-index: 4000; display: none; flex-direction: column; height: 100dvh; backdrop-filter: blur(20px);}
        .story-header { position: absolute; top: 0; left: 0; width: 100%; padding: 20px 32px; display: flex; justify-content: space-between; align-items: center; z-index: 4010; }
        .story-logo { font-size: 1.5rem; font-weight: 900; font-style: italic; color: white; text-transform: uppercase;}
        .btn-close-story { color: white; background: rgba(255,255,255,0.1); border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); transition: var(--transition); cursor: pointer; border: none;}
        .btn-close-story:hover { background: var(--accent-red); transform: scale(1.1); }
        
        .story-container { flex: 1; width: 100%; height: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; scrollbar-width: none; }
        .story-container::-webkit-scrollbar { display: none; }
        
        /* Cấu trúc phần tử mỗi video */
        .story-item { position: relative; width: 100%; height: 100dvh; scroll-snap-align: start; display: flex; align-items: center; justify-content: center; overflow: hidden; padding: 80px 24px 24px;}
        
        /* Layout Card cho PC (60-40) */
        .story-layout-container {
            display: flex; gap: 24px; width: 100%; max-width: 1200px; height: 100%; max-height: 800px;
            background: linear-gradient(145deg, rgba(26, 32, 53, 0.6), rgba(11, 14, 23, 0.9)); 
            border-radius: 24px; padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08); backdrop-filter: blur(40px);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        /* Khung Video bên trái sạch sẽ, có vòng xoay chờ tải */
        .story-video-area { flex: 1.8; border-radius: 16px; overflow: hidden; background: #000; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5);}
        .story-video-loader { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 0; }
        .story-video-area iframe { width: 100%; height: 100%; border: none; position: absolute; inset: 0; z-index: 1;}
        
        /* Cột thông tin bên phải */
        .story-content-area { flex: 1; min-width: 320px; display: flex; flex-direction: column; gap: 16px; overflow: hidden; position: relative;}
        .story-overlay-bg { display: none; }
        
        .story-meta { display: flex; flex-direction: column; gap: 12px; flex-shrink: 0;}
        .story-title { font-size: 1.8rem; font-weight: 900; background: linear-gradient(to right, #fff, #94A3B8); -webkit-background-clip: text; color: transparent; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;}
        .story-desc { font-size: 0.95rem; color: #94A3B8; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.6;}
        
        .btn-watch-now { align-self: flex-start; background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan)); color: #FFF !important; padding: 12px 24px; border-radius: 12px; font-weight: 800; display: flex; align-items: center; gap: 8px; transition: var(--transition); font-size: 0.95rem; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(30, 80, 255, 0.3);}
        .btn-watch-now:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 209, 245, 0.5); }

        .story-actions { display: flex; gap: 12px; align-items: center;}
        .action-icon { display: flex; align-items: center; gap: 8px; color: white; background: var(--bg-glass); border: 1px solid var(--border-glass); padding: 10px 16px; border-radius: 12px; cursor: pointer; transition: var(--transition); font-weight: 600; font-size: 0.9rem;}
        .action-icon:hover { background: var(--bg-glass-hover); border-color: var(--accent-cyan); transform: translateY(-2px);}
        .action-icon i { font-size: 1.4rem; color: var(--accent-cyan);}
        .action-icon.liked i { color: var(--accent-red); }
        .action-icon span { text-shadow: none; }
        .action-ep-btn { display: none; } 

        /* Khung danh sách tập nhúng thẳng vào Layout PC */
        .story-episodes-sheet { flex: 1; display: flex; flex-direction: column; background: rgba(0,0,0,0.2); border-radius: 16px; border: 1px solid var(--border-glass); overflow: hidden; padding: 16px;}
        .se-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; color: white; font-weight: 800; font-size: 1.1rem;}
        .se-close-btn { display: none; }

        .story-hint { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); color: rgba(255,255,255,0.4); font-size: 0.85rem; font-weight: 600; pointer-events: none; animation: bounce 2s infinite; }

        /* T-Story Mobile Overrides - Chuyển sang vuốt dọc Fullscreen + Bottom Sheet */
        @media (max-width: 1024px) {
            .story-header { padding: 16px 20px; z-index: 4050;}
            .story-logo { font-size: 1.2rem; }
            .story-item { padding: 0; }
            
            .story-layout-container { display: block; width: 100%; height: 100%; max-height: none; border-radius: 0; padding: 0; border: none; background: transparent; backdrop-filter: none; position: relative; box-shadow: none;}
            .story-video-area { width: 100%; height: 100%; border-radius: 0; border: none; }
            
            /* Thông tin nằm đè lên video */
            .story-content-area { position: absolute; inset: 0; pointer-events: none; display: flex; flex-direction: column; justify-content: flex-end; min-width: auto;}
            .story-overlay-bg { display: block; position: absolute; inset: 0; background: linear-gradient(to top, rgba(5, 8, 15, 1) 0%, rgba(5, 8, 15, 0.5) 50%, transparent 100%); z-index: 1;}
            
            .story-meta { position: relative; z-index: 2; padding: 24px 80px 32px 20px; pointer-events: auto; gap: 8px;}
            .story-title { font-size: 1.4rem; color: #fff;}
            .story-desc { font-size: 0.85rem; -webkit-line-clamp: 3; margin-bottom: 8px;}
            .btn-watch-now { padding: 8px 16px; font-size: 0.85rem; border-radius: 10px;}

            /* Các nút chức năng bay sang phải (TikTok Style) */
            .story-actions { position: absolute; z-index: 2; right: 12px; bottom: 80px; flex-direction: column; gap: 20px; pointer-events: auto;}
            .action-icon { flex-direction: column; padding: 0; background: transparent; border: none; gap: 4px; border-radius: 0;}
            .action-icon:hover { background: transparent; border: none; transform: scale(1.1);}
            .action-icon .icon-bg { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255, 255, 255, 0.1); transition: transform 0.2s;}
            .action-icon i { font-size: 1.8rem; color: white;}
            .action-icon.liked i { color: var(--accent-red); }
            .action-icon span { text-shadow: 0 2px 4px rgba(0,0,0,0.8); font-size: 0.75rem; display: block;}
            .action-ep-btn { display: flex; } 

            /* Bảng chọn tập vuốt từ dưới lên (Bottom Sheet) */
            .story-episodes-sheet { 
                position: absolute; bottom: 0; left: 0; width: 100%; height: 60vh; 
                background: var(--bg-main); z-index: 4100; border-radius: 24px 24px 0 0; 
                border: 1px solid var(--border-glass-strong); padding: 20px;
                transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                pointer-events: auto; box-shadow: 0 -10px 40px rgba(0,0,0,0.8);
            }
            /* Kích hoạt class show-episodes để trượt lên */
            .story-item.show-episodes .story-episodes-sheet { transform: translateY(0); }
            .se-close-btn { display: block; color: var(--text-muted); background: var(--bg-glass); padding: 6px; border-radius: 50%; border: none; cursor: pointer;}
            
            .story-hint { bottom: calc(20px + env(safe-area-inset-bottom)); }
        }

    </style>
</head>
<body>

    <!-- AMBIENT BACKGROUND -->
    <div id="app-bg"></div>
    <div id="app-bg-overlay"></div>

    <!-- LOADER -->
    <div id="loader" class="flex-center">
        <div class="spinner"></div>
        <div class="loader-text">ĐANG KHỞI ĐỘNG...</div>
    </div>

    <!-- ONBOARDING MODAL -->
    <div id="onboarding-modal" class="modal-overlay">
        <div class="modal-content onboarding">
            <h2 class="ob-title"><span class="gradient-text">Diện Mạo Mới</span></h2>
            <p class="ob-desc">Chọn một ảnh đại diện thật chất để thể hiện cá tính và thiết lập hồ sơ của bạn nhé!</p>
            
            <div class="ob-avatar-section">
                <div class="ob-avatar-preview">
                    <img id="ob-preview-img" src="https://api.dicebear.com/7.x/adventurer/svg?seed=Felix" alt="Avatar">
                </div>
                <div class="ob-preset-avatars">
                    <img src="https://api.dicebear.com/7.x/adventurer/svg?seed=Felix" onclick="selectPresetAvatar(this.src)">
                    <img src="https://api.dicebear.com/7.x/adventurer/svg?seed=Aneka" onclick="selectPresetAvatar(this.src)">
                    <img src="https://api.dicebear.com/7.x/adventurer/svg?seed=Mimi" onclick="selectPresetAvatar(this.src)">
                    <img src="https://api.dicebear.com/7.x/adventurer/svg?seed=Nala" onclick="selectPresetAvatar(this.src)">
                    <img src="https://api.dicebear.com/7.x/adventurer/svg?seed=Leo" onclick="selectPresetAvatar(this.src)">
                </div>
            </div>

            <div class="ob-profile-setup">
                <input type="text" id="ob-input-name" placeholder="Nhập tên của bạn (Bắt buộc)..." autocomplete="off">
                <div class="ob-divider">Hoặc dùng link ảnh</div>
                <input type="text" id="ob-input-avatar" placeholder="Dán link ảnh vào đây..." autocomplete="off" oninput="updateAvatarPreview(this.value)">
            </div>

            <div class="ob-grid" id="ob-genres-grid"></div>
            <button class="btn-primary" id="btn-save-prefs" disabled onclick="savePreferences()">
                Hoàn Tất <i class="ph-bold ph-check"></i>
            </button>
        </div>
    </div>

    <!-- SCAN MODAL -->
    <div id="scan-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px; padding: 40px;">
            <h3 class="ob-title" style="font-size: 1.8rem; margin-bottom: 12px;"><i class="ph-fill ph-database"></i> Quét Dữ Liệu</h3>
            
            <div id="scan-init-view">
                <p class="ob-desc" style="font-size: 0.95rem; margin-bottom: 32px;">Hệ thống sẽ quét toàn bộ danh sách phim từ trang 1 đến trang cuối để lấy thông tin. Vui lòng chọn định dạng lưu:</p>
                <div class="ob-grid" style="gap: 16px; margin-bottom: 0;">
                    <button class="btn-primary" style="min-width: unset; width: 100%; padding: 14px;" onclick="startScan('json')"><i class="ph-bold ph-file-code"></i> Tải JSON</button>
                    <button class="btn-pill" style="width: 100%; background: var(--bg-glass); border: 1px solid var(--border-glass-strong); font-size: 1.1rem; padding: 14px;" onclick="startScan('csv')"><i class="ph-bold ph-file-csv"></i> Tải CSV</button>
                    <button class="btn-pill" style="width: 100%; background: transparent; border-color: transparent; font-size: 1rem;" onclick="closeScanModal()">Hủy</button>
                </div>
            </div>

            <div id="scan-progress-view" style="display: none;">
                <p class="ob-desc" style="font-size: 0.9rem; margin-bottom: 16px;">Vui lòng không đóng trình duyệt trong quá trình này.</p>
                <div style="width: 100%; height: 8px; background: var(--bg-glass-hover); border-radius: 4px; overflow: hidden; margin-bottom: 16px;">
                    <div id="scan-progress-fill" style="height: 100%; width: 0%; background: linear-gradient(to right, var(--accent-purple), var(--accent-cyan)); transition: width 0.3s;"></div>
                </div>
                <div id="scan-status" style="color: var(--accent-cyan); font-weight: 700; margin-bottom: 8px; font-size: 0.9rem;">Đang chuẩn bị quét dữ liệu...</div>
                <div id="scan-stats" style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 32px;">Đã quét: 0 phim</div>
                
                <button class="btn-pill" style="width: 100%; color: var(--accent-red); border-color: rgba(255,59,48,0.3); justify-content: center;" onclick="stopScan()">
                    <i class="ph-bold ph-stop-circle"></i> Dừng & Lưu Tạm
                </button>
            </div>
        </div>
    </div>

    <!-- APP WRAPPER -->
    <div class="app-wrapper" id="app-wrapper" style="display: none;">
        
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-logo gradient-text" onclick="window.scrollTo(0,0)">T-ANIME</div>
            
            <div class="nav-label">Menu Chính</div>
            <div class="nav-menu">
                <a href="#" class="nav-item active" id="nav-home">
                    <i class="ph-fill ph-house"></i> Trang Chủ
                </a>
                <a href="#explore-section" class="nav-item" id="nav-explore">
                    <i class="ph-fill ph-compass"></i> Khám Phá
                </a>
                <button class="nav-item story-btn" onclick="openStoryMode()">
                    <i class="ph-fill ph-play-circle"></i> T-Story
                </button>
            </div>

            <div class="nav-label" style="margin-top: 32px;">Thư Viện</div>
            <div class="nav-menu">
                <button class="nav-item" onclick="openSidePanel('fav')">
                    <i class="ph-fill ph-heart"></i> Phim Yêu Thích
                </button>
                <button class="nav-item" onclick="openSidePanel('history')">
                    <i class="ph-fill ph-clock-counter-clockwise"></i> Lịch Sử Xem
                </button>
                <button class="nav-item" onclick="openSidePanel('download')">
                    <i class="ph-fill ph-download-simple"></i> Đã Tải Xuống
                </button>
            </div>

            <div class="nav-label" style="margin-top: 32px;">Cài Đặt</div>
            <div class="nav-menu" style="margin-bottom: 24px;">
                <button class="nav-item" onclick="toggleTheme()">
                    <i class="ph-fill ph-moon" id="theme-icon"></i> <span id="theme-text">Giao Diện Tối</span>
                </button>
                <button class="nav-item" onclick="openSidePanel('theme')">
                    <i class="ph-fill ph-palette"></i> Màu Sắc Chủ Đạo
                </button>
            </div>

            <div class="sidebar-footer" onclick="openSidePanel('fav')">
                <div class="sf-avatar display-user-avatar"><i class="ph-fill ph-user"></i></div>
                <div class="sf-info">
                    <div class="sf-name display-user-name">Guest User</div>
                    <div class="sf-sub">Premium Plan</div>
                </div>
                <i class="ph-bold ph-caret-right" style="color: var(--text-muted);"></i>
            </div>
        </aside>

        <!-- MAIN COLUMN -->
        <main class="main-column">
            
            <!-- TOP HEADER -->
            <header class="top-header">
                <div class="mobile-logo gradient-text" onclick="window.scrollTo(0,0)">T-ANIME</div>
                
                <div class="search-container" id="desktop-search">
                    <div class="search-box">
                        <i class="ph-bold ph-magnifying-glass" style="color: var(--text-muted); font-size: 1.2rem;"></i>
                        <input type="text" id="search-input" placeholder="Tìm kiếm hàng ngàn bộ Anime..." autocomplete="off">
                    </div>
                    <div class="search-dropdown" id="search-dropdown"></div>
                </div>

                <div class="header-actions">
                    <button class="header-btn" onclick="openScanModal()" title="Công Cụ Quét Dữ Liệu">
                        <i class="ph-bold ph-database"></i>
                    </button>
                    <button class="header-btn"><i class="ph-bold ph-bell"></i><span class="badge"></span></button>
                </div>
            </header>

            <!-- CONTENT WRAPPER -->
            <div class="content-wrapper">
                
                <!-- Mobile Search -->
                <div class="mobile-search-wrapper">
                    <div class="search-container">
                        <div class="search-box">
                            <i class="ph-bold ph-magnifying-glass" style="color: var(--text-muted); font-size: 1.2rem;"></i>
                            <input type="text" id="m-search-input" placeholder="Tìm kiếm Anime..." autocomplete="off">
                        </div>
                        <div class="search-dropdown" id="m-search-dropdown"></div>
                    </div>
                </div>

                <!-- HERO SECTION -->
                <div class="hero-section">
                    <!-- Left: Video Player & Info -->
                    <div class="hero-left">
                        <div class="player-container group" id="main-player-container">
                            <div class="player-glow"></div>
                            <div id="player-wrapper" style="width: 100%; height: 100%;"></div>
                        </div>
                        
                        <div class="movie-info-panel">
                            <div class="meta-tags" id="movie-meta">
                                <div class="skeleton-block" style="width: 60%; height: 24px;"></div>
                            </div>
                            <h1 class="movie-title" id="movie-title">
                                <div class="skeleton-block" style="width: 80%; height: 40px; margin-bottom: 8px;"></div>
                                <div class="skeleton-block" style="width: 50%; height: 40px;"></div>
                            </h1>
                            
                            <div class="action-bar">
                                <button class="btn-pill primary" id="btn-play-now" onclick="document.querySelector('.btn-episode').click()">
                                    <i class="ph-fill ph-play-circle" style="font-size: 1.4rem;"></i> Xem Ngay
                                </button>
                                <button class="btn-pill" id="btn-save" onclick="toggleFavoriteFromMain()">
                                    <i class="ph-bold ph-heart"></i> <span class="action-text">Lưu</span>
                                </button>
                                <button class="btn-pill" id="btn-download" onclick="downloadCurrentEpisode()">
                                    <i class="ph-bold ph-download-simple"></i> <span class="action-text">Tải Về</span>
                                </button>
                                <button class="btn-pill" onclick="shareStory()">
                                    <i class="ph-bold ph-share-network"></i>
                                </button>
                            </div>

                            <div class="movie-desc" id="movie-desc">
                                <div class="skeleton-block" style="width: 100%; height: 16px; margin-bottom: 8px;"></div>
                                <div class="skeleton-block" style="width: 90%; height: 16px; margin-bottom: 8px;"></div>
                                <div class="skeleton-block" style="width: 70%; height: 16px;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Episodes Panel -->
                    <div class="glass-panel episodes-panel hero-right">
                        <div class="ep-header">
                            <div class="ep-title"><i class="ph-fill ph-monitor-play"></i> Chọn Tập</div>
                            <div class="ep-controls">
                                <span class="ep-count" id="ep-count">0</span>
                                <select id="ep-chunk-select" class="ep-chunk-select" style="display: none;" onchange="changeEpChunk(this.value)"></select>
                            </div>
                        </div>
                        <div class="episodes-grid custom-scrollbar" id="episodes-grid"></div>
                    </div>
                </div>

                <!-- EXPLORE SECTION -->
                <section class="explore-section" id="explore-section">
                    <h2 class="section-heading">Khám Phá Anime</h2>
                    <div class="genre-tabs custom-scrollbar" id="genre-tabs-container"></div>
                    <div class="anime-grid" id="explore-grid"></div>
                    <div class="lazy-loader" id="lazy-loader"><i class="ph-bold ph-spinner-gap"></i> Đang tải thêm dữ liệu...</div>
                    <div id="scroll-anchor" style="height: 10px; width: 100%;"></div>
                </section>
                
            </div>
        </main>

        <!-- MOBILE BOTTOM NAV -->
        <nav class="mobile-bottom-nav">
            <a href="#" class="mobile-nav-item active" id="m-nav-home">
                <i class="ph-fill ph-house"></i>
                <span>Trang Chủ</span>
            </a>
            <a href="#explore-section" class="mobile-nav-item" id="m-nav-explore">
                <i class="ph-fill ph-compass"></i>
                <span>Khám Phá</span>
            </a>
            <div class="mobile-nav-item story" onclick="openStoryMode()">
                <i class="ph-fill ph-play-circle"></i>
                <span>T-Story</span>
            </div>
            <div class="mobile-nav-item" onclick="openSidePanel('fav')">
                <div class="display-user-avatar" style="width: 24px; height: 24px; border-radius: 50%; overflow: hidden; display: flex; align-items: center; justify-content: center; background: linear-gradient(45deg, var(--accent-purple), var(--accent-cyan));">
                    <i class="ph-fill ph-user" style="color: white; font-size: 1.2rem;"></i>
                </div>
                <span>Cá Nhân</span>
            </div>
        </nav>
    </div>

    <!-- RIGHT SIDE-PANEL (Library / Profile) -->
    <div class="side-panel-overlay" id="sp-overlay" onclick="closeSidePanel()"></div>
    <aside class="side-panel" id="side-panel">
        <div class="sp-header">
            <div class="sp-title" id="sp-title"><i class="ph-fill ph-bookmark"></i> Thư Viện</div>
            <div class="sp-close" onclick="closeSidePanel()"><i class="ph-bold ph-x"></i></div>
        </div>
        
        <!-- Hiển thị Avatar To ở Sidebar -->
        <div style="display: flex; align-items: center; gap: 16px; padding: 24px; border-bottom: 1px solid var(--border-glass);">
            <div class="display-user-avatar" style="width: 56px; height: 56px; border-radius: 16px; overflow: hidden; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan)); flex-shrink: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                <i class="ph-fill ph-user" style="color: white; font-size: 2rem;"></i>
            </div>
            <div>
                <div class="display-user-name" style="font-weight: 900; font-size: 1.1rem; color: var(--text-white);">Guest User</div>
                <div style="font-size: 0.8rem; color: var(--accent-cyan); font-weight: 700;">Thành Viên Premium</div>
            </div>
        </div>

        <div class="sp-content custom-scrollbar" id="sp-content"></div>
    </aside>

    <!-- T-STORY MODAL -->
    <div class="story-modal" id="story-modal">
        <div class="story-header">
            <div class="story-logo">T-STORY</div>
            <button class="btn-close-story" onclick="closeStoryMode()"><i class="ph-bold ph-x"></i></button>
        </div>
        <div class="story-container" id="story-container">
            <div class="story-item flex-center" id="story-loading-init">
                <div class="spinner" style="border-color: rgba(255,255,255,0.2); border-top-color: var(--accent-cyan);"></div>
            </div>
        </div>
    </div>

    <!-- ==========================================================================
         JAVASCRIPT LOGIC
         ========================================================================== -->
    <script>
        // --- XỬ LÝ SCROLL TRẠNG THÁI NAV ---
        window.addEventListener('scroll', () => {
            const topHeader = document.querySelector('.top-header');
            if (window.scrollY > 50) topHeader.classList.add('scrolled');
            else topHeader.classList.remove('scrolled');

            const exploreSec = document.getElementById('explore-section');
            const dNavHome = document.getElementById('nav-home');
            const dNavExplore = document.getElementById('nav-explore');
            const mNavHome = document.getElementById('m-nav-home');
            const mNavExplore = document.getElementById('m-nav-explore');
            
            if (exploreSec && exploreSec.style.display !== 'none') {
                if (window.scrollY >= exploreSec.offsetTop - 300) {
                    if(dNavHome) dNavHome.classList.remove('active');
                    if(dNavExplore) dNavExplore.classList.add('active');
                    if(mNavHome) mNavHome.classList.remove('active');
                    if(mNavExplore) mNavExplore.classList.add('active');
                } else {
                    if(dNavExplore) dNavExplore.classList.remove('active');
                    if(dNavHome) dNavHome.classList.add('active');
                    if(mNavExplore) mNavExplore.classList.remove('active');
                    if(mNavHome) mNavHome.classList.add('active');
                }
            }
        });

        document.addEventListener("DOMContentLoaded", () => {
            if(window.innerWidth <= 768) {
                const mainInput = document.getElementById('search-input');
                const mobInput = document.getElementById('m-search-input');
                if (mainInput && mobInput) {
                    mobInput.addEventListener('input', (e) => { mainInput.value = e.target.value; });
                    mainInput.addEventListener('input', (e) => { mobInput.value = e.target.value; });
                }
            }
        });

        // --- DATA DICTIONARY ---
        const ALL_GENRES = [
            { name: 'Hành Động', slug: 'hanh-dong' }, { name: 'Tình Cảm', slug: 'tinh-cam' },
            { name: 'Hài Hước', slug: 'hai-huoc' }, { name: 'Cổ Trang', slug: 'co-trang' },
            { name: 'Tâm Lý', slug: 'tam-ly' }, { name: 'Hình Sự', slug: 'hinh-su' },
            { name: 'Chiến Tranh', slug: 'chien-tranh' }, { name: 'Thể Thao', slug: 'the-thao' },
            { name: 'Võ Thuật', slug: 'vo-thuat' }, { name: 'Viễn Tưởng', slug: 'vien-tuong' },
            { name: 'Phiêu Lưu', slug: 'phieu-luu' }, { name: 'Khoa Học', slug: 'khoa-hoc' },
            { name: 'Kinh Dị', slug: 'kinh-di' }, { name: 'Âm Nhạc', slug: 'am-nhac' },
            { name: 'Thần Thoại', slug: 'than-thoai' }, { name: 'Tài Liệu', slug: 'tai-lieu' },
            { name: 'Gia Đình', slug: 'gia-dinh' }, { name: 'Chính kịch', slug: 'chinh-kich' },
            { name: 'Bí ẩn', slug: 'bi-an' }, { name: 'Học Đường', slug: 'hoc-duong' },
            { name: 'Kinh Điển', slug: 'kinh-dien' }, { name: 'Phim 18+', slug: 'phim-18' },
            { name: 'Short Drama', slug: 'short-drama' }
        ];

        // --- STATE ---
        let selectedPrefs = new Set(); 
        let userPrefsSlugs = []; 
        let favorites = []; 
        let historyList = [];
        let downloadList = [];
        let currentPanelTab = 'fav';
        
        let currentMovieData = null;
        let currentEpisodesList = [];
        let activeEpisode = null;
        let currentEpChunk = 0; 
        const EP_CHUNK_SIZE = 100;
        let exploreState = { currentTabSlug: '', apiPage: 1, localData: [], renderCount: 0, isFetching: false, hasMoreData: true };

        // --- DOM ---
        const ui = {
            appBg: document.getElementById('app-bg'),
            appWrapper: document.getElementById('app-wrapper'),
            loader: document.getElementById('loader'),
            onboardingModal: document.getElementById('onboarding-modal'),
            obGrid: document.getElementById('ob-genres-grid'),
            btnSavePrefs: document.getElementById('btn-save-prefs'),
            obInputName: document.getElementById('ob-input-name'),
            obInputAvatar: document.getElementById('ob-input-avatar'),
            
            playerWrapper: document.getElementById('player-wrapper'),
            movieTitle: document.getElementById('movie-title'),
            movieMeta: document.getElementById('movie-meta'),
            movieDesc: document.getElementById('movie-desc'),
            
            epGrid: document.getElementById('episodes-grid'),
            epCount: document.getElementById('ep-count'),
            epChunkSelect: document.getElementById('ep-chunk-select'),
            
            genreTabs: document.getElementById('genre-tabs-container'),
            exploreGrid: document.getElementById('explore-grid'),
            lazyLoader: document.getElementById('lazy-loader'),
            scrollAnchor: document.getElementById('scroll-anchor'),

            spOverlay: document.getElementById('sp-overlay'),
            sidePanel: document.getElementById('side-panel'),
            spTitle: document.getElementById('sp-title'),
            spContent: document.getElementById('sp-content'),
            
            themeIcon: document.getElementById('theme-icon'),
            themeText: document.getElementById('theme-text')
        };

        // ==========================================
        // 0. LOGIC THEME
        // ==========================================
        function initTheme() {
            const theme = localStorage.getItem('tanime_theme') || 'dark';
            if (theme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
                ui.themeIcon.className = 'ph-fill ph-moon';
                ui.themeText.textContent = 'Giao Diện Tối';
            }
            const color = localStorage.getItem('tanime_color') || 'default';
            if (color !== 'default') document.documentElement.setAttribute('data-color', color);
        }

        window.toggleTheme = () => {
            const current = document.documentElement.getAttribute('data-theme');
            if (current === 'light') {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('tanime_theme', 'dark');
                ui.themeIcon.className = 'ph-fill ph-sun';
                ui.themeText.textContent = 'Giao Diện Sáng';
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                localStorage.setItem('tanime_theme', 'light');
                ui.themeIcon.className = 'ph-fill ph-moon';
                ui.themeText.textContent = 'Giao Diện Tối';
            }
        };

        window.changeColorTheme = (themeId) => {
            document.documentElement.setAttribute('data-color', themeId);
            localStorage.setItem('tanime_color', themeId);
            renderSidePanel(); 
        };

        // ==========================================
        // 1. QUẢN LÝ RIGHT SIDE-PANEL (LIBRARY)
        // ==========================================
        function loadUserData() {
            const savedFavs = localStorage.getItem('tanime_favorites');
            if (savedFavs) favorites = JSON.parse(savedFavs);
            const savedHistory = localStorage.getItem('tanime_history');
            if (savedHistory) historyList = JSON.parse(savedHistory);
            const savedDownloads = localStorage.getItem('tanime_downloads');
            if (savedDownloads) downloadList = JSON.parse(savedDownloads);
        }

        window.openSidePanel = (tab) => {
            currentPanelTab = tab;
            const headers = { 
                'fav': '<i class="ph-fill ph-heart" style="color:var(--accent-red)"></i> Phim Yêu Thích', 
                'history': '<i class="ph-fill ph-clock-counter-clockwise" style="color:var(--accent-yellow)"></i> Lịch Sử Xem', 
                'download': '<i class="ph-fill ph-download-simple" style="color:var(--accent-cyan)"></i> Đã Tải Xuống', 
                'theme': '<i class="ph-fill ph-palette" style="color:var(--accent-purple)"></i> Chủ Đề Màu Sắc' 
            };
            ui.spTitle.innerHTML = headers[tab];
            
            ui.spOverlay.classList.add('show');
            ui.sidePanel.classList.add('open');
            renderSidePanel();
        };

        window.closeSidePanel = () => {
            ui.sidePanel.classList.remove('open');
            setTimeout(() => ui.spOverlay.classList.remove('show'), 300);
        };

        function renderSidePanel() {
            if (currentPanelTab === 'theme') {
                const themes = [
                    { id: 'default', color1: '#1E50FF', color2: '#00D1F5', name: 'Deep Space' },
                    { id: 'emerald', color1: '#10B981', color2: '#14B8A6', name: 'Emerald' },
                    { id: 'blue', color1: '#3B82F6', color2: '#6366F1', name: 'Oceanic' },
                    { id: 'rose', color1: '#F43F5E', color2: '#F97316', name: 'Sunset' },
                    { id: 'purple', color1: '#9333EA', color2: '#D946EF', name: 'Cyber Glow' }
                ];
                const currentTheme = localStorage.getItem('tanime_color') || 'default';
                
                ui.spContent.innerHTML = `
                    <div class="theme-grid">
                        ${themes.map(t => `
                            <div class="theme-card ${currentTheme === t.id ? 'active' : ''}" onclick="changeColorTheme('${t.id}')">
                                <div class="theme-swatch-box" style="background: linear-gradient(135deg, ${t.color1} 0%, ${t.color2} 100%);"></div>
                                <div class="theme-name">${t.name}</div>
                            </div>
                        `).join('')}
                    </div>
                    <p style="margin-top:24px; color:var(--text-muted); font-size:0.9rem;">Chọn dải màu thể hiện đúng cá tính của bạn.</p>
                `;
                return;
            }

            let data = [];
            let emptyMsg = "";
            let onRemove = "";
            
            if (currentPanelTab === 'fav') { data = favorites; emptyMsg = "Kho phim trống."; onRemove = "removeFromFav"; } 
            else if (currentPanelTab === 'history') { data = historyList; emptyMsg = "Chưa có lịch sử."; onRemove = "removeFromHistory"; } 
            else if (currentPanelTab === 'download') { data = downloadList; emptyMsg = "Chưa có phim tải về."; onRemove = "removeFromDownloads"; }

            if (data.length === 0) {
                ui.spContent.innerHTML = `<div class="sp-empty"><i class="ph-fill ph-ghost" style="font-size:3rem; margin-bottom:16px; opacity:0.5;"></i><br>${emptyMsg}</div>`;
                return;
            }
            
            ui.spContent.innerHTML = data.map((item, index) => `
                <div class="sp-list-item" onclick="loadMovieDetailAndScroll('${item.slug}'); closeSidePanel();">
                    <div class="sp-thumb"><img src="${item.thumb_url.startsWith('http') ? item.thumb_url : 'https://img.ophim.live/uploads/movies/' + item.thumb_url}" onerror="this.src='https://via.placeholder.com/64x90/1F2937/00D1F5'"></div>
                    <div class="sp-info">
                        <div class="sp-item-title">${item.name}</div>
                        ${item.epName ? `<div class="sp-item-sub">${item.epName}</div>` : ''}
                        ${item.time ? `<div class="sp-item-time">${item.time}</div>` : ''}
                    </div>
                    <button class="sp-btn-remove" onclick="event.stopPropagation(); window.${onRemove}(${index})"><i class="ph-bold ph-trash"></i></button>
                </div>
            `).join('');
        }

        window.removeFromFav = (idx) => { favorites.splice(idx, 1); localStorage.setItem('tanime_favorites', JSON.stringify(favorites)); renderSidePanel(); updateMainPlayerFavUI(); };
        window.removeFromHistory = (idx) => { historyList.splice(idx, 1); localStorage.setItem('tanime_history', JSON.stringify(historyList)); renderSidePanel(); };
        window.removeFromDownloads = (idx) => { downloadList.splice(idx, 1); localStorage.setItem('tanime_downloads', JSON.stringify(downloadList)); renderSidePanel(); };

        function toggleFavorite(movieObj) {
            const index = favorites.findIndex(f => f.slug === movieObj.slug);
            if (index > -1) favorites.splice(index, 1); 
            else favorites.unshift({ slug: movieObj.slug, name: movieObj.name, thumb_url: movieObj.thumb_url });
            localStorage.setItem('tanime_favorites', JSON.stringify(favorites));
            if(currentPanelTab === 'fav') renderSidePanel();
            updateMainPlayerFavUI();
            return index === -1; 
        }

        function addToHistory(movie, episode) {
            if (!movie || !episode) return;
            const now = new Date();
            const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')} - ${now.getDate()}/${now.getMonth()+1}/${now.getFullYear()}`;
            historyList = historyList.filter(h => h.slug !== movie.slug);
            historyList.unshift({ slug: movie.slug, name: movie.name, thumb_url: movie.thumb_url, epName: episode.name, time: timeStr });
            if (historyList.length > 30) historyList.pop(); 
            localStorage.setItem('tanime_history', JSON.stringify(historyList));
            if (currentPanelTab === 'history') renderSidePanel();
        }

        // ==========================================
        // 1.5 CRAWL DATA SCRIPT (TOOL QUÉT PHIM)
        // ==========================================
        let isScanning = false;
        let scanFormat = 'json';
        let scannedData = [];
        
        const scanUI = {
            modal: document.getElementById('scan-modal'),
            initView: document.getElementById('scan-init-view'),
            progressView: document.getElementById('scan-progress-view'),
            progressFill: document.getElementById('scan-progress-fill'),
            status: document.getElementById('scan-status'),
            stats: document.getElementById('scan-stats')
        };

        window.openScanModal = () => {
            scanUI.modal.style.display = 'flex';
            scanUI.initView.style.display = 'block';
            scanUI.progressView.style.display = 'none';
        };

        window.closeScanModal = () => {
            if (isScanning && !confirm("Bạn có chắc muốn đóng? Quá trình quét sẽ bị dừng lại!")) return;
            isScanning = false;
            scanUI.modal.style.display = 'none';
        };

        window.startScan = async (format) => {
            scanFormat = format;
            isScanning = true;
            scannedData = [];
            
            scanUI.initView.style.display = 'none';
            scanUI.progressView.style.display = 'block';
            scanUI.progressFill.style.width = '0%';
            scanUI.stats.textContent = 'Đã quét: 0 phim';

            try {
                scanUI.status.textContent = "Đang phân tích cấu trúc dữ liệu...";
                const initialRes = await fetch('https://ophim1.com/v1/api/danh-sach/hoat-hinh?page=1');
                const initialData = await initialRes.json();
                
                const totalPages = initialData.data?.params?.pagination?.totalPages || 1442;
                
                for (let page = 1; page <= totalPages; page++) {
                    if (!isScanning) break;
                    
                    scanUI.status.textContent = `Đang lấy danh sách phim trang ${page} / ${totalPages}...`;
                    const pageRes = await fetch(`https://ophim1.com/v1/api/danh-sach/hoat-hinh?page=${page}`);
                    const pageData = await pageRes.json();
                    const items = pageData.data.items;

                    const batchSize = 5;
                    for (let i = 0; i < items.length; i += batchSize) {
                        if (!isScanning) break;
                        const batch = items.slice(i, i + batchSize);
                        scanUI.status.textContent = `Đang quét chi tiết phim trang ${page}... (${i+1} đến ${i + batch.length} / ${items.length})`;
                        
                        await Promise.all(batch.map(async (item) => {
                            try {
                                const detailRes = await fetch(`https://ophim1.com/phim/${item.slug}`);
                                const detailData = await detailRes.json();
                                if (detailData.status && detailData.movie) {
                                    const m = detailData.movie;
                                    
                                    // TRÍCH XUẤT TẤT CẢ LINK M3U8 CỦA PHIM
                                    let m3u8_links = "";
                                    if (detailData.episodes && detailData.episodes.length > 0 && detailData.episodes[0].server_data) {
                                        m3u8_links = detailData.episodes[0].server_data
                                            .map(ep => ep.link_m3u8)
                                            .filter(link => link) // Lọc bỏ các link rỗng
                                            .join(', '); // Nối các link bằng dấu phẩy
                                    }

                                    scannedData.push({
                                        id: m._id, name: m.name, origin_name: m.origin_name, year: m.year,
                                        quality: m.quality, lang: m.lang, episode_current: m.episode_current,
                                        content: m.content ? m.content.replace(/<[^>]*>?/gm, '').replace(/(\r\n|\n|\r)/gm, " ").trim() : "",
                                        thumb_url: m.thumb_url, poster_url: m.poster_url,
                                        m3u8_links: m3u8_links // Thêm trường dữ liệu link m3u8
                                    });
                                }
                            } catch (e) { console.error(e); }
                        }));
                        scanUI.stats.textContent = `Đã quét: ${scannedData.length} phim`;
                    }
                    scanUI.progressFill.style.width = `${(page / totalPages) * 100}%`;
                }

                if (isScanning) {
                    scanUI.status.textContent = "Hoàn tất quét dữ liệu!";
                    finishScan();
                }
            } catch (error) {
                console.error(error);
                scanUI.status.textContent = "Có lỗi xảy ra!";
                isScanning = false;
            }
        };

        window.stopScan = () => {
            isScanning = false;
            scanUI.status.textContent = "Đã dừng. Đang chuẩn bị file tải xuống...";
            setTimeout(finishScan, 1000);
        };

        function finishScan() {
            isScanning = false;
            if (scannedData.length === 0) {
                alert("Không có dữ liệu nào được quét!");
                closeScanModal(); return;
            }

            if (scanFormat === 'json') {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(scannedData, null, 2));
                triggerDownload(dataStr, `ophim_data_${Date.now()}.json`);
            } else {
                const header = Object.keys(scannedData[0]);
                const replacer = (key, value) => value === null ? '' : value.toString().replace(/"/g, '""');
                const csv = scannedData.map(row => header.map(fieldName => `"${replacer(fieldName, row[fieldName])}"`).join(','));
                csv.unshift(header.join(','));
                const blob = new Blob(["\uFEFF" + csv.join('\r\n')], { type: 'text/csv;charset=utf-8;' });
                triggerDownload(URL.createObjectURL(blob), `ophim_data_${Date.now()}.csv`);
            }
            closeScanModal();
        }

        function triggerDownload(url, filename) {
            const a = document.createElement('a');
            a.href = url; a.download = filename;
            document.body.appendChild(a); a.click(); a.remove();
        }

        // ==========================================
        // 2. ONBOARDING & INIT & USER PROFILE
        // ==========================================
        function checkOnboarding() {
            initTheme();
            loadUserData(); 
            const saved = localStorage.getItem('tanime_prefs');
            if (saved) {
                userPrefsSlugs = JSON.parse(saved);
                applyUserProfile();
                initApp(); 
            } else {
                ui.obGrid.innerHTML = ALL_GENRES.map(g => `<div class="ob-pill" data-slug="${g.slug}" onclick="togglePref(this)">${g.name}</div>`).join('');
                
                ui.obInputName.addEventListener('input', validateOnboardingForm);

                ui.loader.style.display = 'none';
                ui.onboardingModal.style.display = 'flex';
            }
        }

        window.selectPresetAvatar = (src) => {
            document.getElementById('ob-preview-img').src = src;
            document.getElementById('ob-input-avatar').value = src;
            validateOnboardingForm();
        };

        window.updateAvatarPreview = (val) => {
            const previewImg = document.getElementById('ob-preview-img');
            if(val) previewImg.src = val;
            else previewImg.src = 'https://api.dicebear.com/7.x/adventurer/svg?seed=Felix';
        };

        window.togglePref = (el) => {
            const slug = el.getAttribute('data-slug');
            if (selectedPrefs.has(slug)) { selectedPrefs.delete(slug); el.classList.remove('active'); } 
            else { selectedPrefs.add(slug); el.classList.add('active'); }
            validateOnboardingForm();
        };

        function validateOnboardingForm() {
            const nameInput = ui.obInputName.value.trim();
            ui.btnSavePrefs.disabled = (selectedPrefs.size === 0 || nameInput === '');
        }

        window.savePreferences = () => {
            userPrefsSlugs = Array.from(selectedPrefs);
            localStorage.setItem('tanime_prefs', JSON.stringify(userPrefsSlugs));
            
            const nameInput = ui.obInputName.value.trim();
            const avatarInput = ui.obInputAvatar.value.trim();
            
            const userProfile = {
                name: nameInput || 'Guest User',
                avatar: avatarInput || 'https://api.dicebear.com/7.x/adventurer/svg?seed=Felix'
            };
            localStorage.setItem('tanime_profile', JSON.stringify(userProfile));

            applyUserProfile();

            ui.onboardingModal.style.display = 'none';
            ui.loader.style.display = 'flex';
            initApp();
        };

        function applyUserProfile() {
            const savedProfile = localStorage.getItem('tanime_profile');
            if (savedProfile) {
                const profile = JSON.parse(savedProfile);
                
                document.querySelectorAll('.display-user-name').forEach(el => {
                    el.textContent = profile.name;
                });
                
                if (profile.avatar) {
                    const fallbackHTML = `<i class='ph-fill ph-user' style='color: white; font-size: inherit;'></i>`;
                    const avatarImgHTML = `<img src="${profile.avatar}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.outerHTML=\`${fallbackHTML}\`">`;
                    
                    document.querySelectorAll('.display-user-avatar').forEach(el => {
                        el.innerHTML = avatarImgHTML;
                    });
                }
            }
        }

        async function initApp() {
            try {
                const searchRes = await fetch('https://ophim1.com/v1/api/tim-kiem?keyword=overlord');
                const searchData = await searchRes.json();
                
                if (searchData.status === 'success' && searchData.data.items.length > 0) {
                    await loadMovieDetail(searchData.data.items[0].slug);
                } else {
                    const res = await fetch('https://ophim1.com/v1/api/danh-sach/hoat-hinh?page=1');
                    const data = await res.json();
                    if (data.status === 'success' && data.data.items.length > 0) {
                        await loadMovieDetail(data.data.items[0].slug);
                    }
                }

                renderGenreTabs();
                switchTab(userPrefsSlugs.length > 0 ? userPrefsSlugs[0] : ALL_GENRES[0].slug);
                
                ui.appWrapper.style.display = 'flex';
                setTimeout(() => {
                    ui.appWrapper.style.opacity = '1';
                }, 50);

            } catch (error) { console.error(error); } 
            finally { ui.loader.style.display = 'none'; }
        }

        // ==========================================
        // 3. MAIN PLAYER LOGIC
        // ==========================================
        function setHeroLoadingState() {
            ui.playerWrapper.innerHTML = `<div class="flex-center" style="width:100%;height:100%;"><div class="spinner"></div></div>`;
            ui.movieTitle.innerHTML = `<div class="skeleton-block" style="width: 80%; height: 40px; margin-bottom: 8px;"></div><div class="skeleton-block" style="width: 50%; height: 40px;"></div>`;
            ui.movieDesc.innerHTML = `<div class="skeleton-block" style="width: 100%; height: 16px; margin-bottom: 8px;"></div><div class="skeleton-block" style="width: 90%; height: 16px; margin-bottom: 8px;"></div><div class="skeleton-block" style="width: 70%; height: 16px;"></div>`;
            
            const btnSave = document.getElementById('btn-save');
            if(btnSave) {
                btnSave.className = 'btn-pill';
                btnSave.innerHTML = `<i class="ph-bold ph-heart"></i> <span class="action-text">Lưu</span>`;
            }
        }

        window.loadMovieDetailAndScroll = (slug) => {
            loadMovieDetail(slug);
            const offset = window.innerWidth <= 1024 ? 80 : 0;
            const mainCol = document.querySelector('.main-column');
            if (mainCol) {
                const topPos = mainCol.getBoundingClientRect().top + window.pageYOffset - offset;
                window.scrollTo({ top: topPos, behavior: 'smooth' });
            } else {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        async function loadMovieDetail(slug) {
            setHeroLoadingState();
            try {
                const res = await fetch(`https://ophim1.com/phim/${slug}`);
                const data = await res.json();
                if (data.status) {
                    currentEpChunk = 0; 
                    currentMovieData = data.movie;
                    currentEpisodesList = data.episodes[0]?.server_data || [];
                    activeEpisode = currentEpisodesList.length > 0 ? currentEpisodesList[0] : null;

                    const bgUrl = `https://img.ophim.live/uploads/movies/${currentMovieData.poster_url || currentMovieData.thumb_url}`;
                    ui.appBg.style.backgroundImage = `url('${bgUrl}')`;

                    renderPlayer();
                    renderMovieInfo();
                    renderEpisodes();
                }
            } catch (error) { console.error(error); }
        }

        function renderPlayer() {
            if (activeEpisode) {
                ui.playerWrapper.innerHTML = `<iframe src="${activeEpisode.link_embed}" allowfullscreen title="Anime Player"></iframe>`;
            } else {
                ui.playerWrapper.innerHTML = `<div class="flex-center" style="width:100%;height:100%;color:var(--text-muted);"><i class="ph-bold ph-monitor-play" style="font-size:48px;"></i></div>`;
            }
        }

        function renderMovieInfo() {
            const m = currentMovieData;
            ui.movieTitle.textContent = m.name;
            ui.movieDesc.innerHTML = m.content ? m.content.replace(/<[^>]*>?/gm, '').substring(0, 450) + '...' : 'Đang cập nhật...';
            
            ui.movieMeta.innerHTML = `
                <span class="tag-rating"><i class="ph-fill ph-star"></i> ${m.tmdb?.vote_average || '9.5'}</span>
                <span class="tag-box">${m.quality || 'FHD'}</span>
                <span class="tag-box">${m.lang || 'Vietsub'}</span>
                <span class="tag-box">${m.year}</span>
                <span style="color: var(--text-muted);"><i class="ph-bold ph-clock"></i> ${m.time || '24 Phút/Tập'}</span>
            `;
            updateMainPlayerFavUI();
        }

        function updateMainPlayerFavUI() {
            if(!currentMovieData) return;
            const isLiked = favorites.some(f => f.slug === currentMovieData.slug);
            const btnSave = document.getElementById('btn-save'); 
            if(btnSave) {
                btnSave.className = `btn-pill ${isLiked ? 'saved' : ''}`;
                btnSave.innerHTML = `<i class="${isLiked ? 'ph-fill' : 'ph-bold'} ph-heart"></i> <span class="action-text">${isLiked ? 'Đã Lưu' : 'Lưu'}</span>`;
            }
        }

        function renderEpisodes() {
            ui.epCount.textContent = `${currentEpisodesList.length} Tập`;
            const totalChunks = Math.ceil(currentEpisodesList.length / EP_CHUNK_SIZE);
            if (totalChunks > 1) {
                ui.epChunkSelect.style.display = 'block';
                ui.epChunkSelect.innerHTML = Array.from({length: totalChunks}).map((_, i) => {
                    const start = i * EP_CHUNK_SIZE + 1;
                    const end = Math.min((i + 1) * EP_CHUNK_SIZE, currentEpisodesList.length);
                    return `<option value="${i}" ${i === currentEpChunk ? 'selected' : ''}>Tập ${start} - ${end}</option>`;
                }).join('');
            } else ui.epChunkSelect.style.display = 'none';

            const startIdx = currentEpChunk * EP_CHUNK_SIZE;
            const endIdx = startIdx + EP_CHUNK_SIZE;
            const epsToRender = currentEpisodesList.slice(startIdx, endIdx);

            ui.epGrid.innerHTML = epsToRender.map((ep, idx) => {
                const realIdx = startIdx + idx; 
                const isActive = activeEpisode && activeEpisode.slug === ep.slug;
                return `<button class="btn-episode ${isActive ? 'active' : ''}" title="${ep.name}" onclick="selectEpisode(${realIdx}, this)">${ep.name}</button>`;
            }).join('');
        }

        window.changeEpChunk = (val) => { currentEpChunk = parseInt(val); renderEpisodes(); };
        
        window.selectEpisode = (idx, btnEl) => {
            activeEpisode = currentEpisodesList[idx];
            currentEpChunk = Math.floor(idx / EP_CHUNK_SIZE); 
            renderPlayer(); 
            renderEpisodes(); 
            addToHistory(currentMovieData, activeEpisode);
            
            setTimeout(() => {
                const activeBtn = document.querySelector('.btn-episode.active');
                if(activeBtn && ui.epGrid) {
                    const scrollPos = activeBtn.offsetTop - ui.epGrid.offsetTop - (ui.epGrid.clientHeight / 2) + (activeBtn.clientHeight / 2);
                    ui.epGrid.scrollTo({ top: scrollPos, behavior: 'smooth' });
                }
            }, 100);

            const offset = window.innerWidth <= 1024 ? 80 : 0;
            const mainCol = document.querySelector('.main-column');
            if (mainCol) {
                const topPos = mainCol.getBoundingClientRect().top + window.pageYOffset - offset;
                window.scrollTo({ top: topPos, behavior: 'smooth' });
            } else {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        // --- TẢI VIDEO ---
        window.downloadCurrentEpisode = async () => {
            if (!currentMovieData || !activeEpisode) return;
            const btn = document.getElementById('btn-download');
            if (btn.classList.contains('downloading')) return;
            const m3u8Link = activeEpisode.link_m3u8;
            if (!m3u8Link) { alert("Lỗi tải video!"); return; }

            btn.classList.add('downloading');
            btn.innerHTML = `<i class="ph-bold ph-spinner-gap" style="animation: spin 1s linear infinite;"></i> <span class="action-text">Đang phân tích...</span>`;
            try {
                const fetchText = async (url) => { const res = await fetch(url); return await res.text(); };
                let manifest = await fetchText(m3u8Link);
                let baseUrl = m3u8Link.substring(0, m3u8Link.lastIndexOf('/') + 1);

                if (manifest.includes('#EXT-X-STREAM-INF')) {
                    const lines = manifest.split('\n'); let bestUrl = '';
                    for (let i = 0; i < lines.length; i++) {
                        if (lines[i].includes('#EXT-X-STREAM-INF')) { let n = lines[i+1].trim(); if(n) bestUrl = n; }
                    }
                    if (bestUrl) {
                        if (!bestUrl.startsWith('http')) bestUrl = baseUrl + bestUrl;
                        manifest = await fetchText(bestUrl); baseUrl = bestUrl.substring(0, bestUrl.lastIndexOf('/') + 1);
                    }
                }

                const tsUrls = [];
                for (let line of manifest.split('\n')) {
                    line = line.trim(); if (line && !line.startsWith('#')) tsUrls.push(line.startsWith('http') ? line : baseUrl + line);
                }
                if (tsUrls.length === 0) throw new Error("No TS");

                const chunks = new Array(tsUrls.length); let dlCount = 0;
                for (let i = 0; i < tsUrls.length; i += 5) {
                    const batch = tsUrls.slice(i, i + 5);
                    const promises = batch.map(async (url, idx) => {
                        const res = await fetch(url); const buffer = await res.arrayBuffer();
                        return { index: i + idx, buffer };
                    });
                    const results = await Promise.all(promises);
                    for (const r of results) chunks[r.index] = r.buffer;
                    dlCount += batch.length;
                    btn.innerHTML = `<i class="ph-bold ph-spinner-gap" style="animation: spin 1s linear infinite;"></i> <span class="action-text">${Math.floor((dlCount / tsUrls.length) * 100)}%</span>`;
                }

                btn.innerHTML = `<i class="ph-bold ph-spinner-gap" style="animation: spin 1s linear infinite;"></i> <span class="action-text">Đang ghép...</span>`;
                const blob = new Blob(chunks, { type: 'video/mp2t' });
                const url = window.URL.createObjectURL(blob);
                
                const a = document.createElement('a'); a.style.display = 'none'; a.href = url;
                a.download = `${currentMovieData.slug}-tap-${activeEpisode.name}.ts`;
                document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); document.body.removeChild(a);
                
                if (!downloadList.some(d => d.slug === currentMovieData.slug && d.epName === activeEpisode.name)) {
                    downloadList.unshift({ slug: currentMovieData.slug, name: currentMovieData.name, thumb_url: currentMovieData.thumb_url, epName: activeEpisode.name, time: `Đã tải hôm nay` });
                    localStorage.setItem('tanime_downloads', JSON.stringify(downloadList));
                    if (currentPanelTab === 'download') renderSidePanel();
                }
                
                btn.classList.remove('downloading'); btn.innerHTML = `<i class="ph-bold ph-check"></i> <span class="action-text">Hoàn tất</span>`;
                setTimeout(() => { if(btn) btn.innerHTML = `<i class="ph-bold ph-download-simple"></i> <span class="action-text">Tải Về</span>`; }, 3000);
            } catch (error) {
                if (confirm("Lỗi mạng/CORS. Mở link gốc để tải bằng phần mềm thứ 3?")) {
                    const a = document.createElement('a'); a.href = m3u8Link; a.target = '_blank'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
                }
                btn.classList.remove('downloading'); btn.innerHTML = `<i class="ph-bold ph-download-simple"></i> <span class="action-text">Tải Về</span>`;
            }
        };

        // ==========================================
        // 4. BINDING SEARCH LOGIC
        // ==========================================
        function initSearchLogic(inputId, dropdownId) {
            let searchTimeout;
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            if(!input || !dropdown) return;

            input.addEventListener('input', (e) => {
                const query = e.target.value.trim(); clearTimeout(searchTimeout);
                if (!query) { dropdown.style.display = 'none'; return; }
                dropdown.style.display = 'block';
                dropdown.innerHTML = `<div class="search-msg"><i class="ph-bold ph-spinner-gap" style="animation:spin 1s linear infinite;"></i> Đang dò tìm tín hiệu...</div>`;
                
                searchTimeout = setTimeout(async () => {
                    try {
                        const res = await fetch(`https://ophim1.com/v1/api/tim-kiem?keyword=${encodeURIComponent(query)}`);
                        const data = await res.json();
                        if (data.status === 'success' && data.data.items.length > 0) {
                            dropdown.innerHTML = data.data.items.map(item => `
                                <div class="search-item" onclick="loadMovieDetailAndScroll('${item.slug}'); document.getElementById('${dropdownId}').style.display='none'; document.getElementById('${inputId}').value='';">
                                    <div class="search-thumb"><img src="https://img.ophim.live/uploads/movies/${item.thumb_url}" onerror="this.src='https://via.placeholder.com/54x76/1F2937/00D1F5'"></div>
                                    <div class="search-info">
                                        <div class="search-title">${item.name}</div>
                                        <div class="search-origin">${item.origin_name}</div>
                                    </div>
                                </div>
                            `).join('');
                        } else dropdown.innerHTML = `<div class="search-msg">Không tìm thấy Anime.</div>`;
                    } catch (error) {}
                }, 500);
            });

            document.addEventListener('click', (e) => { if (!input.contains(e.target) && !dropdown.contains(e.target)) dropdown.style.display = 'none'; });
            
            input.addEventListener('focus', () => { if(input.value.trim()) dropdown.style.display = 'block'; });
        }

        initSearchLogic('search-input', 'search-dropdown'); // Desktop
        initSearchLogic('m-search-input', 'm-search-dropdown'); // Mobile

        // ==========================================
        // 5. LOGIC EXPLORE
        // ==========================================
        function renderGenreTabs() {
            const sortedGenres = [...ALL_GENRES].sort((a, b) => userPrefsSlugs.includes(b.slug) - userPrefsSlugs.includes(a.slug));
            ui.genreTabs.innerHTML = sortedGenres.map(g => `<button class="tab-btn ${userPrefsSlugs.includes(g.slug) ? 'recommended' : ''}" id="tab-${g.slug}" onclick="switchTab('${g.slug}')">${g.name}</button>`).join('');
        }

        window.switchTab = async (slug) => {
            if (exploreState.currentTabSlug === slug) return;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const aTab = document.getElementById(`tab-${slug}`);
            if(aTab) { aTab.classList.add('active'); aTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' }); }

            exploreState = { currentTabSlug: slug, apiPage: 1, localData: [], renderCount: 0, isFetching: false, hasMoreData: true };
            ui.exploreGrid.innerHTML = '';
            await fetchMoreGenreData();
        };

        async function fetchMoreGenreData() {
            if (exploreState.isFetching || !exploreState.hasMoreData) return;
            exploreState.isFetching = true; ui.lazyLoader.style.display = 'block';
            try {
                const res = await fetch(`https://ophim1.com/v1/api/the-loai/${exploreState.currentTabSlug}?page=${exploreState.apiPage}`);
                const data = await res.json();
                if (data.status === 'success' && data.data.items.length > 0) {
                    exploreState.localData.push(...data.data.items); exploreState.apiPage++; append10ItemsToGrid();
                } else exploreState.hasMoreData = false;
            } catch (error) { console.error(error); } 
            finally { exploreState.isFetching = false; ui.lazyLoader.style.display = 'none'; }
        }

        function append10ItemsToGrid() {
            const items = exploreState.localData.slice(exploreState.renderCount, exploreState.renderCount + 10);
            if (items.length === 0) { if(exploreState.hasMoreData && !exploreState.isFetching) fetchMoreGenreData(); return; }

            const html = items.map(item => `
                <div class="anime-card" onclick="loadMovieDetailAndScroll('${item.slug}')">
                    <div class="ac-thumb">
                        <img src="https://img.ophim.live/uploads/movies/${item.thumb_url}" onerror="this.src='https://via.placeholder.com/200x300/1F2937/00D1F5'">
                        <div class="ac-overlay"></div>
                        <div class="ac-ep">${item.episode_current || 'Tập 1'}</div>
                        <div class="ac-play-btn"><i class="ph-fill ph-play"></i></div>
                    </div>
                    <div class="ac-info">
                        <div class="ac-title">${item.name}</div>
                        <div class="ac-year">${item.year}</div>
                    </div>
                </div>
            `).join('');
            ui.exploreGrid.insertAdjacentHTML('beforeend', html);
            exploreState.renderCount += items.length;
        }

        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting) { exploreState.renderCount >= exploreState.localData.length ? fetchMoreGenreData() : append10ItemsToGrid(); }
        }, { rootMargin: '0px 0px 800px 0px' }); 
        observer.observe(ui.scrollAnchor);

        // ==========================================
        // 6. T-STORY LOGIC (ĐÃ NÂNG CẤP XỊN SÒ HƠN)
        // ==========================================
        const storyDOM = { modal: document.getElementById('story-modal'), container: document.getElementById('story-container'), loadingInit: document.getElementById('story-loading-init') };
        let storyCache = []; let isLoadingStory = false; let storyObserver; let videoPlaybackObserver;

        window.openStoryMode = () => { document.body.classList.add('modal-open'); storyDOM.modal.style.display = 'flex'; if (storyCache.length === 0) { initStoryObserver(); loadMoreStories(3); } };
        window.closeStoryMode = () => { document.body.classList.remove('modal-open'); storyDOM.modal.style.display = 'none'; storyDOM.container.querySelectorAll('iframe').forEach(iframe => iframe.src = ''); };

        function initStoryObserver() {
            storyObserver = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting && entry.target.dataset.isLast === 'true') { entry.target.dataset.isLast = 'false'; loadMoreStories(2); } }); }, { threshold: 0.5 });
            videoPlaybackObserver = new IntersectionObserver((entries) => { 
                entries.forEach(entry => { 
                    const iframe = entry.target.querySelector('iframe'); 
                    if (!iframe) return; 
                    if (entry.isIntersecting) { 
                        // Chỉ load src nếu iFrame chưa có link
                        if (!iframe.src || iframe.src.includes('about:blank')) {
                            // Tạo hiệu ứng mượt khi load iframe
                            const loader = entry.target.querySelector('.story-video-loader');
                            if(loader) loader.style.display = 'flex';
                            
                            iframe.src = iframe.dataset.src; 
                            iframe.onload = () => { if(loader) loader.style.display = 'none'; };
                        } 
                    } else { 
                        // KHẮC PHỤC LỖI KHÔNG PHÁT VIDEO: Không reset src="" nữa để tránh phải tải lại nguyên cái Player khi cuộn ngược lên
                        // Chỉ dừng bằng cách không làm gì, để trình duyệt tự quản lý bộ nhớ
                    } 
                }); 
            }, { threshold: 0.6 }); 
        }

        async function loadMoreStories(count) {
            if (isLoadingStory) return; isLoadingStory = true;
            try {
                const initRes = await fetch(`https://ophim1.com/v1/api/danh-sach/hoat-hinh?page=1`);
                const initData = await initRes.json();
                const totalPages = initData.data?.params?.pagination?.totalPages || 10;
                const randomPage = Math.floor(Math.random() * Math.min(totalPages, 50)) + 1;
                
                const listRes = await fetch(`https://ophim1.com/v1/api/danh-sach/hoat-hinh?page=${randomPage}`);
                const listData = await listRes.json();
                if (listData.status === 'success') {
                    const items = listData.data.items.sort(() => 0.5 - Math.random()).slice(0, count);
                    for (const item of items) {
                        const detailRes = await fetch(`https://ophim1.com/phim/${item.slug}`); const detailData = await detailRes.json();
                        if (detailData.status && detailData.episodes[0]?.server_data.length > 0) {
                            const m = detailData.movie; const eps = detailData.episodes[0].server_data; 
                            
                            // FIX: Chỉ random phim ngẫu nhiên, nhưng luôn lấy Tập 1 (index 0) để người dùng có thể xem trọn vẹn, tua/phát bình thường.
                            const firstEpIndex = 0; 
                            const firstEp = eps[firstEpIndex];
                            
                            const storyObj = { 
                                slug: m.slug, name: m.name, content: m.content ? m.content.replace(/<[^>]*>?/gm, '').substring(0, 150) + '...' : '', 
                                thumb_url: m.thumb_url, poster_url: m.poster_url, link: firstEp.link_embed, isLiked: favorites.some(f => f.slug === m.slug),
                                episodes: eps, currentEpIndex: firstEpIndex
                            };
                            storyCache.push(storyObj); appendStoryToDOM(storyObj);
                        }
                    }
                }
            } catch (error) {} finally { isLoadingStory = false; if(storyDOM.loadingInit) storyDOM.loadingInit.style.display = 'none'; }
        }

        function appendStoryToDOM(story) {
            const itemDiv = document.createElement('div'); itemDiv.className = 'story-item';
            const safeObjStr = JSON.stringify({slug: story.slug, name: story.name, thumb_url: story.thumb_url}).replace(/"/g, '&quot;');
            
            const epsHtml = story.episodes.map((ep, idx) =>
                `<button class="btn-episode ${idx === story.currentEpIndex ? 'active' : ''}" onclick="playStoryEpisode(this, '${ep.link_embed}')" title="${ep.name}">${ep.name}</button>`
            ).join('');

            itemDiv.innerHTML = `
                <div class="story-layout-container">
                    <div class="story-video-area">
                        <!-- THÊM SPINNER LOADER GIẢI QUYẾT TÌNH TRẠNG TRẮNG MÀN HÌNH CHỜ VIDEO -->
                        <div class="story-video-loader">
                            <div class="spinner" style="border-color: rgba(255,255,255,0.1); border-top-color: var(--accent-cyan); width: 40px; height: 40px; border-width: 3px;"></div>
                        </div>
                        <iframe data-src="${story.link}" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                    </div>

                    <div class="story-content-area">
                        <div class="story-overlay-bg"></div>
                        
                        <div class="story-meta">
                            <h3 class="story-title">${story.name}</h3>
                            <p class="story-desc">${story.content}</p>
                            <button class="btn-watch-now" onclick="watchFromStory('${story.slug}')"><i class="ph-fill ph-play"></i> Xem Full Bộ</button>
                        </div>
                        
                        <div class="story-actions">
                            <button class="action-icon ${story.isLiked ? 'liked' : ''}" onclick="toggleStoryLike(this, ${safeObjStr})">
                                <div class="icon-bg"><i class="${story.isLiked ? 'ph-fill' : 'ph-bold'} ph-heart"></i></div><span>Thích</span>
                            </button>
                            <button class="action-icon action-ep-btn" onclick="toggleMobileEpisodes(this)">
                                <div class="icon-bg"><i class="ph-bold ph-list-dashes"></i></div><span>Tập phim</span>
                            </button>
                            <button class="action-icon" onclick="shareStory()">
                                <div class="icon-bg"><i class="ph-fill ph-share-fat"></i></div><span>Chia sẻ</span>
                            </button>
                        </div>
                        
                        <div class="story-episodes-sheet">
                            <div class="se-header">
                                <h4>Danh Sách Tập</h4>
                                <button class="se-close-btn" onclick="toggleMobileEpisodes(this)"><i class="ph-bold ph-x"></i></button>
                            </div>
                            <div class="episodes-grid custom-scrollbar">
                                ${epsHtml}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="story-hint"><i class="ph-bold ph-caret-up"></i> Vuốt xem tiếp</div>
            `;
            storyDOM.container.appendChild(itemDiv); itemDiv.dataset.isLast = 'true';
            storyObserver.observe(itemDiv); videoPlaybackObserver.observe(itemDiv); 
        }

        window.playStoryEpisode = (btn, link) => {
            const storyItem = btn.closest('.story-item');
            const iframe = storyItem.querySelector('iframe');
            
            // Hiển thị lại loader khi chuyển tập
            const loader = storyItem.querySelector('.story-video-loader');
            if(loader) loader.style.display = 'flex';
            
            iframe.src = link;
            iframe.onload = () => { if(loader) loader.style.display = 'none'; };
            
            const grid = storyItem.querySelector('.episodes-grid');
            grid.querySelectorAll('.btn-episode').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        };

        window.toggleMobileEpisodes = (btn) => {
            const storyItem = btn.closest('.story-item');
            storyItem.classList.toggle('show-episodes');
        };

        window.toggleStoryLike = (btnElement, movieObj) => { 
            const isAdded = toggleFavorite(movieObj); 
            const iconObj = btnElement.querySelector('i');
            if (isAdded) { 
                btnElement.classList.add('liked'); 
                iconObj.className = 'ph-fill ph-heart'; 
            } else { 
                btnElement.classList.remove('liked'); 
                iconObj.className = 'ph-bold ph-heart'; 
            } 
        };
        window.watchFromStory = (slug) => { closeStoryMode(); loadMovieDetailAndScroll(slug); };
        window.shareStory = () => { alert("Đã copy link phim vào khay nhớ tạm!"); };

        // Init
        window.onload = checkOnboarding;
    </script>
</body>
</html>
