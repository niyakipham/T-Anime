<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T-ANIME | Streaming Platform</title>
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Icons (Phosphor Icons) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* ==========================================================================
           1. CSS VARIABLES & THEME (Dark Mode / Premium Streaming)
           ========================================================================== */
        :root {
            --bg-main: #0a0a16;
            --bg-card: rgba(15, 15, 25, 0.4);
            --bg-glass: rgba(255, 255, 255, 0.03);
            --bg-glass-hover: rgba(255, 255, 255, 0.08);
            
            --text-light: #E0E0FF;
            --text-muted: #8A8A9D;
            --text-white: #FFFFFF;
            
            --accent-purple: #B026FF;
            --accent-cyan: #00D1F5;
            --accent-yellow: #FFB800;
            --accent-red: #FF3B30;

            --border-glass: rgba(255, 255, 255, 0.06);
            --border-glass-strong: rgba(255, 255, 255, 0.12);

            --shadow-glow-purple: 0 0 20px rgba(176, 38, 255, 0.4);
            --shadow-glow-cyan: 0 0 20px rgba(0, 209, 245, 0.4);
            --shadow-panel: 0 24px 48px rgba(0, 0, 0, 0.6);
            
            --font-main: 'Inter', sans-serif;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* --- LIGHT MODE VARIABLES --- */
        [data-theme="light"] {
            --bg-main: #f4f4f9;
            --bg-card: rgba(255, 255, 255, 0.7);
            --bg-glass: rgba(0, 0, 0, 0.03);
            --bg-glass-hover: rgba(0, 0, 0, 0.06);
            
            --text-light: #1a1a2e;
            --text-muted: #6b6b80;
            --text-white: #0f0f1a;
            
            --accent-purple: #9000ff;
            --accent-cyan: #0098ba;
            
            --border-glass: rgba(0, 0, 0, 0.08);
            --border-glass-strong: rgba(0, 0, 0, 0.15);
            --shadow-panel: 0 24px 48px rgba(0, 0, 0, 0.1);
        }

        /* --- COLOR THEMES --- */
        [data-color="emerald"] {
            --accent-purple: #10b981; --accent-cyan: #14b8a6;
            --shadow-glow-purple: 0 0 20px rgba(16, 185, 129, 0.4); --shadow-glow-cyan: 0 0 20px rgba(20, 184, 166, 0.4);
        }
        [data-color="rose"] {
            --accent-purple: #f43f5e; --accent-cyan: #f97316;
            --shadow-glow-purple: 0 0 20px rgba(244, 63, 94, 0.4); --shadow-glow-cyan: 0 0 20px rgba(249, 115, 22, 0.4);
        }
        [data-color="amber"] {
            --accent-purple: #f59e0b; --accent-cyan: #ef4444;
            --shadow-glow-purple: 0 0 20px rgba(245, 158, 11, 0.4); --shadow-glow-cyan: 0 0 20px rgba(239, 68, 68, 0.4);
        }
        [data-color="blue"] {
            --accent-purple: #3b82f6; --accent-cyan: #6366f1;
            --shadow-glow-purple: 0 0 20px rgba(59, 130, 246, 0.4); --shadow-glow-cyan: 0 0 20px rgba(99, 102, 241, 0.4);
        }

        .theme-swatch { transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .theme-swatch:hover { transform: scale(1.15) !important; }

        /* ==========================================================================
           2. BASE & RESET
           ========================================================================== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: var(--font-main); 
            background-color: var(--bg-main); 
            color: var(--text-light); 
            line-height: 1.6; 
            overflow-x: hidden; 
            scroll-behavior: smooth; 
            transition: background-color 0.5s ease;
        }
        body.modal-open { overflow: hidden; }
        ::selection { background-color: var(--accent-purple); color: var(--text-white); }
        a { text-decoration: none; color: inherit; }
        button { border: none; background: none; cursor: pointer; font-family: inherit; outline: none; }
        ul { list-style: none; }
        img { max-width: 100%; height: auto; display: block; }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(138, 138, 157, 0.3); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-cyan); }

        /* Ambient Background */
        #app-bg {
            position: fixed; inset: -50px; z-index: -2;
            background-size: cover; background-position: center;
            filter: blur(60px) brightness(0.4);
            transition: background-image 1.5s ease-in-out;
            transform: scale(1.1); 
        }
        #app-bg-overlay {
            position: fixed; inset: 0; z-index: -1;
            background: linear-gradient(to bottom, rgba(10,10,22,0.6) 0%, rgba(10,10,22,0.95) 100%);
            transition: background 0.5s ease;
        }
        [data-theme="light"] #app-bg { filter: blur(60px) brightness(0.9); }
        [data-theme="light"] #app-bg-overlay {
            background: linear-gradient(to bottom, rgba(244,244,249,0.7) 0%, rgba(244,244,249,0.98) 100%);
        }

        /* ==========================================================================
           3. LAYOUT & UTILITIES
           ========================================================================== */
        .container { max-width: 1400px; margin: 0 auto; padding: 0 24px; }
        .gradient-text { background: linear-gradient(to right, var(--accent-purple), var(--accent-cyan)); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        .flex-between { display: flex; align-items: center; justify-content: space-between; }
        
        .glass-panel { 
            background: var(--bg-card); 
            border: 1px solid var(--border-glass); 
            backdrop-filter: blur(24px); 
            -webkit-backdrop-filter: blur(24px);
            border-radius: 24px; 
            box-shadow: var(--shadow-panel);
        }

        /* Loader */
        #loader { position: fixed; inset: 0; background: var(--bg-main); z-index: 9999; flex-direction: column; }
        .spinner { width: 56px; height: 56px; border: 3px solid rgba(0,209,245,0.2); border-top-color: var(--accent-cyan); border-radius: 50%; animation: spin 1s linear infinite; }
        .loader-text { margin-top: 24px; font-size: 0.875rem; font-weight: 700; letter-spacing: 0.2em; color: var(--text-muted); animation: pulse 2s infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }

        /* ==========================================================================
           4. NAVBAR (Premium Look)
           ========================================================================== */
        .navbar { 
            position: fixed; top: 0; left: 0; width: 100%; 
            background: linear-gradient(to bottom, rgba(10,10,22,0.9) 0%, rgba(10,10,22,0) 100%);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            padding: 20px 32px; z-index: 100; transition: background 0.3s;
        }
        .navbar.scrolled { background: rgba(10,10,22,0.95); border-bottom: 1px solid var(--border-glass); }
        [data-theme="light"] .navbar { background: linear-gradient(to bottom, rgba(244,244,249,0.9) 0%, rgba(244,244,249,0) 100%); }
        [data-theme="light"] .navbar.scrolled { background: rgba(244,244,249,0.95); }
        
        .nav-logo { font-size: 1.75rem; font-weight: 900; font-style: italic; letter-spacing: -1px; text-transform: uppercase; }
        .nav-links { display: none; gap: 32px; font-size: 0.9rem; font-weight: 600; color: var(--text-muted); }
        @media (min-width: 768px) { .nav-links { display: flex; } }
        .nav-links a { position: relative; padding-bottom: 4px; transition: var(--transition); }
        .nav-links a:hover, .nav-links a.active { color: var(--text-white); }
        .nav-links a.active::after { content:''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background: var(--accent-cyan); border-radius: 2px; box-shadow: var(--shadow-glow-cyan); }

        /* Search Box */
        .search-container { position: relative; }
        .search-box { 
            display: flex; align-items: center; gap: 12px; 
            background: var(--bg-glass); border: 1px solid transparent; 
            border-radius: 12px; padding: 10px 20px; width: 280px; transition: var(--transition); 
        }
        .search-box:focus-within { background: var(--bg-glass-hover); border-color: rgba(0, 209, 245, 0.5); box-shadow: var(--shadow-glow-cyan); }
        .search-box input { background: transparent; border: none; color: var(--text-white); font-size: 0.9rem; width: 100%; font-family: inherit;}
        .search-box input::placeholder { color: var(--text-muted); }
        
        .search-dropdown { position: absolute; top: calc(100% + 16px); right: 0; width: 100%; min-width: 360px; background: var(--bg-card); border: 1px solid var(--border-glass-strong); border-radius: 16px; box-shadow: var(--shadow-panel); max-height: 60vh; overflow-y: auto; display: none; z-index: 101; backdrop-filter: blur(24px); padding: 8px; }
        [data-theme="light"] .search-dropdown { background: rgba(255,255,255,0.95); }
        .search-item { display: flex; gap: 16px; padding: 12px; border-radius: 12px; cursor: pointer; transition: var(--transition); margin-bottom: 4px;}
        .search-item:hover { background: var(--bg-glass-hover); }
        .search-thumb { width: 48px; height: 68px; border-radius: 8px; background: #1F2937; overflow: hidden; flex-shrink: 0; }
        .search-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .search-info { display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .search-title { font-size: 0.9rem; font-weight: 700; color: var(--text-white); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .search-origin { font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;}
        .search-msg { padding: 24px; text-align: center; font-size: 0.9rem; color: var(--text-muted); }

        /* Nav Actions */
        .nav-actions { display: flex; align-items: center; gap: 20px; }
        .btn-icon { color: var(--text-white); transition: var(--transition); position: relative; display: flex; align-items: center; justify-content: center;}
        .btn-icon:hover { color: var(--accent-cyan); transform: scale(1.1); }
        
        .btn-story { 
            display: flex; align-items: center; gap: 8px; padding: 10px 20px; 
            background: var(--bg-glass); border: 1px solid var(--border-glass-strong);
            border-radius: 12px; font-weight: 600; font-size: 0.9rem; color: var(--text-white);
            transition: var(--transition);
        }
        .btn-story:hover { background: linear-gradient(45deg, var(--accent-purple), var(--accent-cyan)); border-color: transparent; box-shadow: var(--shadow-glow-purple); color: white;}
        .btn-story i { font-size: 1.25rem; }

        .user-avatar { width: 44px; height: 44px; border-radius: 14px; background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan)); padding: 2px; cursor: pointer; position: relative;}
        .user-avatar-inner { width: 100%; height: 100%; background: var(--bg-main); border-radius: 12px; display: flex; align-items: center; justify-content: center; }
        [data-theme="light"] .user-avatar-inner i { color: #fff !important; } 

        /* ==========================================================================
           5. DROPDOWN AVATAR (MENU DỌC MỚI)
           ========================================================================== */
        .user-dropdown { position: absolute; top: calc(100% + 20px); right: 0; width: 340px; background: rgba(15,15,25,0.95); border: 1px solid var(--border-glass-strong); border-radius: 20px; box-shadow: var(--shadow-panel); display: none; z-index: 101; backdrop-filter: blur(24px); overflow: hidden; flex-direction: column; }
        [data-theme="light"] .user-dropdown { background: rgba(255,255,255,0.95); }

        /* Main Menu View */
        .dropdown-user-info { display: flex; align-items: center; gap: 16px; padding: 24px 20px; border-bottom: 1px solid var(--border-glass); }
        .dropdown-menu-list { padding: 12px 8px; display: flex; flex-direction: column; gap: 4px; }
        .dropdown-menu-item { display: flex; align-items: center; gap: 12px; width: 100%; padding: 14px 16px; border-radius: 12px; color: var(--text-white); font-weight: 600; font-size: 0.95rem; transition: var(--transition); background: transparent; text-align: left;}
        .dropdown-menu-item:hover { background: var(--bg-glass-hover); transform: translateX(4px); }
        .dropdown-menu-item i:first-child { font-size: 1.3rem; }
        
        /* Sub Menu View */
        .dropdown-sub-header { display: flex; align-items: center; gap: 16px; padding: 16px 20px; border-bottom: 1px solid var(--border-glass); }
        .btn-back-dropdown { color: var(--text-white); font-size: 1.2rem; padding: 6px; border-radius: 50%; transition: var(--transition); display: flex; align-items: center; background: var(--bg-glass);}
        .btn-back-dropdown:hover { background: var(--bg-glass-hover); }
        .dropdown-header-title { font-size: 0.95rem; font-weight: 800; color: var(--text-white); text-transform: uppercase; letter-spacing: 0.5px;}
        
        .user-list-container { max-height: 380px; overflow-y: auto; padding: 8px 12px 12px;}
        .list-item { display: flex; gap: 14px; padding: 12px; border-radius: 12px; cursor: pointer; transition: var(--transition); align-items: center; margin-bottom: 4px; background: var(--bg-glass);}
        .list-item:hover { background: var(--bg-glass-hover); transform: translateX(4px);}
        .list-thumb { width: 50px; height: 70px; border-radius: 8px; overflow: hidden; flex-shrink: 0; }
        .list-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .list-info { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; gap: 4px;}
        .list-title { font-size: 0.95rem; font-weight: 700; color: var(--text-white); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.3;}
        .list-subtitle { font-size: 0.8rem; color: var(--accent-cyan); font-weight: 600;}
        .list-time { font-size: 0.75rem; color: var(--text-muted); }
        
        .btn-remove-list { color: var(--text-muted); padding: 8px; border-radius: 8px; transition: var(--transition); display: flex; align-items: center; justify-content: center;}
        .btn-remove-list:hover { color: var(--accent-red); background: rgba(255,59,48,0.1); }
        .list-empty { padding: 40px 24px; text-align: center; color: var(--text-muted); font-size: 0.95rem; font-weight: 500;}

        /* Mobile Bottom Nav */
        .mobile-bottom-nav {
            display: none; position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(10,10,22,0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-glass); z-index: 1000;
            padding: 12px 24px calc(12px + env(safe-area-inset-bottom)); justify-content: space-between;
        }
        [data-theme="light"] .mobile-bottom-nav { background: rgba(255,255,255,0.95); }
        
        .mobile-nav-item {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            color: var(--text-muted); font-size: 0.75rem; font-weight: 600; transition: var(--transition);
        }
        .mobile-nav-item.active { color: var(--text-white); }
        .mobile-nav-item.active i { color: var(--accent-cyan); filter: drop-shadow(0 0 10px rgba(0, 209, 245, 0.5)); }
        .mobile-nav-item i { font-size: 1.5rem; transition: var(--transition); }
        .mobile-nav-item.story i { 
            background: linear-gradient(45deg, var(--accent-purple), var(--accent-cyan)); 
            -webkit-background-clip: text; color: transparent; filter: drop-shadow(0 4px 8px rgba(176,38,255,0.4));
        }

        /* ==========================================================================
           6. ONBOARDING MODAL
           ========================================================================== */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; backdrop-filter: blur(20px); display: none; align-items: center; justify-content: center; }
        [data-theme="light"] .modal-overlay { background: rgba(255,255,255,0.8); }
        .modal-content.onboarding { background: var(--bg-card); border: 1px solid var(--border-glass-strong); border-radius: 32px; padding: 48px; width: 90%; max-width: 700px; text-align: center; box-shadow: var(--shadow-panel); }
        .ob-title { font-size: 2.5rem; font-weight: 900; margin-bottom: 12px; letter-spacing: -1px;}
        .ob-desc { color: var(--text-muted); margin-bottom: 40px; font-size: 1.1rem; }
        
        .ob-grid { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-bottom: 40px; }
        .ob-pill { padding: 14px 28px; border-radius: 16px; border: 1px solid var(--border-glass-strong); background: var(--bg-glass); color: var(--text-light); font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: var(--transition); }
        .ob-pill:hover { background: var(--bg-glass-hover); transform: translateY(-2px);}
        .ob-pill.active { background: var(--accent-cyan); color: #000; border-color: transparent; box-shadow: var(--shadow-glow-cyan); transform: scale(1.05); }

        .btn-primary { background: var(--text-white); color: var(--bg-main); border: none; padding: 16px 40px; border-radius: 16px; font-size: 1.1rem; font-weight: 800; cursor: pointer; transition: var(--transition); width: 100%; max-width: 320px; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .btn-primary:disabled { background: var(--bg-glass-hover); color: var(--text-muted); cursor: not-allowed; box-shadow: none; transform: none;}

        /* ==========================================================================
           7. MAIN GRID (PLAYER & INFO)
           ========================================================================== */
        .main-content { padding-top: 120px; padding-bottom: 40px; display: grid; grid-template-columns: 1fr; gap: 32px; min-height: 80vh;}
        @media (min-width: 1200px) { .main-content { grid-template-columns: 1fr 380px; gap: 40px; } }

        .col-left { display: flex; flex-direction: column; gap: 32px; }
        
        /* Player */
        .player-container { 
            position: relative; width: 100%; aspect-ratio: 16 / 9; 
            background: #000; border-radius: 24px; 
            box-shadow: var(--shadow-panel), 0 0 0 1px rgba(255,255,255,0.05); 
            overflow: hidden; 
        }
        [data-theme="light"] .player-container { box-shadow: var(--shadow-panel), 0 0 0 1px rgba(0,0,0,0.1); }
        .player-container iframe { width: 100%; height: 100%; border: none; position: absolute; top: 0; left: 0; }
        .player-glow { position: absolute; top: -10px; left: -10px; right: -10px; bottom: -10px; background: inherit; filter: blur(30px) opacity(0.5); z-index: -1; }
        
        /* Movie Info */
        .movie-info-panel { display: flex; flex-direction: column; gap: 20px; }
        .info-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start; gap: 20px; }
        .movie-title { font-size: 2.5rem; font-weight: 900; color: var(--text-white); line-height: 1.2; letter-spacing: -1px; text-shadow: 0 4px 12px rgba(0,0,0,0.5);}
        [data-theme="light"] .movie-title { text-shadow: none; }
        
        .action-btns { display: flex; gap: 12px; }
        .btn-action { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 20px; background: var(--bg-glass); border: 1px solid var(--border-glass-strong); border-radius: 14px; font-size: 0.9rem; font-weight: 600; transition: var(--transition); color: var(--text-white); backdrop-filter: blur(10px);}
        .btn-action:hover { background: var(--bg-glass-hover); transform: translateY(-2px);}
        .btn-action.save.saved { background: var(--text-white); color: var(--bg-main); border-color: transparent; }
        .btn-action.save.saved i { color: var(--accent-red); }
        .btn-action i { font-size: 1.2rem; }
        
        .meta-tags { display: flex; flex-wrap: wrap; gap: 12px; font-size: 0.9rem; font-weight: 500; color: var(--text-white); align-items: center;}
        .tag-rating { color: #000; background: var(--accent-yellow); padding: 4px 10px; border-radius: 8px; font-weight: 800; display: flex; align-items: center; gap: 4px;}
        .tag-box { background: var(--bg-glass-hover); padding: 4px 10px; border-radius: 8px; border: 1px solid var(--border-glass);}
        
        .movie-desc { font-size: 1rem; color: var(--text-muted); line-height: 1.8; margin-top: 8px;}

        /* Right Col (Episodes) */
        .episodes-box { height: calc(100% - 32px); min-height: 500px; display: flex; flex-direction: column; padding: 24px; }
        .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
        .section-title { font-size: 1.25rem; font-weight: 800; color: var(--text-white); display: flex; align-items: center; gap: 10px; }
        .section-title i { color: var(--accent-cyan); font-size: 1.5rem;}
        
        .ep-chunk-select { background: var(--bg-glass); border: 1px solid var(--border-glass-strong); color: var(--text-white); border-radius: 8px; padding: 6px 12px; font-size: 0.85rem; font-weight: 600; outline: none; cursor: pointer; transition: var(--transition); backdrop-filter: blur(10px);}
        .ep-chunk-select:hover { border-color: var(--accent-cyan); }
        .ep-chunk-select option { background: var(--bg-main); color: var(--text-white); font-weight: 500;}

        .ep-count { font-size: 0.8rem; font-weight: 600; background: var(--bg-glass-hover); padding: 6px 12px; border-radius: 999px; color: var(--text-white); white-space: nowrap;}
        
        .episodes-grid { flex: 1; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; align-content: start; padding-right: 4px;}
        
        .btn-episode { 
            padding: 12px 4px; border-radius: 12px; font-size: 0.9rem; font-weight: 600;
            background: var(--bg-glass); border: 1px solid var(--border-glass-strong); 
            color: var(--text-muted); transition: var(--transition);
            display: flex; align-items: center; justify-content: center;
        }
        .btn-episode:hover { background: var(--bg-glass-hover); color: var(--text-white); transform: translateY(-2px);}
        .btn-episode.active { 
            background: var(--text-white); color: var(--bg-main); border-color: transparent; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.1); 
        }

        /* ==========================================================================
           8. KHÁM PHÁ (EXPLORE SECTION)
           ========================================================================== */
        .explore-section { padding: 40px 24px 80px; max-width: 1400px; margin: 0 auto;}
        .explore-header { margin-bottom: 32px; display: flex; align-items: center; gap: 16px;}
        .explore-header h2 { font-size: 2rem; font-weight: 900; color: var(--text-white); letter-spacing: -0.5px;}
        
        .genre-tabs { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 16px; scrollbar-width: none; }
        .genre-tabs::-webkit-scrollbar { display: none; }
        .tab-btn { padding: 12px 24px; border-radius: 16px; background: var(--bg-glass); border: 1px solid var(--border-glass-strong); color: var(--text-muted); font-weight: 600; font-size: 0.95rem; white-space: nowrap; transition: var(--transition); }
        .tab-btn:hover { background: var(--bg-glass-hover); color: var(--text-white); }
        .tab-btn.active { background: var(--text-white); color: var(--bg-main); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        
        .tab-btn.recommended { position: relative; border-color: rgba(0, 209, 245, 0.3); color: var(--text-light); }
        .tab-btn.recommended::before { content: ''; position: absolute; top: 8px; right: 8px; width: 6px; height: 6px; background: var(--accent-cyan); border-radius: 50%; box-shadow: 0 0 8px var(--accent-cyan);}
        .tab-btn.recommended.active::before { background: var(--bg-main); box-shadow: none; }

        .anime-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 24px; }
        @media (min-width: 640px) { .anime-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 1024px) { .anime-grid { grid-template-columns: repeat(5, 1fr); gap: 24px;} }

        .anime-card { background: transparent; border-radius: 16px; overflow: hidden; transition: var(--transition); cursor: pointer; display: flex; flex-direction: column; group;}
        .anime-card:hover { transform: translateY(-8px); }
        .ac-thumb { position: relative; width: 100%; aspect-ratio: 2/3; overflow: hidden; background: #1F2937; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);}
        .ac-thumb img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.7s cubic-bezier(0.4, 0, 0.2, 1); }
        .anime-card:hover .ac-thumb img { transform: scale(1.08); }
        .ac-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, transparent 60%); opacity: 0.8; transition: opacity 0.3s;}
        .anime-card:hover .ac-overlay { opacity: 1; }
        
        .ac-ep { position: absolute; top: 12px; right: 12px; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); color: white; font-size: 0.8rem; font-weight: 700; padding: 4px 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);}
        
        .ac-info { padding: 16px 4px 0; flex: 1; display: flex; flex-direction: column;}
        .ac-title { font-size: 1.05rem; font-weight: 800; color: var(--text-white); line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; transition: color 0.3s;}
        .anime-card:hover .ac-title { color: var(--accent-cyan); }
        .ac-year { font-size: 0.85rem; color: var(--text-muted); margin-top: 4px; font-weight: 500;}

        .lazy-loader { text-align: center; padding: 40px 0; color: var(--text-muted); font-weight: 600; display: none; font-size: 1rem;}
        .lazy-loader i { animation: spin 1s linear infinite; display: inline-block; margin-right: 12px; font-size: 1.5rem; color: var(--accent-cyan); vertical-align: middle;}

        /* ==========================================================================
           9. T-STORY (TIKTOK STYLE - LUÔN LÀ DARK MODE)
           ========================================================================== */
        .story-modal { position: fixed; inset: 0; background: #000; z-index: 3000; display: none; flex-direction: column; }
        .story-header { position: absolute; top: 0; left: 0; width: 100%; padding: 24px; display: flex; justify-content: space-between; align-items: center; z-index: 3010; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); }
        .story-logo { font-size: 1.5rem; font-weight: 900; font-style: italic; color: white; text-transform: uppercase;}
        .btn-close-story { color: white; background: rgba(255,255,255,0.1); border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); transition: var(--transition); }
        .btn-close-story:hover { background: rgba(255,255,255,0.2); transform: scale(1.1); }

        .story-container { flex: 1; width: 100%; height: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; scrollbar-width: none; }
        .story-container::-webkit-scrollbar { display: none; }

        .story-item { position: relative; width: 100%; height: 100vh; scroll-snap-align: start; background: #05050A; display: flex; align-items: center; justify-content: center; }
        .story-video-wrapper { position: relative; width: 100%; height: 100%; max-width: 500px; margin: 0 auto; background: #000; }
        @media (max-width: 768px) { .story-video-wrapper { max-width: 100%; } }
        
        .story-video-wrapper iframe { width: 100%; height: 100%; border: none; object-fit: cover; } 
        .story-overlay { position: absolute; inset: 0; z-index: 3005; pointer-events: none; display: flex; flex-direction: column; justify-content: flex-end; padding: 32px 24px; background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.4) 40%, transparent 100%); }
        
        .story-info { flex: 1; display: flex; flex-direction: column; justify-content: flex-end; pointer-events: auto; padding-right: 70px;}
        .story-title { font-size: 1.75rem; font-weight: 900; color: white; margin-bottom: 12px; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .story-desc { font-size: 0.95rem; color: #D1D5DB; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 24px; line-height: 1.5; }
        
        .btn-watch-now { align-self: flex-start; background: #FFF; color: #000; padding: 12px 24px; border-radius: 16px; font-weight: 800; display: flex; align-items: center; gap: 8px; transition: var(--transition); font-size: 1rem;}
        .btn-watch-now:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(255,255,255,0.2); }

        .story-actions { position: absolute; right: 16px; bottom: 100px; display: flex; flex-direction: column; gap: 28px; pointer-events: auto; align-items: center; }
        .action-icon { display: flex; flex-direction: column; align-items: center; gap: 6px; color: white; background: none; border: none; cursor: pointer; transition: var(--transition); }
        .action-icon i { font-size: 2.2rem; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5)); transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .action-icon:hover i { transform: scale(1.15); }
        .action-icon span { font-size: 0.8rem; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.8);}
        
        .action-icon.liked i { color: var(--accent-red); animation: heartPop 0.4s ease; }
        @keyframes heartPop { 0% { transform: scale(1); } 50% { transform: scale(1.5); } 100% { transform: scale(1); } }

        .story-hint { position: absolute; bottom: 24px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; color: rgba(255,255,255,0.4); font-size: 0.8rem; font-weight: 600; pointer-events: none; animation: bounce 2s infinite; }

        /* ==========================================================================
           10. MOBILE OPTIMIZATION (Responsive CSS)
           ========================================================================== */
        @media (max-width: 768px) {
            body { padding-bottom: 70px; } 
            .mobile-bottom-nav { display: flex; }
            .container { padding: 0 16px; }

            .navbar { flex-wrap: wrap; padding: 16px; gap: 16px; }
            .navbar > .flex-center { width: 100%; justify-content: space-between; }
            .nav-logo { font-size: 1.5rem; }
            .nav-links, .btn-story { display: none !important; }
            .user-avatar { width: 38px; height: 38px; }
            
            .search-container { display: block; width: 100%; order: 3; margin-top: -4px;}
            .search-box { width: 100%; padding: 12px 16px; background: var(--bg-glass-hover); }
            .search-dropdown { position: absolute; top: calc(100% + 8px); left: 0; width: 100%; min-width: unset; }

            .user-dropdown { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 360px; z-index: 3000; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }

            .main-content { padding-top: 140px; padding-bottom: 20px; gap: 24px; min-height: auto;}
            .movie-title { font-size: 1.8rem; }
            .action-btns { width: 100%; }
            .btn-action { flex: 1; padding: 14px 10px; font-size: 0.85rem;}
            
            .episodes-box { padding: 16px; border-radius: 20px; min-height: 400px;}
            .section-title { font-size: 1.15rem; }
            .episodes-grid { grid-template-columns: repeat(auto-fill, minmax(65px, 1fr)); gap: 8px; }
            .btn-episode { padding: 10px 4px; font-size: 0.85rem; }

            .explore-section { padding-bottom: 40px; }
            .anime-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
            .explore-header h2 { font-size: 1.6rem; }
            .ac-title { font-size: 0.95rem; }
            .ac-info { padding: 12px 4px 0; }

            .modal-content.onboarding { padding: 32px 20px; border-radius: 24px; }
            .ob-title { font-size: 1.8rem; }
            .ob-grid { gap: 8px; margin-bottom: 24px;}
            .ob-pill { padding: 10px 20px; font-size: 0.85rem; border-radius: 12px;}
            .btn-primary { padding: 14px 30px; font-size: 1rem; }
        }
    </style>
</head>
<body>

    <!-- AMBIENT BACKGROUND -->
    <div id="app-bg"></div>
    <div id="app-bg-overlay"></div>

    <!-- LOADER -->
    <div id="loader" class="flex-center">
        <div class="spinner"></div>
        <div class="loader-text">ĐANG TẢI DỮ LIỆU...</div>
    </div>

    <!-- ONBOARDING MODAL -->
    <div id="onboarding-modal" class="modal-overlay">
        <div class="modal-content onboarding">
            <h2 class="ob-title gradient-text">CHÀO MỪNG ĐẾN T-ANIME</h2>
            <p class="ob-desc">Để Trang đề xuất phim chuẩn gu Hoàng nhất, hãy chọn những thể loại yêu thích nhé!</p>
            <div class="ob-grid" id="ob-genres-grid"></div>
            <button class="btn-primary" id="btn-save-prefs" disabled onclick="savePreferences()">Bắt Đầu Trải Nghiệm</button>
        </div>
    </div>

    <!-- NAVBAR -->
    <nav class="navbar flex-between" id="navbar">
        <div class="flex-center gap-4" style="gap: 40px;">
            <div class="nav-logo cursor-pointer" onclick="window.scrollTo(0,0)">
                <span class="gradient-text">T-ANIME</span>
            </div>
            <ul class="nav-links">
                <li><a href="#" class="active">Trang Chủ</a></li>
                <li><a href="#explore-section">Khám Phá</a></li>
                <li><a href="#">Lịch Chiếu</a></li>
            </ul>
        </div>

        <div class="search-container">
            <div class="search-box">
                <i class="ph ph-magnifying-glass" style="color: var(--text-muted); font-size: 20px;"></i>
                <input type="text" id="search-input" placeholder="Tìm kiếm anime..." autocomplete="off">
            </div>
            <div class="search-dropdown" id="search-dropdown"></div>
        </div>

        <div class="nav-actions">
            <!-- Nút T-Story -->
            <button class="btn-story" onclick="openStoryMode()">
                <i class="ph-fill ph-play-circle"></i> T-Story
            </button>
            
            <button class="btn-icon"><i class="ph ph-bell" style="font-size: 24px;"></i></button>
            
            <!-- Avatar & Menu Dọc Mới -->
            <div class="user-avatar" id="user-avatar-btn">
                <div class="user-avatar-inner"><i class="ph-fill ph-user" style="color: #fff; font-size: 20px;"></i></div>
                
                <div class="user-dropdown" id="user-dropdown">
                    <!-- View Chính Của Menu -->
                    <div id="dropdown-main-view">
                        <div class="dropdown-user-info">
                            <div class="user-avatar-inner" style="width: 48px; height: 48px; flex-shrink: 0;">
                                <i class="ph-fill ph-user" style="color: #fff; font-size: 24px;"></i>
                            </div>
                            <div>
                                <div style="font-weight: 800; font-size: 1.05rem; color: var(--text-white);">Tài Khoản Guest</div>
                                <div style="font-size: 0.8rem; color: var(--accent-cyan); font-weight: 600;">Basic Plan</div>
                            </div>
                        </div>
                        <div class="dropdown-menu-list">
                            <button class="dropdown-menu-item" onclick="event.stopPropagation(); toggleTheme()">
                                <i class="ph-fill ph-moon" id="theme-icon"></i> <span id="theme-text">Giao diện Sáng</span>
                            </button>
                            <button class="dropdown-menu-item" onclick="event.stopPropagation(); openDropdownSubView('theme')">
                                <i class="ph-fill ph-palette" style="color: var(--accent-purple);"></i> Màu Sắc Chủ Đạo
                                <i class="ph-bold ph-caret-right" style="margin-left: auto; font-size: 1rem; color: var(--text-muted);"></i>
                            </button>
                            <button class="dropdown-menu-item" onclick="event.stopPropagation(); openDropdownSubView('fav')">
                                <i class="ph-fill ph-heart" style="color: var(--accent-red);"></i> Phim Yêu Thích
                                <i class="ph-bold ph-caret-right" style="margin-left: auto; font-size: 1rem; color: var(--text-muted);"></i>
                            </button>
                            <button class="dropdown-menu-item" onclick="event.stopPropagation(); openDropdownSubView('history')">
                                <i class="ph-fill ph-clock-counter-clockwise" style="color: var(--accent-yellow);"></i> Lịch Sử Xem
                                <i class="ph-bold ph-caret-right" style="margin-left: auto; font-size: 1rem; color: var(--text-muted);"></i>
                            </button>
                            <button class="dropdown-menu-item" onclick="event.stopPropagation(); openDropdownSubView('download')">
                                <i class="ph-fill ph-download-simple" style="color: var(--accent-cyan);"></i> Đã Tải Xuống
                                <i class="ph-bold ph-caret-right" style="margin-left: auto; font-size: 1rem; color: var(--text-muted);"></i>
                            </button>
                        </div>
                    </div>

                    <!-- View Phụ (Hiển thị danh sách) -->
                    <div id="dropdown-sub-view" style="display: none; flex-direction: column;">
                        <div class="dropdown-sub-header">
                            <button class="btn-back-dropdown" onclick="event.stopPropagation(); closeDropdownSubView()">
                                <i class="ph-bold ph-caret-left"></i>
                            </button>
                            <span id="dropdown-title" class="dropdown-header-title" style="padding:0;">Tiêu đề</span>
                        </div>
                        <div class="user-list-container custom-scrollbar" id="user-list-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- MOBILE BOTTOM NAV -->
    <div class="mobile-bottom-nav">
        <a href="#" class="mobile-nav-item active" id="m-nav-home">
            <i class="ph-fill ph-house"></i>
            <span>Trang Chủ</span>
        </a>
        <a href="#explore-section" class="mobile-nav-item" id="m-nav-explore">
            <i class="ph-fill ph-compass"></i>
            <span>Khám Phá</span>
        </a>
        <div class="mobile-nav-item story" onclick="openStoryMode()">
            <i class="ph-fill ph-play-circle"></i>
            <span>T-Story</span>
        </div>
    </div>

    <!-- PLAYER SECTION (Trang chủ) -->
    <main class="container main-content" id="main-content" style="display: none;">
        <section class="col-left">
            <div class="player-container group">
                <div class="player-glow" id="player-glow"></div>
                <div id="player-wrapper" style="width: 100%; height: 100%;"></div>
            </div>
            <div class="movie-info-panel" id="movie-info-container"></div>
        </section>

        <aside class="col-right">
            <div class="glass-panel episodes-box">
                <div class="section-header">
                    <h3 class="section-title"><i class="ph-fill ph-list-dashes"></i> Danh Sách Tập</h3>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <select id="ep-chunk-select" class="ep-chunk-select" style="display: none;" onchange="changeEpChunk(this.value)"></select>
                        <span class="ep-count" id="ep-count">0 Tập</span>
                    </div>
                </div>
                <div class="episodes-grid custom-scrollbar" id="episodes-grid"></div>
            </div>
        </aside>
    </main>

    <!-- EXPLORE (THỂ LOẠI) SECTION -->
    <section class="container explore-section" id="explore-section" style="display: none;">
        <div class="explore-header">
            <h2>Khám Phá Theo Sở Thích</h2>
        </div>
        <div class="genre-tabs custom-scrollbar" id="genre-tabs-container"></div>
        <div class="anime-grid" id="explore-grid"></div>
        <div class="lazy-loader" id="lazy-loader"><i class="ph-bold ph-spinner-gap"></i> Đang tải thêm dữ liệu...</div>
        <div id="scroll-anchor" style="height: 10px; width: 100%;"></div>
    </section>

    <!-- T-STORY (MÀN HÌNH LƯỚT VIDEO NGẮN) -->
    <div class="story-modal" id="story-modal">
        <div class="story-header">
            <div class="story-logo">T-STORY</div>
            <button class="btn-close-story" onclick="closeStoryMode()"><i class="ph-bold ph-x" style="font-size: 20px;"></i></button>
        </div>
        
        <div class="story-container" id="story-container">
            <div class="story-item flex-center" id="story-loading-init">
                <div class="spinner" style="border-color: rgba(255,255,255,0.2); border-top-color: #fff;"></div>
            </div>
        </div>
    </div>

    <!-- ==========================================================================
         JAVASCRIPT LOGIC
         ========================================================================== -->
    <script>
        // --- XỬ LÝ GIAO DIỆN NAVBAR KHI CUỘN ---
        window.addEventListener('scroll', () => {
            const nav = document.getElementById('navbar');
            if (window.scrollY > 50) nav.classList.add('scrolled');
            else nav.classList.remove('scrolled');

            const exploreSec = document.getElementById('explore-section');
            const mNavHome = document.getElementById('m-nav-home');
            const mNavExplore = document.getElementById('m-nav-explore');
            if (exploreSec && mNavHome && mNavExplore && exploreSec.style.display !== 'none') {
                if (window.scrollY >= exploreSec.offsetTop - 200) {
                    mNavHome.classList.remove('active');
                    mNavExplore.classList.add('active');
                } else {
                    mNavExplore.classList.remove('active');
                    mNavHome.classList.add('active');
                }
            }
        });

        // --- DATA DICTIONARY ---
        const ALL_GENRES = [
            { name: 'Hành Động', slug: 'hanh-dong' }, { name: 'Tình Cảm', slug: 'tinh-cam' },
            { name: 'Hài Hước', slug: 'hai-huoc' }, { name: 'Cổ Trang', slug: 'co-trang' },
            { name: 'Tâm Lý', slug: 'tam-ly' }, { name: 'Hình Sự', slug: 'hinh-su' },
            { name: 'Chiến Tranh', slug: 'chien-tranh' }, { name: 'Thể Thao', slug: 'the-thao' },
            { name: 'Võ Thuật', slug: 'vo-thuat' }, { name: 'Viễn Tưởng', slug: 'vien-tuong' },
            { name: 'Phiêu Lưu', slug: 'phieu-luu' }, { name: 'Khoa Học', slug: 'khoa-hoc' },
            { name: 'Kinh Dị', slug: 'kinh-di' }, { name: 'Âm Nhạc', slug: 'am-nhac' },
            { name: 'Thần Thoại', slug: 'than-thoai' }, { name: 'Tài Liệu', slug: 'tai-lieu' },
            { name: 'Gia Đình', slug: 'gia-dinh' }, { name: 'Chính kịch', slug: 'chinh-kich' },
            { name: 'Bí ẩn', slug: 'bi-an' }, { name: 'Học Đường', slug: 'hoc-duong' },
            { name: 'Kinh Điển', slug: 'kinh-dien' }, { name: 'Phim 18+', slug: 'phim-18' },
            { name: 'Short Drama', slug: 'short-drama' }
        ];

        // --- STATE ---
        let selectedPrefs = new Set(); 
        let userPrefsSlugs = []; 
        let favorites = []; 
        let historyList = [];
        let downloadList = [];
        let currentTab = 'fav';
        
        let currentMovieData = null;
        let currentEpisodesList = [];
        let activeEpisode = null;
        
        let currentEpChunk = 0; 
        const EP_CHUNK_SIZE = 100;

        let exploreState = { currentTabSlug: '', apiPage: 1, localData: [], renderCount: 0, isFetching: false, hasMoreData: true };

        // --- DOM ---
        const ui = {
            appBg: document.getElementById('app-bg'),
            loader: document.getElementById('loader'),
            mainContent: document.getElementById('main-content'),
            exploreSection: document.getElementById('explore-section'),
            onboardingModal: document.getElementById('onboarding-modal'),
            obGrid: document.getElementById('ob-genres-grid'),
            btnSavePrefs: document.getElementById('btn-save-prefs'),
            
            playerWrapper: document.getElementById('player-wrapper'),
            movieInfo: document.getElementById('movie-info-container'),
            epGrid: document.getElementById('episodes-grid'),
            epCount: document.getElementById('ep-count'),
            epChunkSelect: document.getElementById('ep-chunk-select'),
            
            genreTabs: document.getElementById('genre-tabs-container'),
            exploreGrid: document.getElementById('explore-grid'),
            lazyLoader: document.getElementById('lazy-loader'),
            scrollAnchor: document.getElementById('scroll-anchor'),

            avatarBtn: document.getElementById('user-avatar-btn'),
            userDropdown: document.getElementById('user-dropdown'),
            dropdownMainView: document.getElementById('dropdown-main-view'),
            dropdownSubView: document.getElementById('dropdown-sub-view'),
            userListContainer: document.getElementById('user-list-container'),
            themeIcon: document.getElementById('theme-icon'),
            themeText: document.getElementById('theme-text')
        };

        // ==========================================
        // 0. LOGIC THEME (LIGHT/DARK MODE & COLORS)
        // ==========================================
        function initTheme() {
            const theme = localStorage.getItem('tanime_theme') || 'dark';
            if (theme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
                ui.themeIcon.className = 'ph-fill ph-moon';
                ui.themeText.textContent = 'Giao diện Tối';
            }

            const color = localStorage.getItem('tanime_color') || 'default';
            if (color !== 'default') {
                document.documentElement.setAttribute('data-color', color);
            }
        }

        window.toggleTheme = () => {
            const current = document.documentElement.getAttribute('data-theme');
            if (current === 'light') {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('tanime_theme', 'dark');
                ui.themeIcon.className = 'ph-fill ph-sun';
                ui.themeText.textContent = 'Giao diện Sáng';
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                localStorage.setItem('tanime_theme', 'light');
                ui.themeIcon.className = 'ph-fill ph-moon';
                ui.themeText.textContent = 'Giao diện Tối';
            }
        };

        // ==========================================
        // 1. QUẢN LÝ USER DATA (FAV, HISTORY, DOWNLOAD)
        // ==========================================
        function loadUserData() {
            const savedFavs = localStorage.getItem('tanime_favorites');
            if (savedFavs) favorites = JSON.parse(savedFavs);
            
            const savedHistory = localStorage.getItem('tanime_history');
            if (savedHistory) historyList = JSON.parse(savedHistory);

            const savedDownloads = localStorage.getItem('tanime_downloads');
            if (savedDownloads) downloadList = JSON.parse(savedDownloads);
        }

        window.openDropdownSubView = (tab) => {
            currentTab = tab;
            const titles = { 'fav': 'Phim Yêu Thích', 'history': 'Lịch Sử Xem', 'download': 'Đã Tải Xuống', 'theme': 'Màu Sắc Chủ Đạo' };
            document.getElementById('dropdown-title').textContent = titles[tab];
            
            ui.dropdownMainView.style.display = 'none';
            ui.dropdownSubView.style.display = 'flex';
            
            renderUserDropdown();
        };

        window.closeDropdownSubView = () => {
            ui.dropdownSubView.style.display = 'none';
            ui.dropdownMainView.style.display = 'block';
        };

        function toggleFavorite(movieObj) {
            const index = favorites.findIndex(f => f.slug === movieObj.slug);
            if (index > -1) {
                favorites.splice(index, 1); 
            } else {
                favorites.unshift({ slug: movieObj.slug, name: movieObj.name, thumb_url: movieObj.thumb_url });
            }
            localStorage.setItem('tanime_favorites', JSON.stringify(favorites));
            if(currentTab === 'fav') renderUserDropdown();
            if (currentMovieData && currentMovieData.slug === movieObj.slug) renderMovieInfo(); 
            return index === -1; 
        }

        function addToHistory(movie, episode) {
            if (!movie || !episode) return;
            const now = new Date();
            const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')} - ${now.getDate()}/${now.getMonth()+1}/${now.getFullYear()}`;
            
            historyList = historyList.filter(h => h.slug !== movie.slug);
            historyList.unshift({
                slug: movie.slug,
                name: movie.name,
                thumb_url: movie.thumb_url,
                epName: episode.name,
                time: timeStr
            });
            
            if (historyList.length > 30) historyList.pop(); // Max 30
            localStorage.setItem('tanime_history', JSON.stringify(historyList));
            if (currentTab === 'history') renderUserDropdown();
        }

        function renderUserDropdown() {
            if (currentTab === 'theme') {
                const themes = [
                    { id: 'default', color1: '#B026FF', color2: '#00D1F5', name: 'Cyberpunk' },
                    { id: 'emerald', color1: '#10b981', color2: '#14b8a6', name: 'Emerald' },
                    { id: 'blue', color1: '#3b82f6', color2: '#6366f1', name: 'Ocean' },
                    { id: 'rose', color1: '#f43f5e', color2: '#f97316', name: 'Sunset' },
                    { id: 'amber', color1: '#f59e0b', color2: '#ef4444', name: 'Volcano' }
                ];
                const currentTheme = localStorage.getItem('tanime_color') || 'default';
                ui.userListContainer.innerHTML = `
                    <div style="display:flex; flex-wrap:wrap; gap:16px; padding: 20px 12px; justify-content:center;">
                        ${themes.map(t => `
                            <div title="${t.name}" class="theme-swatch ${currentTheme === t.id ? 'active' : ''}" 
                                 style="background: linear-gradient(135deg, ${t.color1}, ${t.color2}); width: 44px; height: 44px; border-radius: 50%; cursor:pointer; border: 3px solid ${currentTheme === t.id ? 'var(--text-white)' : 'transparent'}; box-shadow: ${currentTheme === t.id ? '0 0 15px ' + t.color1 : 'none'};"
                                 onclick="event.stopPropagation(); changeColorTheme('${t.id}')">
                            </div>
                        `).join('')}
                    </div>
                    <div style="padding: 0 20px 20px; text-align: center; color: var(--text-muted); font-size: 0.85rem;">
                        Chọn một dải màu để cá nhân hóa toàn bộ giao diện của bạn.
                    </div>
                `;
                return;
            }

            let data = [];
            let emptyMsg = "";
            let onRemove = "";
            
            if (currentTab === 'fav') {
                data = favorites; emptyMsg = "Bạn chưa lưu bộ phim nào."; onRemove = "removeFromFav";
            } else if (currentTab === 'history') {
                data = historyList; emptyMsg = "Bạn chưa xem bộ phim nào."; onRemove = "removeFromHistory";
            } else if (currentTab === 'download') {
                data = downloadList; emptyMsg = "Chưa có tập phim nào được tải."; onRemove = "removeFromDownloads";
            }

            if (data.length === 0) {
                ui.userListContainer.innerHTML = `<div class="list-empty">${emptyMsg}</div>`;
                return;
            }
            
            ui.userListContainer.innerHTML = data.map((item, index) => `
                <div class="list-item" onclick="loadMovieDetailAndScroll('${item.slug}'); document.getElementById('user-dropdown').style.display='none'; closeDropdownSubView();">
                    <div class="list-thumb"><img src="${item.thumb_url.startsWith('http') ? item.thumb_url : 'https://img.ophim.live/uploads/movies/' + item.thumb_url}" onerror="this.src='https://via.placeholder.com/44x60/1F2937/00D1F5'"></div>
                    <div class="list-info">
                        <div class="list-title">${item.name}</div>
                        ${item.epName ? `<div class="list-subtitle">${item.epName}</div>` : ''}
                        ${item.time ? `<div class="list-time">${item.time}</div>` : ''}
                    </div>
                    <button class="btn-remove-list" onclick="event.stopPropagation(); window.${onRemove}(${index})">
                        <i class="ph-fill ph-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        window.removeFromFav = (idx) => { favorites.splice(idx, 1); localStorage.setItem('tanime_favorites', JSON.stringify(favorites)); renderUserDropdown(); if (currentMovieData) renderMovieInfo(); };
        window.removeFromHistory = (idx) => { historyList.splice(idx, 1); localStorage.setItem('tanime_history', JSON.stringify(historyList)); renderUserDropdown(); };
        window.removeFromDownloads = (idx) => { downloadList.splice(idx, 1); localStorage.setItem('tanime_downloads', JSON.stringify(downloadList)); renderUserDropdown(); };

        window.changeColorTheme = (themeId) => {
            document.documentElement.setAttribute('data-color', themeId);
            localStorage.setItem('tanime_color', themeId);
            renderUserDropdown(); // Cập nhật lại UI bảng màu
        };

        ui.avatarBtn.addEventListener('click', (e) => {
            const dp = ui.userDropdown;
            dp.style.display = dp.style.display === 'flex' ? 'none' : 'flex';
        });
        document.addEventListener('click', (e) => {
            if (!ui.avatarBtn.contains(e.target) && !ui.userDropdown.contains(e.target)) {
                ui.userDropdown.style.display = 'none';
                closeDropdownSubView(); // Đóng menu sổ ra thì auto reset về màn chính
            }
        });

        // ==========================================
        // 2. ONBOARDING & PREFERENCES
        // ==========================================
        function checkOnboarding() {
            initTheme();
            loadUserData(); 
            const saved = localStorage.getItem('tanime_prefs');
            if (saved) {
                userPrefsSlugs = JSON.parse(saved);
                initApp(); 
            } else {
                renderOnboarding();
                ui.loader.style.display = 'none';
                ui.onboardingModal.style.display = 'flex';
            }
        }

        function renderOnboarding() {
            ui.obGrid.innerHTML = ALL_GENRES.map(g => `
                <div class="ob-pill" data-slug="${g.slug}" onclick="togglePref(this)">${g.name}</div>
            `).join('');
        }

        window.togglePref = (el) => {
            const slug = el.getAttribute('data-slug');
            if (selectedPrefs.has(slug)) {
                selectedPrefs.delete(slug);
                el.classList.remove('active');
            } else {
                selectedPrefs.add(slug);
                el.classList.add('active');
            }
            ui.btnSavePrefs.disabled = selectedPrefs.size === 0;
        };

        window.savePreferences = () => {
            userPrefsSlugs = Array.from(selectedPrefs);
            localStorage.setItem('tanime_prefs', JSON.stringify(userPrefsSlugs));
            ui.onboardingModal.style.display = 'none';
            ui.loader.style.display = 'flex';
            initApp();
        };

        // ==========================================
        // 3. KHỞI TẠO APP VÀ TẢI PHIM CHÍNH
        // ==========================================
        async function initApp() {
            try {
                const res = await fetch('https://ophim1.com/v1/api/danh-sach/hoat-hinh?page=1');
                const data = await res.json();
                
                if (data.status === 'success' && data.data.items.length > 0) {
                    await loadMovieDetail(data.data.items[0].slug);
                }
                
                renderGenreTabs();
                const initialTab = userPrefsSlugs.length > 0 ? userPrefsSlugs[0] : ALL_GENRES[0].slug;
                switchTab(initialTab);

                ui.mainContent.style.display = 'grid';
                ui.exploreSection.style.display = 'block';
            } catch (error) {
                console.error(error);
            } finally {
                ui.loader.style.display = 'none';
            }
        }

        async function loadMovieDetail(slug) {
            try {
                const res = await fetch(`https://ophim1.com/phim/${slug}`);
                const data = await res.json();

                if (data.status) {
                    currentEpChunk = 0; 
                    
                    currentMovieData = data.movie;
                    currentEpisodesList = data.episodes[0]?.server_data || [];
                    activeEpisode = currentEpisodesList.length > 0 ? currentEpisodesList[0] : null;

                    const bgUrl = `https://img.ophim.live/uploads/movies/${currentMovieData.poster_url || currentMovieData.thumb_url}`;
                    ui.appBg.style.backgroundImage = `url('${bgUrl}')`;

                    renderPlayer();
                    renderMovieInfo();
                    renderEpisodes();
                }
            } catch (error) { console.error(error); }
        }

        function renderPlayer() {
            if (activeEpisode) {
                ui.playerWrapper.innerHTML = `<iframe src="${activeEpisode.link_embed}" allowfullscreen title="Anime Player"></iframe>`;
            } else {
                ui.playerWrapper.innerHTML = `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#4B5563;"><i class="ph-bold ph-monitor-play" style="font-size:48px;animation:pulse 2s infinite;"></i></div>`;
            }
        }

        function renderMovieInfo() {
            const m = currentMovieData;
            const plainContent = m.content ? m.content.replace(/<[^>]*>?/gm, '').substring(0, 400) + '...' : '';
            const isLiked = favorites.some(f => f.slug === m.slug);
            
            ui.movieInfo.innerHTML = `
                <div class="info-header">
                    <h1 class="movie-title">${m.name}</h1>
                    <div class="action-btns">
                        <button class="btn-action save ${isLiked ? 'saved' : ''}" onclick="toggleFavoriteFromMain()">
                            <i class="${isLiked ? 'ph-fill' : 'ph-bold'} ph-heart"></i> ${isLiked ? 'Đã Lưu' : 'Lưu Phim'}
                        </button>
                        <button class="btn-action" id="btn-download" onclick="downloadCurrentEpisode()">
                            <i class="ph-bold ph-download-simple"></i> Tải Tập Này
                        </button>
                        <button class="btn-action share" onclick="shareStory()"><i class="ph-bold ph-share-network"></i> Chia sẻ</button>
                    </div>
                </div>
                <div class="meta-tags">
                    <span class="tag-rating"><i class="ph-fill ph-star"></i> ${m.tmdb?.vote_average || '9.5'}</span>
                    <span class="tag-box">${m.quality || 'FHD'}</span>
                    <span class="tag-box">${m.lang || 'Vietsub'}</span>
                    <span class="tag-box">${m.year}</span>
                    <span style="color: var(--text-muted);">${m.time || '24 Phút/Tập'}</span>
                </div>
                <div class="movie-desc">${plainContent}</div>
            `;
        }

        window.toggleFavoriteFromMain = () => {
            if (currentMovieData) {
                toggleFavorite({ slug: currentMovieData.slug, name: currentMovieData.name, thumb_url: currentMovieData.thumb_url });
            }
        };

        function renderEpisodes() {
            ui.epCount.textContent = `${currentEpisodesList.length} Tập`;
            const totalChunks = Math.ceil(currentEpisodesList.length / EP_CHUNK_SIZE);
            
            if (totalChunks > 1) {
                ui.epChunkSelect.style.display = 'block';
                ui.epChunkSelect.innerHTML = Array.from({length: totalChunks}).map((_, i) => {
                    const start = i * EP_CHUNK_SIZE + 1;
                    const end = Math.min((i + 1) * EP_CHUNK_SIZE, currentEpisodesList.length);
                    return `<option value="${i}" ${i === currentEpChunk ? 'selected' : ''}>Tập ${start} - ${end}</option>`;
                }).join('');
            } else {
                ui.epChunkSelect.style.display = 'none';
            }

            const startIdx = currentEpChunk * EP_CHUNK_SIZE;
            const endIdx = startIdx + EP_CHUNK_SIZE;
            const episodesToRender = currentEpisodesList.slice(startIdx, endIdx);

            ui.epGrid.innerHTML = episodesToRender.map((ep, idx) => {
                const realIdx = startIdx + idx; 
                const isActive = activeEpisode && activeEpisode.slug === ep.slug;
                return `<button class="btn-episode ${isActive ? 'active' : ''}" onclick="selectEpisode(${realIdx})">${isActive ? '<i class="ph-fill ph-play" style="margin-right:4px;"></i>' : ''}${ep.name}</button>`;
            }).join('');
        }

        window.changeEpChunk = (chunkIdx) => {
            currentEpChunk = parseInt(chunkIdx);
            renderEpisodes();
        };

        window.selectEpisode = (idx) => {
            activeEpisode = currentEpisodesList[idx];
            currentEpChunk = Math.floor(idx / EP_CHUNK_SIZE); 
            renderPlayer(); 
            renderEpisodes();
            addToHistory(currentMovieData, activeEpisode);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // --- THUẬT TOÁN TẢI TỪNG CHUNK .TS VÀ GHÉP FILE ---
        window.downloadCurrentEpisode = async () => {
            if (!currentMovieData || !activeEpisode) return;
            const btn = document.getElementById('btn-download');
            
            if (btn.classList.contains('downloading')) return;
            
            const m3u8Link = activeEpisode.link_m3u8;
            if (!m3u8Link) {
                alert("Lỗi: Không tìm thấy link tải (m3u8) cho tập phim này!");
                return;
            }

            btn.classList.add('downloading');
            btn.innerHTML = `<i class="ph-bold ph-spinner-gap" style="animation: spin 1s linear infinite;"></i> Đang phân tích...`;
            
            try {
                // Hàm tiện ích tải file dạng text
                const fetchText = async (url) => {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error('Network response was not ok');
                    return await res.text();
                };

                // Bước 1: Lấy nội dung file m3u8 (Có thể là Master Playlist hoặc Media Playlist)
                let manifest = await fetchText(m3u8Link);
                let baseUrl = m3u8Link.substring(0, m3u8Link.lastIndexOf('/') + 1);

                // Bước 2: Nếu là Master Playlist (chứa nhiều độ phân giải), tìm chất lượng cao nhất
                if (manifest.includes('#EXT-X-STREAM-INF')) {
                    const lines = manifest.split('\n');
                    let bestResolutionUrl = '';
                    for (let i = 0; i < lines.length; i++) {
                        if (lines[i].includes('#EXT-X-STREAM-INF')) {
                            let nextLine = lines[i+1].trim();
                            if (nextLine) bestResolutionUrl = nextLine;
                        }
                    }
                    if (bestResolutionUrl) {
                        if (!bestResolutionUrl.startsWith('http')) {
                            bestResolutionUrl = baseUrl + bestResolutionUrl;
                        }
                        manifest = await fetchText(bestResolutionUrl);
                        baseUrl = bestResolutionUrl.substring(0, bestResolutionUrl.lastIndexOf('/') + 1);
                    }
                }

                // Bước 3: Đọc và gom lại tất cả các URL đoạn video đuôi .ts
                const tsUrls = [];
                const lines = manifest.split('\n');
                for (let line of lines) {
                    line = line.trim();
                    // Các file ts không bắt đầu bằng '#'
                    if (line && !line.startsWith('#')) {
                        tsUrls.push(line.startsWith('http') ? line : baseUrl + line);
                    }
                }

                if (tsUrls.length === 0) throw new Error("Không tìm thấy dữ liệu video chunk!");

                // Bước 4: Tải song song từng cụm file (Batch downloading) để tăng tốc và tránh đơ
                const chunks = new Array(tsUrls.length);
                let downloadedCount = 0;
                const batchSize = 5; // Tải 5 đoạn cùng một lúc

                for (let i = 0; i < tsUrls.length; i += batchSize) {
                    const batch = tsUrls.slice(i, i + batchSize);
                    const promises = batch.map(async (url, idx) => {
                        const res = await fetch(url);
                        if (!res.ok) throw new Error(`Lỗi tải đoạn video ${i + idx}`);
                        const buffer = await res.arrayBuffer(); // Tải dưới dạng nhị phân thô
                        return { index: i + idx, buffer };
                    });

                    // Chờ cụm 5 file tải xong rồi mới lưu mảng
                    const results = await Promise.all(promises);
                    for (const r of results) {
                        chunks[r.index] = r.buffer;
                    }
                    
                    downloadedCount += batch.length;
                    const percent = Math.floor((downloadedCount / tsUrls.length) * 100);
                    btn.innerHTML = `<i class="ph-bold ph-spinner-gap" style="animation: spin 1s linear infinite;"></i> Đang tải ${percent}%`;
                }

                // Bước 5: Ghép tất cả các đoạn .ts lại thành một file Blob duy nhất
                btn.innerHTML = `<i class="ph-bold ph-spinner-gap" style="animation: spin 1s linear infinite;"></i> Đang ghép video...`;
                const blob = new Blob(chunks, { type: 'video/mp2t' });
                const url = window.URL.createObjectURL(blob);
                
                // Bước 6: Kích hoạt tự động tải xuống file Video
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                // Định dạng file là .ts (đọc được bằng VLC, Windows Media Player)
                a.download = `${currentMovieData.slug}-tap-${activeEpisode.name}.ts`;
                document.body.appendChild(a);
                a.click();
                
                // Dọn dẹp bộ nhớ đệm
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // Lưu vào mục "Đã tải xuống"
                const exists = downloadList.some(d => d.slug === currentMovieData.slug && d.epName === activeEpisode.name);
                if (!exists) {
                    const now = new Date();
                    const timeStr = `${now.getDate()}/${now.getMonth()+1}/${now.getFullYear()}`;
                    downloadList.unshift({
                        slug: currentMovieData.slug,
                        name: currentMovieData.name,
                        thumb_url: currentMovieData.thumb_url,
                        epName: activeEpisode.name,
                        time: `Đã tải: ${timeStr}`
                    });
                    localStorage.setItem('tanime_downloads', JSON.stringify(downloadList));
                    if (currentTab === 'download') renderUserDropdown();
                }
                
                btn.classList.remove('downloading');
                btn.innerHTML = `<i class="ph-bold ph-check"></i> Đã Tải Xong`;
                setTimeout(() => {
                    if (btn) btn.innerHTML = `<i class="ph-bold ph-download-simple"></i> Tải Tập Này`;
                }, 3000);
                
            } catch (error) {
                console.error("Lỗi tải video .ts:", error);
                // Bước 7: Fallback - Giải pháp dự phòng nếu bị máy chủ chặn kết nối CORS
                if (confirm("Quá trình tải ghép file bị lỗi mạng (hoặc do máy chủ chặn). Bạn có muốn mở Link tải gốc ở Tab mới để dùng IDM / Cốc Cốc bắt link không?")) {
                    const a = document.createElement('a');
                    a.href = m3u8Link;
                    a.target = '_blank';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                }
                btn.classList.remove('downloading');
                btn.innerHTML = `<i class="ph-bold ph-download-simple"></i> Tải Tập Này`;
            }
        };

        // ==========================================
        // 4. LOGIC EXPLORE
        // ==========================================
        function renderGenreTabs() {
            const sortedGenres = [...ALL_GENRES].sort((a, b) => {
                const aPref = userPrefsSlugs.includes(a.slug);
                const bPref = userPrefsSlugs.includes(b.slug);
                return bPref - aPref;
            });

            ui.genreTabs.innerHTML = sortedGenres.map(g => {
                const isRecommended = userPrefsSlugs.includes(g.slug);
                return `<button class="tab-btn ${isRecommended ? 'recommended' : ''}" id="tab-${g.slug}" onclick="switchTab('${g.slug}')">${g.name}</button>`;
            }).join('');
        }

        window.switchTab = async (slug) => {
            if (exploreState.currentTabSlug === slug) return;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const activeTab = document.getElementById(`tab-${slug}`);
            if(activeTab) {
                activeTab.classList.add('active');
                activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }

            exploreState = { currentTabSlug: slug, apiPage: 1, localData: [], renderCount: 0, isFetching: false, hasMoreData: true };
            ui.exploreGrid.innerHTML = '';
            await fetchMoreGenreData();
        };

        async function fetchMoreGenreData() {
            if (exploreState.isFetching || !exploreState.hasMoreData) return;
            exploreState.isFetching = true;
            ui.lazyLoader.style.display = 'block';

            try {
                const res = await fetch(`https://ophim1.com/v1/api/the-loai/${exploreState.currentTabSlug}?page=${exploreState.apiPage}`);
                const data = await res.json();

                if (data.status === 'success' && data.data.items.length > 0) {
                    exploreState.localData.push(...data.data.items);
                    exploreState.apiPage++;
                    append10ItemsToGrid();
                } else {
                    exploreState.hasMoreData = false;
                }
            } catch (error) { console.error(error); } 
            finally {
                exploreState.isFetching = false;
                ui.lazyLoader.style.display = 'none';
            }
        }

        function append10ItemsToGrid() {
            const nextIndex = exploreState.renderCount;
            const itemsToRender = exploreState.localData.slice(nextIndex, nextIndex + 10);
            
            if (itemsToRender.length === 0) {
                if(exploreState.hasMoreData) fetchMoreGenreData();
                return;
            }

            const html = itemsToRender.map(item => `
                <div class="anime-card" onclick="loadMovieDetailAndScroll('${item.slug}')">
                    <div class="ac-thumb">
                        <img src="https://img.ophim.live/uploads/movies/${item.thumb_url}" onerror="this.src='https://via.placeholder.com/200x300/1F2937/00D1F5?text=No+Image'">
                        <div class="ac-overlay"></div>
                        <div class="ac-ep">${item.episode_current || 'Tập 1'}</div>
                    </div>
                    <div class="ac-info">
                        <div class="ac-title">${item.name}</div>
                        <div class="ac-year">${item.year}</div>
                    </div>
                </div>
            `).join('');

            ui.exploreGrid.insertAdjacentHTML('beforeend', html);
            exploreState.renderCount += itemsToRender.length;
        }

        window.loadMovieDetailAndScroll = (slug) => {
            loadMovieDetail(slug);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting) {
                if (exploreState.renderCount >= exploreState.localData.length) {
                    fetchMoreGenreData();
                } else {
                    append10ItemsToGrid();
                }
            }
        }, { rootMargin: '0px 0px 400px 0px' });
        observer.observe(ui.scrollAnchor);

        // ==========================================
        // 5. SEARCH
        // ==========================================
        let searchTimeout;
        const searchInput = document.getElementById('search-input');
        const searchDropdown = document.getElementById('search-dropdown');
        
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            clearTimeout(searchTimeout);
            if (!query) { searchDropdown.style.display = 'none'; return; }
            searchDropdown.style.display = 'block';
            searchDropdown.innerHTML = `<div class="search-msg"><i class="ph-bold ph-spinner-gap" style="animation:spin 1s linear infinite;"></i> Đang tìm kiếm...</div>`;
            searchTimeout = setTimeout(() => executeSearch(query), 500);
        });

        async function executeSearch(query) {
            try {
                const res = await fetch(`https://ophim1.com/v1/api/tim-kiem?keyword=${encodeURIComponent(query)}`);
                const data = await res.json();
                if (data.status === 'success' && data.data.items.length > 0) {
                    searchDropdown.innerHTML = data.data.items.map(item => `
                        <div class="search-item" onclick="loadMovieDetailAndScroll('${item.slug}'); document.getElementById('search-dropdown').style.display='none';">
                            <div class="search-thumb"><img src="https://img.ophim.live/uploads/movies/${item.thumb_url}"></div>
                            <div class="search-info">
                                <div class="search-title">${item.name}</div>
                                <div class="search-origin">${item.origin_name}</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    searchDropdown.innerHTML = `<div class="search-msg">Không tìm thấy phim.</div>`;
                }
            } catch (error) { console.error(error); }
        }

        // ==========================================
        // 6. T-STORY LOGIC
        // ==========================================
        const storyDOM = {
            modal: document.getElementById('story-modal'),
            container: document.getElementById('story-container'),
            loadingInit: document.getElementById('story-loading-init')
        };

        let storyCache = []; 
        let isLoadingStory = false;
        let storyObserver;
        let videoPlaybackObserver;

        window.openStoryMode = () => {
            document.body.classList.add('modal-open');
            storyDOM.modal.style.display = 'flex';
            if (storyCache.length === 0) {
                initStoryObserver();
                loadMoreStories(3);
            }
        };

        window.closeStoryMode = () => {
            document.body.classList.remove('modal-open');
            storyDOM.modal.style.display = 'none';
            const iframes = storyDOM.container.querySelectorAll('iframe');
            iframes.forEach(iframe => iframe.src = '');
        };

        function initStoryObserver() {
            storyObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && entry.target.dataset.isLast === 'true') {
                        entry.target.dataset.isLast = 'false'; 
                        loadMoreStories(2);
                    }
                });
            }, { threshold: 0.5 });

            videoPlaybackObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const iframe = entry.target.querySelector('iframe');
                    if (!iframe) return;
                    if (entry.isIntersecting) {
                        if (!iframe.src || iframe.src === window.location.href || iframe.src === 'about:blank') {
                            iframe.src = iframe.dataset.src;
                        }
                    } else {
                        iframe.src = '';
                    }
                });
            }, { threshold: 0.6 }); 
        }

        async function loadMoreStories(count) {
            if (isLoadingStory) return;
            isLoadingStory = true;

            try {
                const randomPage = Math.floor(Math.random() * 50) + 1;
                const listRes = await fetch(`https://ophim1.com/v1/api/danh-sach/hoat-hinh?page=${randomPage}`);
                const listData = await listRes.json();
                
                if (listData.status === 'success') {
                    const items = listData.data.items.sort(() => 0.5 - Math.random()).slice(0, count);
                    
                    for (const item of items) {
                        const detailRes = await fetch(`https://ophim1.com/phim/${item.slug}`);
                        const detailData = await detailRes.json();
                        
                        if (detailData.status && detailData.episodes[0]?.server_data.length > 0) {
                            const m = detailData.movie;
                            const eps = detailData.episodes[0].server_data;
                            const randomEp = eps[Math.floor(Math.random() * eps.length)];
                            
                            const storyObj = {
                                slug: m.slug,
                                name: m.name,
                                content: m.content ? m.content.replace(/<[^>]*>?/gm, '').substring(0, 150) + '...' : '',
                                thumb_url: m.thumb_url,
                                poster_url: m.poster_url,
                                link: randomEp.link_embed, 
                                isLiked: favorites.some(f => f.slug === m.slug)
                            };
                            
                            storyCache.push(storyObj);
                            appendStoryToDOM(storyObj);
                        }
                    }
                }
            } catch (error) { console.error(error); } 
            finally {
                isLoadingStory = false;
                if(storyDOM.loadingInit) storyDOM.loadingInit.style.display = 'none'; 
            }
        }

        function appendStoryToDOM(story) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'story-item';
            
            const safeObjStr = JSON.stringify({slug: story.slug, name: story.name, thumb_url: story.thumb_url}).replace(/"/g, '&quot;');
            const previewImg = `https://img.ophim.live/uploads/movies/${story.poster_url || story.thumb_url}`;

            itemDiv.innerHTML = `
                <div class="story-video-wrapper" style="background: url('${previewImg}') center/cover no-repeat;">
                    <iframe data-src="${story.link}" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                    <div class="story-overlay">
                        <div class="story-info">
                            <h3 class="story-title">${story.name}</h3>
                            <p class="story-desc">${story.content}</p>
                            <button class="btn-watch-now" onclick="watchFromStory('${story.slug}')">
                                <i class="ph-fill ph-play"></i> Xem Full Bộ
                            </button>
                        </div>
                    </div>
                    <div class="story-actions">
                        <button class="action-icon ${story.isLiked ? 'liked' : ''}" onclick="toggleStoryLike(this, ${safeObjStr})">
                            <i class="${story.isLiked ? 'ph-fill' : 'ph-bold'} ph-heart"></i>
                            <span>Thích</span>
                        </button>
                        <button class="action-icon" onclick="shareStory()">
                            <i class="ph-fill ph-share-fat"></i>
                            <span>Chia sẻ</span>
                        </button>
                    </div>
                </div>
                <div class="story-hint"><i class="ph-bold ph-caret-up"></i> Vuốt xem tiếp</div>
            `;
            
            storyDOM.container.appendChild(itemDiv);
            
            itemDiv.dataset.isLast = 'true';
            storyObserver.observe(itemDiv);
            videoPlaybackObserver.observe(itemDiv); 
        }

        window.toggleStoryLike = (btnElement, movieObj) => {
            const isAdded = toggleFavorite(movieObj); 
            if (isAdded) {
                btnElement.classList.add('liked');
                btnElement.querySelector('i').classList.remove('ph-bold');
                btnElement.querySelector('i').classList.add('ph-fill');
            } else {
                btnElement.classList.remove('liked');
                btnElement.querySelector('i').classList.remove('ph-fill');
                btnElement.querySelector('i').classList.add('ph-bold');
            }
        };

        window.watchFromStory = (slug) => { closeStoryMode(); loadMovieDetailAndScroll(slug); };
        window.shareStory = () => { alert("Đã copy link phim vào khay nhớ tạm!"); };

        // Init
        window.onload = checkOnboarding;

    </script>
</body>
</html>
