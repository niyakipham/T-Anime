<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>T-ANIME | Premium Streaming Dashboard</title>
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* ==========================================================================
           1. CSS VARIABLES & THEME
           ========================================================================== */
        :root {
            --bg-main: #0A0F1C;
            --bg-sidebar: rgba(13, 19, 33, 0.8);
            --bg-card: rgba(22, 30, 49, 0.5);
            --bg-glass: rgba(255, 255, 255, 0.03);
            --bg-glass-hover: rgba(255, 255, 255, 0.06);
            
            --text-light: #F8FAFC;
            --text-muted: #64748B;
            --text-white: #FFFFFF;
            
            --accent-purple: #2563EB; 
            --accent-cyan: #06B6D4;
            --accent-yellow: #F59E0B;
            --accent-red: #E11D48;

            --border-glass: rgba(255, 255, 255, 0.05);
            --border-glass-strong: rgba(255, 255, 255, 0.1);
            --border-bevel: 1px solid rgba(255, 255, 255, 0.08);

            --shadow-glow: 0 10px 25px -5px rgba(6, 182, 212, 0.4);
            --shadow-glow-blue: 0 10px 25px -5px rgba(37, 99, 235, 0.5);
            --shadow-panel: 0 20px 40px -10px rgba(0, 0, 0, 0.6);
            --shadow-inner: inset 0 2px 4px rgba(0, 0, 0, 0.3);
            
            --font-main: 'Plus Jakarta Sans', sans-serif;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --sidebar-width: 260px; 
        }

        [data-theme="light"] {
            --bg-main: #F1F5F9; --bg-sidebar: rgba(255,255,255,0.9); --bg-card: rgba(255,255,255,0.7);
            --bg-glass: rgba(0,0,0,0.03); --bg-glass-hover: rgba(0,0,0,0.06);
            --text-light: #0F172A; --text-muted: #64748B; --text-white: #000000;
            --border-glass: rgba(0,0,0,0.05); --border-glass-strong: rgba(0,0,0,0.1); --border-bevel: 1px solid rgba(255,255,255,0.5);
            --shadow-panel: 0 20px 40px -10px rgba(0,0,0,0.08);
        }

        [data-color="emerald"] { --accent-purple: #059669; --accent-cyan: #10B981; --shadow-glow: 0 10px 25px -5px rgba(16,185,129,0.4); --shadow-glow-blue: 0 10px 25px -5px rgba(5,150,105,0.4);}
        [data-color="rose"] { --accent-purple: #BE123C; --accent-cyan: #F43F5E; --shadow-glow: 0 10px 25px -5px rgba(244,63,94,0.4); --shadow-glow-blue: 0 10px 25px -5px rgba(190,18,60,0.4);}
        [data-color="amber"] { --accent-purple: #D97706; --accent-cyan: #F59E0B; --shadow-glow: 0 10px 25px -5px rgba(245,158,11,0.4); --shadow-glow-blue: 0 10px 25px -5px rgba(217,119,6,0.4);}
        [data-color="purple"] { --accent-purple: #7C3AED; --accent-cyan: #A855F7; --shadow-glow: 0 10px 25px -5px rgba(168,85,247,0.4); --shadow-glow-blue: 0 10px 25px -5px rgba(124,58,237,0.4);}

        /* ==========================================================================
           2. BASE & RESET
           ========================================================================== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { overflow-x: hidden; width: 100%; position: relative; background-color: var(--bg-main);}
        html { font-size: 15px; }
        @media (max-width: 1024px) { html { font-size: 14px; } }
        @media (max-width: 768px) { html { font-size: 13.5px; } }

        body { font-family: var(--font-main); color: var(--text-light); line-height: 1.6; scroll-behavior: smooth; transition: background-color 0.5s ease; -webkit-tap-highlight-color: transparent;}
        body.modal-open { overflow: hidden; }
        ::selection { background-color: var(--accent-cyan); color: #000; }
        a { text-decoration: none; color: inherit; }
        button { border: none; background: none; cursor: pointer; font-family: inherit; outline: none; }
        ul { list-style: none; }
        img { max-width: 100%; height: auto; display: block; }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.15); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-cyan); }

        #app-bg { position: fixed; inset: 0; z-index: -2; background: radial-gradient(circle at 15% 10%, rgba(37, 99, 235, 0.08), transparent 40%), radial-gradient(circle at 85% 60%, rgba(6, 182, 212, 0.08), transparent 40%); transition: background 1.5s ease; }
        
        .gradient-text { background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan)); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        .flex-between { display: flex; align-items: center; justify-content: space-between; }
        
        .glass-panel { background: var(--bg-card); border: var(--border-glass); border-top: var(--border-bevel); border-left: var(--border-bevel); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border-radius: 24px; box-shadow: var(--shadow-panel); }

        #loader { position: fixed; inset: 0; background: var(--bg-main); z-index: 9999; flex-direction: column; }
        .spinner { width: 48px; height: 48px; border: 3px solid rgba(255,255,255,0.05); border-top-color: var(--accent-cyan); border-radius: 50%; animation: spin 1s cubic-bezier(0.55, 0.085, 0.68, 0.53) infinite; box-shadow: var(--shadow-glow);}
        .loader-text { margin-top: 20px; font-size: 0.85rem; font-weight: 800; letter-spacing: 2px; color: var(--text-white); text-transform: uppercase; animation: pulse 2s infinite; }
        
        .app-wrapper { display: flex; min-height: 100vh; width: 100%; opacity: 0; transition: opacity 0.6s ease; }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .4; } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(15px);} to { opacity: 1; transform: translateY(0);} }

        /* ==========================================================================
           3. APP LAYOUT (SIDEBAR + MAIN)
           ========================================================================== */
        .sidebar-wrapper { position: fixed; top: 0; left: 0; width: var(--sidebar-width); height: 100vh; padding: 24px 0 24px 24px; z-index: 1000; }
        .sidebar { width: 100%; height: 100%; background: var(--bg-sidebar); border: var(--border-glass); border-top: var(--border-bevel); border-left: var(--border-bevel); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); display: flex; flex-direction: column; padding: 32px 20px; border-radius: 32px; box-shadow: var(--shadow-panel); }
        .sidebar-logo { font-size: 1.8rem; font-weight: 900; letter-spacing: -0.5px; margin-bottom: 40px; text-align: center; cursor: pointer;}
        
        .nav-menu { display: flex; flex-direction: column; gap: 4px; flex: 1;}
        .nav-label { font-size: 0.65rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; margin: 16px 0 8px 12px; }
        
        .nav-item { display: flex; align-items: center; gap: 14px; padding: 12px 16px; border-radius: 16px; color: var(--text-muted); font-weight: 600; font-size: 0.95rem; transition: var(--transition); cursor: pointer; border: 1px solid transparent; position: relative; }
        .nav-item i { font-size: 1.4rem; transition: transform 0.3s; color: #64748B;}
        .nav-item:hover { color: var(--text-white); background: var(--bg-glass); transform: translateX(4px);}
        .nav-item:hover i { color: var(--text-white);}
        
        .nav-item.active { background: rgba(255,255,255,0.05); border: 1px solid var(--border-glass-strong); color: var(--text-white); box-shadow: var(--shadow-inner); }
        .nav-item.active i { color: var(--accent-cyan); filter: drop-shadow(0 0 8px var(--accent-cyan));}
        
        .nav-item.story-btn { background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan)); color: white; border: none; margin-top: 8px; justify-content: center; border-radius: 100px; font-weight: 800; box-shadow: var(--shadow-glow-blue);}
        .nav-item.story-btn i { color: white; }
        .nav-item.story-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(37, 99, 235, 0.6); }

        .sidebar-footer { margin-top: auto; display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--bg-card); border-radius: 20px; border: 1px solid var(--border-glass-strong); cursor: pointer; transition: var(--transition); box-shadow: 0 10px 20px rgba(0,0,0,0.3);}
        .sidebar-footer:hover { background: var(--bg-glass-hover); border-color: var(--accent-cyan);}
        .sf-avatar { width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan)); display: flex; align-items: center; justify-content: center; color: #fff; font-size: 1.2rem; overflow: hidden; box-shadow: var(--shadow-glow);}
        .sf-info { flex: 1; overflow: hidden; }
        .sf-name { font-size: 0.9rem; font-weight: 800; color: var(--text-white); white-space: nowrap; text-overflow: ellipsis; overflow: hidden;}
        .sf-sub { font-size: 0.75rem; color: var(--accent-cyan); font-weight: 600;}

        /* MAIN COLUMN */
        .main-column { margin-left: var(--sidebar-width); flex: 1; display: flex; flex-direction: column; min-height: 100vh; position: relative; width: calc(100% - var(--sidebar-width)); padding-left: 24px;}
        
        /* TOP HEADER */
        .top-header { position: fixed; top: 0; right: 0; width: calc(100% - var(--sidebar-width) - 24px); height: 90px; display: flex; align-items: center; justify-content: space-between; padding: 0 40px; background: transparent; z-index: 500; transition: all 0.3s ease; }
        .top-header.scrolled { background: rgba(10, 15, 28, 0.85); backdrop-filter: blur(30px); border-bottom: 1px solid var(--border-glass); height: 70px; width: calc(100% - var(--sidebar-width)); padding-left: 64px;}
        [data-theme="light"] .top-header.scrolled { background: rgba(241,245,249,0.95); }
        
        .mobile-logo { display: none; }
        
        .search-container { position: relative; width: 100%; max-width: 400px; }
        .search-box { display: flex; align-items: center; gap: 12px; background: rgba(0,0,0,0.2); border: 1px solid var(--border-glass); border-top: 1px solid rgba(0,0,0,0.5); border-radius: 100px; padding: 12px 24px; transition: var(--transition); box-shadow: var(--shadow-inner);}
        .search-box:focus-within { border-color: var(--accent-purple); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2), var(--shadow-inner); background: rgba(0,0,0,0.4);}
        .search-box input { background: transparent; border: none; color: var(--text-white); width: 100%; font-family: inherit; outline: none; font-size: 16px !important; font-weight: 500;}
        .search-box input::placeholder { color: var(--text-muted); font-weight: 500;}
        
        .search-dropdown { position: absolute; top: calc(100% + 12px); left: 0; width: 130%; background: var(--bg-card); border: var(--border-glass); border-top: var(--border-bevel); border-left: var(--border-bevel); border-radius: 24px; box-shadow: var(--shadow-panel); max-height: 60vh; overflow-y: auto; display: none; z-index: 101; backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px); padding: 12px; }
        [data-theme="light"] .search-dropdown { background: rgba(255,255,255,0.95); }
        .search-item { display: flex; gap: 16px; padding: 12px; border-radius: 16px; cursor: pointer; transition: var(--transition); }
        .search-item:hover { background: var(--bg-glass-hover); transform: translateX(6px);}
        .search-thumb { width: 48px; height: 68px; border-radius: 10px; background: #1F2937; overflow: hidden; flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.3);}
        .search-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .search-info { display: flex; flex-direction: column; justify-content: center; overflow: hidden; gap: 4px;}
        .search-title { font-size: 0.95rem; font-weight: 800; color: var(--text-white); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .search-origin { font-size: 0.75rem; color: var(--text-muted); font-weight: 600;}
        .search-msg { padding: 32px; text-align: center; font-size: 0.9rem; color: var(--text-muted); font-weight: 600;}

        .header-actions { display: flex; align-items: center; gap: 16px; }
        .header-btn { width: 44px; height: 44px; border-radius: 50%; background: var(--bg-glass); border: 1px solid var(--border-glass); display: flex; align-items: center; justify-content: center; color: var(--text-muted); font-size: 1.3rem; transition: var(--transition); position: relative; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);}
        .header-btn:hover { background: var(--bg-glass-hover); color: var(--text-white); transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.3); border-color: rgba(255,255,255,0.1);}
        .header-btn .badge { position: absolute; top: 10px; right: 10px; width: 8px; height: 8px; background: var(--accent-red); border-radius: 50%; box-shadow: 0 0 10px var(--accent-red);}

        /* ==========================================================================
           4. RIGHT SIDE-PANEL
           ========================================================================== */
        .side-panel-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; backdrop-filter: blur(8px); display: none; opacity: 0; transition: opacity 0.4s; }
        .side-panel { 
            position: fixed; top: 0; right: 0; width: 380px; height: 100vh; 
            background: rgba(15,20,33,0.95); backdrop-filter: blur(50px); -webkit-backdrop-filter: blur(50px);
            border-left: 1px solid var(--border-glass-strong); z-index: 2001; 
            transform: translateX(100%); transition: transform 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; flex-direction: column; box-shadow: -30px 0 60px rgba(0,0,0,0.8);
        }
        [data-theme="light"] .side-panel { background: rgba(255,255,255,0.95); }
        .side-panel.open { transform: translateX(0); }
        .side-panel-overlay.show { display: block; opacity: 1; }

        .sp-header { display: flex; align-items: center; justify-content: space-between; padding: 24px 32px; border-bottom: 1px solid var(--border-glass); }
        .sp-title { font-size: 1.2rem; font-weight: 800; color: var(--text-white); display: flex; align-items: center; gap: 10px;}
        .sp-close { font-size: 1.4rem; color: var(--text-muted); cursor: pointer; transition: var(--transition); padding: 8px; border-radius: 50%; background: var(--bg-glass);}
        .sp-close:hover { color: var(--text-white); background: var(--accent-red); transform: rotate(90deg);}

        .sp-content { flex: 1; overflow-y: auto; padding: 24px 32px; }

        .sp-list-item { display: flex; gap: 16px; padding: 14px; border-radius: 16px; background: var(--bg-card); border: 1px solid var(--border-glass); border-top: var(--border-bevel); border-left: var(--border-bevel); margin-bottom: 12px; transition: var(--transition); cursor: pointer; position: relative; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.2);}
        .sp-list-item:hover { border-color: var(--accent-purple); transform: translateX(-4px); box-shadow: -5px 5px 20px rgba(0,0,0,0.4);}
        .sp-thumb { width: 56px; height: 80px; border-radius: 10px; overflow: hidden; flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.5);}
        .sp-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .sp-info { flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 6px; overflow: hidden;}
        .sp-item-title { font-size: 1rem; font-weight: 800; color: var(--text-white); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4;}
        .sp-item-sub { font-size: 0.85rem; color: var(--accent-cyan); font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .sp-item-time { font-size: 0.75rem; color: var(--text-muted); font-weight: 500;}
        
        .sp-btn-remove { position: absolute; top: 14px; right: 14px; width: 32px; height: 32px; border-radius: 50%; background: rgba(0,0,0,0.6); color: white; display: flex; align-items: center; justify-content: center; transition: var(--transition); opacity: 0; backdrop-filter: blur(5px);}
        .sp-list-item:hover .sp-btn-remove { opacity: 1; }
        .sp-btn-remove:hover { background: var(--accent-red); transform: scale(1.1);}
        .sp-empty { text-align: center; color: var(--text-muted); padding: 80px 20px; font-size: 1rem; font-weight: 600;}

        /* THEME CARDS */
        .theme-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-top: 16px;}
        .theme-card { display: flex; flex-direction: column; gap: 10px; cursor: pointer; }
        .theme-swatch-box { width: 100%; aspect-ratio: 16/9; border-radius: 16px; display: flex; overflow: hidden; border: 2px solid transparent; transition: var(--transition); box-shadow: 0 10px 20px rgba(0,0,0,0.4);}
        .theme-card:hover .theme-swatch-box { transform: translateY(-4px); box-shadow: var(--shadow-glow); border-color: rgba(255,255,255,0.3);}
        .theme-card.active .theme-swatch-box { border-color: var(--accent-cyan); box-shadow: var(--shadow-glow); }
        .theme-swatch-box div { flex: 1; height: 100%; }
        .theme-name { font-size: 0.95rem; color: var(--text-muted); font-weight: 700; text-align: center; transition: var(--transition);}
        .theme-card:hover .theme-name, .theme-card.active .theme-name { color: var(--text-white); }

        /* ==========================================================================
           5. SECTION ROUTING (SPA LOGIC)
           ========================================================================== */
        .page-section { display: none; animation: fadeUp 0.5s ease forwards; }
        .page-section.active { display: block; }
        .content-wrapper { padding: 110px 40px 60px; max-width: 1600px; margin: 0 auto; width: 100%;}

        /* ==========================================================================
           5A. MAIN PLAYER (TRANG CHỦ)
           ========================================================================== */
        .hero-section { display: flex; flex-direction: column; gap: 32px; align-items: stretch; width: 100%; }
        .hero-left { flex: 1; display: flex; flex-direction: column; min-width: 0; width: 100%; }
        .hero-right { width: 100%; display: flex; flex-direction: column; }

        @media (min-width: 1025px) { 
            .hero-section { flex-direction: row; align-items: flex-start;} 
            .hero-right { flex: 0 0 280px; position: sticky; top: 110px; max-height: calc(100vh - 140px); }
        }
        @media (min-width: 1400px) { .hero-right { flex: 0 0 320px; } }

        /* Player */
        .player-container { position: relative; width: 100%; aspect-ratio: 16 / 9; background: #000; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.8), inset 0 1px 1px rgba(255,255,255,0.1); overflow: hidden; border: 1px solid var(--border-glass-strong);}
        [data-theme="light"] .player-container { box-shadow: var(--shadow-panel); }
        .player-container iframe { width: 100%; height: 100%; border: none; position: absolute; top: 0; left: 0; z-index: 10; }
        .player-glow { position: absolute; top: 10%; left: 10%; right: 10%; bottom: -20px; background: inherit; filter: blur(60px) opacity(0.6); z-index: -1; }
        
        /* Movie Info */
        .movie-info-panel { display: flex; flex-direction: column; gap: 24px; margin-top: 32px; min-width: 0; }
        .movie-title { font-size: 3.2rem; font-weight: 900; color: var(--text-white); line-height: 1.1; letter-spacing: -1.5px; text-shadow: 0 10px 30px rgba(0,0,0,0.8); word-break: break-word;}
        [data-theme="light"] .movie-title { text-shadow: none; }
        
        .action-bar { display: flex; flex-wrap: wrap; gap: 16px; align-items: center;}
        .btn-pill { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 14px 28px; background: var(--bg-card); border: 1px solid var(--border-glass-strong); border-top: var(--border-bevel); border-radius: 100px; font-size: 0.95rem; font-weight: 800; transition: var(--transition); color: var(--text-white); backdrop-filter: blur(10px); box-shadow: 0 10px 20px rgba(0,0,0,0.3);}
        .btn-pill:hover { background: var(--bg-glass-hover); transform: translateY(-3px); box-shadow: 0 15px 25px rgba(0,0,0,0.5); border-color: rgba(255,255,255,0.3);}
        
        .btn-pill.primary { 
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan)); 
            background-size: 200% auto;
            color: #000 !important; 
            border: none; 
            box-shadow: var(--shadow-glow);
        }
        .btn-pill.primary i { color: #000; }
        .btn-pill.primary:hover { 
            background-position: right center; color: #fff !important; transform: translateY(-4px) scale(1.05); box-shadow: 0 15px 35px rgba(6, 182, 212, 0.6);
        }
        .btn-pill.primary:hover i { color: #fff; }
        
        .btn-pill.saved { border-color: var(--accent-red); color: var(--accent-red); background: rgba(244,63,94,0.1); box-shadow: 0 0 20px rgba(244,63,94,0.2);}
        
        .meta-tags { display: flex; flex-wrap: wrap; gap: 12px; font-size: 0.9rem; font-weight: 700; color: var(--text-white); align-items: center;}
        .tag-rating { color: #000; background: var(--accent-yellow); padding: 6px 14px; border-radius: 10px; font-weight: 900; display: flex; align-items: center; gap: 6px; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);}
        .tag-box { background: var(--bg-card); padding: 6px 14px; border-radius: 10px; border: 1px solid var(--border-glass-strong); box-shadow: 0 4px 10px rgba(0,0,0,0.3);}
        
        .movie-desc { font-size: 1rem; color: var(--text-muted); line-height: 1.8; word-break: break-word;}

        /* Episodes Panel */
        .episodes-panel { padding: 20px; height: 100%; flex: 1; display: flex; flex-direction: column; overflow: hidden; border-radius: 24px;}
        .ep-header { display: flex; flex-direction: column; margin-bottom: 20px; gap: 12px; }
        .ep-title { font-size: 1.2rem; font-weight: 900; color: var(--text-white); display: flex; align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: 1px;}
        .ep-title i { color: var(--accent-cyan); font-size: 1.5rem; filter: drop-shadow(0 0 8px var(--accent-cyan));}
        
        .ep-controls { display: flex; gap: 10px; align-items: center; width: 100%; justify-content: space-between;}
        .ep-chunk-select { background: rgba(0,0,0,0.5); border: 1px solid var(--border-glass-strong); color: var(--text-white); border-radius: 12px; padding: 8px 12px; font-size: 16px !important; font-weight: 700; outline: none; cursor: pointer; transition: var(--transition); flex: 1; box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);}
        .ep-chunk-select:hover { border-color: var(--accent-cyan); }
        .ep-chunk-select option { background: var(--bg-main); color: var(--text-white); }
        .ep-count { font-size: 0.8rem; font-weight: 800; background: var(--bg-card); padding: 8px 12px; border-radius: 12px; color: var(--accent-cyan); white-space: nowrap; border: 1px solid var(--border-glass);}
        
        .episodes-grid { flex: 1; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 8px; align-content: start; padding-right: 6px;}
        .btn-episode { padding: 10px 4px; border-radius: 12px; font-size: 0.9rem; font-weight: 800; background: var(--bg-card); border: 1px solid var(--border-glass); color: var(--text-muted); transition: var(--transition); display: block; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; box-shadow: 0 4px 10px rgba(0,0,0,0.2);}
        .btn-episode:hover { background: var(--bg-glass-hover); color: var(--text-white); border-color: var(--accent-cyan); transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.4);}
        .btn-episode.active { background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan)); color: #fff !important; border-color: transparent; box-shadow: var(--shadow-glow); transform: scale(1.05); z-index: 2;}

        /* ==========================================================================
           5B. EXPLORE SECTION (KHÁM PHÁ)
           ========================================================================== */
        .section-heading { font-size: 2.2rem; font-weight: 900; color: var(--text-white); letter-spacing: -1px; margin-bottom: 32px; display: flex; align-items: center; gap: 16px;}
        .section-heading::before { content: ''; display: block; width: 8px; height: 32px; background: linear-gradient(to bottom, var(--accent-purple), var(--accent-cyan)); border-radius: 8px; box-shadow: var(--shadow-glow);}

        .genre-tabs { display: flex; gap: 16px; overflow-x: auto; padding-bottom: 20px; scrollbar-width: none; margin-bottom: 16px;}
        .genre-tabs::-webkit-scrollbar { display: none; }
        .tab-btn { padding: 14px 28px; border-radius: 100px; background: var(--bg-card); border: 1px solid var(--border-glass-strong); color: var(--text-muted); font-weight: 800; font-size: 1rem; white-space: nowrap; transition: var(--transition); box-shadow: 0 8px 20px rgba(0,0,0,0.3);}
        .tab-btn:hover { background: var(--bg-glass-hover); color: var(--text-white); transform: translateY(-3px); border-color: rgba(255,255,255,0.2);}
        .tab-btn.active { background: var(--text-white); color: var(--bg-main) !important; box-shadow: 0 12px 30px rgba(255,255,255,0.3); border-color: transparent;}
        
        .tab-btn.recommended { position: relative; border-color: rgba(6, 182, 212, 0.5); color: var(--text-light); }
        .tab-btn.recommended::after { content: '★ FOR YOU'; position: absolute; top: -10px; right: 10px; background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan)); color: #fff; font-size: 0.6rem; padding: 4px 8px; border-radius: 8px; font-weight: 900; box-shadow: var(--shadow-glow); letter-spacing: 0.5px;}

        .anime-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
        @media (min-width: 640px) { .anime-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 1024px) { .anime-grid { grid-template-columns: repeat(4, 1fr); } }
        @media (min-width: 1400px) { .anime-grid { grid-template-columns: repeat(5, 1fr); } }

        .anime-card { background: transparent; border-radius: 20px; overflow: hidden; transition: var(--transition); cursor: pointer; display: flex; flex-direction: column; position: relative;}
        .anime-card:hover { transform: translateY(-12px); }
        .ac-thumb { position: relative; width: 100%; aspect-ratio: 2/3; overflow: hidden; background: #1F2937; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.05);}
        .ac-thumb img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.8s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .anime-card:hover .ac-thumb img { transform: scale(1.12); }
        
        .ac-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(11,15,25,0.95) 0%, rgba(11,15,25,0.1) 60%, transparent 100%); opacity: 0.9; transition: opacity 0.4s;}
        .anime-card:hover .ac-overlay { opacity: 1; background: linear-gradient(to top, rgba(11,15,25,1) 0%, rgba(11,15,25,0.4) 60%, transparent 100%);}
        
        .ac-ep { position: absolute; top: 16px; right: 16px; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); color: var(--accent-cyan); font-size: 0.85rem; font-weight: 900; padding: 6px 12px; border-radius: 10px; border: 1px solid rgba(6, 182, 212, 0.3); box-shadow: 0 4px 15px rgba(0,0,0,0.5);}
        
        .ac-play-btn { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(0.8); width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan)); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 2rem; opacity: 0; transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); box-shadow: var(--shadow-glow);}
        .anime-card:hover .ac-play-btn { opacity: 1; transform: translate(-50%, -50%) scale(1); }

        .ac-info { position: absolute; bottom: 0; left: 0; width: 100%; padding: 24px 20px; display: flex; flex-direction: column; z-index: 10; transform: translateY(10px); transition: transform 0.4s;}
        .anime-card:hover .ac-info { transform: translateY(0); }
        .ac-title { font-size: 1.15rem; font-weight: 900; color: white; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-shadow: 0 4px 10px rgba(0,0,0,0.9);}
        .ac-year { font-size: 0.9rem; color: var(--text-muted); margin-top: 6px; font-weight: 700;}

        /* ==========================================================================
           5C. SCHEDULE SECTION (LỊCH CHIẾU - MỚI)
           ========================================================================== */
        .schedule-grid { display: flex; flex-direction: column; gap: 16px; }
        .sc-card { display: flex; align-items: center; gap: 20px; padding: 16px; background: var(--bg-card); border: 1px solid var(--border-glass-strong); border-radius: 20px; transition: var(--transition); cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.3);}
        .sc-card:hover { transform: translateX(10px); border-color: var(--accent-cyan); background: var(--bg-glass-hover); box-shadow: -10px 10px 30px rgba(0,0,0,0.5);}
        .sc-thumb { width: 80px; height: 110px; border-radius: 12px; overflow: hidden; flex-shrink: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.5); position: relative;}
        .sc-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .sc-info { flex: 1; display: flex; flex-direction: column; justify-content: center; overflow: hidden;}
        .sc-title { font-size: 1.2rem; font-weight: 900; color: var(--text-white); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 6px;}
        .sc-ep { color: var(--accent-cyan); font-weight: 800; font-size: 0.95rem; margin-bottom: 8px;}
        .sc-time { color: var(--text-muted); font-size: 0.85rem; display: flex; align-items: center; gap: 6px;}
        .sc-time i { font-size: 1.2rem; color: var(--accent-purple);}
        .sc-btn { width: 44px; height: 44px; border-radius: 50%; background: var(--bg-glass); display: flex; align-items: center; justify-content: center; color: var(--text-white); font-size: 1.2rem; transition: var(--transition); flex-shrink: 0;}
        .sc-card:hover .sc-btn { background: var(--accent-cyan); color: #000; box-shadow: var(--shadow-glow); transform: scale(1.1);}

        /* ==========================================================================
           7. ONBOARDING & SCAN MODALS
           ========================================================================== */
        .modal-overlay { position: fixed; inset: 0; background: rgba(5, 8, 15, 0.95); z-index: 3000; backdrop-filter: blur(30px); display: none; align-items: center; justify-content: center; }
        [data-theme="light"] .modal-overlay { background: rgba(244,244,249,0.9); }
        
        .modal-content.onboarding { 
            background: linear-gradient(145deg, rgba(22, 30, 49, 0.9), rgba(11, 15, 25, 0.95)); 
            border: 1px solid var(--border-glass-strong); border-top: var(--border-bevel); border-left: var(--border-bevel); 
            border-radius: 40px; padding: 50px 40px; text-align: center; 
            box-shadow: 0 40px 80px rgba(0,0,0,0.8), inset 0 1px 1px rgba(255,255,255,0.1); 
            position: relative; overflow: hidden; width: 90%; 
        }
        .modal-content.onboarding::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(37,99,235,0.15) 0%, transparent 50%); z-index: -1; pointer-events: none; }
        
        /* Cấu trúc Step 1 (Nhập Tên) */
        .step-1 { max-width: 450px; }
        .step-2 { max-width: 600px; display: none; } /* Mặc định ẩn step 2 */

        .ob-title { font-size: 2.2rem; font-weight: 900; margin-bottom: 12px; letter-spacing: -1px;}
        .ob-desc { color: var(--text-muted); margin-bottom: 32px; font-size: 1rem; max-width: 500px; margin-left: auto; margin-right: auto;}
        
        .ob-profile-setup { display: flex; flex-direction: column; gap: 16px; margin-bottom: 32px;}
        /* Input Step 1 căn giữa, to rõ */
        .ob-input-large { width: 100%; border-radius: 20px; padding: 18px 24px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--text-white); outline: none; font-size: 1.2rem !important; text-align: center; transition: var(--transition); font-family: inherit; font-weight: 700; box-shadow: inset 0 4px 10px rgba(0,0,0,0.2);}
        .ob-input-large:focus { border-color: var(--accent-cyan); background: rgba(0,0,0,0.4); box-shadow: 0 0 0 4px rgba(6,182,212,0.15), inset 0 4px 10px rgba(0,0,0,0.4); }
        .ob-input-large::placeholder { color: rgba(255,255,255,0.3); font-weight: 500;}

        /* Khung Avatar ở Step 2 */
        .ob-avatar-section { display: flex; flex-direction: column; align-items: center; gap: 20px; margin-bottom: 24px; }
        .ob-avatar-preview { width: 100px; height: 100px; border-radius: 50%; position: relative; display: flex; align-items: center; justify-content: center;}
        .ob-avatar-preview img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; border: 4px solid var(--accent-cyan); box-shadow: var(--shadow-glow);}
        
        /* Dấu tích xanh nhỏ góc avatar giống hình mẫu */
        .avatar-badge { position: absolute; bottom: 0; right: 0; background: var(--accent-cyan); color: #000; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid var(--bg-card); font-size: 16px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.5);}

        .ob-preset-avatars { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; background: var(--bg-glass); padding: 12px 24px; border-radius: 100px; border: 1px solid var(--border-glass); box-shadow: var(--shadow-inner);}
        .ob-preset-avatars img { width: 48px; height: 48px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: var(--transition); background: var(--bg-card); padding: 2px;}
        .ob-preset-avatars img:hover { transform: scale(1.15); box-shadow: 0 0 15px rgba(6,182,212,0.5);}
        .ob-preset-avatars img.active { border-color: var(--accent-cyan); box-shadow: 0 0 20px rgba(6,182,212,0.6); transform: scale(1.1);}
        
        .ob-divider { display: flex; align-items: center; text-align: center; color: var(--text-white); font-size: 0.95rem; font-weight: 800; margin: 24px 0 16px; width: 100%; }
        .ob-divider::before, .ob-divider::after { content: ''; flex: 1; border-bottom: 1px solid var(--border-glass-strong); margin: 0 16px; }

        .ob-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 32px; max-height: 180px; overflow-y: auto; padding-right: 4px; align-content: flex-start;}
        .ob-pill { padding: 10px 20px; border-radius: 100px; border: 1px solid var(--border-glass-strong); background: var(--bg-card); color: var(--text-light); font-weight: 700; font-size: 0.9rem; cursor: pointer; transition: var(--transition); box-shadow: 0 4px 10px rgba(0,0,0,0.2);}
        .ob-pill:hover { background: var(--bg-glass-hover); transform: translateY(-2px);}
        .ob-pill.active { background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan)); color: #fff; border-color: transparent; box-shadow: var(--shadow-glow); transform: scale(1.05); }

        .btn-primary { background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan)); color: #fff !important; border: none; padding: 18px 48px; border-radius: 100px; font-size: 1.1rem; font-weight: 900; cursor: pointer; transition: var(--transition); display: inline-flex; align-items: center; justify-content: center; gap: 10px; box-shadow: var(--shadow-glow-blue); width: 100%;}
        .btn-primary:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 15px 35px rgba(6,182,212,0.6); background-position: right center;}
        .btn-primary:disabled { background: var(--bg-card); color: var(--text-muted) !important; cursor: not-allowed; box-shadow: none; transform: none; border: 1px solid var(--border-glass-strong);}

        /* Cải tiến Scan Modal */
        .modal-content.scan { max-width: 500px; padding: 40px; border-radius: 32px; }

        /* ==========================================================================
           8. MOBILE OPTIMIZATION (FLOATING APP NAV)
           ========================================================================== */
        .mobile-bottom-nav { display: none; }
        .mobile-search-wrapper { display: none; }

        @media (max-width: 1024px) {
            .sidebar-wrapper { display: none; } 
            .main-column { margin-left: 0; padding-bottom: 100px; width: 100%; padding-left: 0;}
            
            .mobile-bottom-nav {
                display: flex; position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px;
                background: rgba(15, 20, 33, 0.85); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
                border: 1px solid rgba(255,255,255,0.1); border-radius: 100px; z-index: 1000;
                padding: 8px 16px; justify-content: space-between; align-items: center;
                box-shadow: 0 20px 40px rgba(0,0,0,0.8), inset 0 1px 1px rgba(255,255,255,0.1);
            }
            [data-theme="light"] .mobile-bottom-nav { background: rgba(255,255,255,0.9); }
            
            .mobile-nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: var(--text-muted); font-size: 0.65rem; font-weight: 800; transition: var(--transition); padding: 8px; border-radius: 20px; flex: 1; text-transform: uppercase; letter-spacing: 0.5px;}
            
            .mobile-nav-item.active { color: var(--text-white); background: rgba(255,255,255,0.05);}
            .mobile-nav-item.active i { color: var(--accent-cyan); filter: drop-shadow(0 0 12px var(--accent-cyan)); transform: translateY(-2px);}
            .mobile-nav-item i { font-size: 1.6rem; transition: var(--transition); }

            .mobile-nav-item.story { position: relative; top: -15px; background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan)); width: 56px; height: 56px; flex: unset; border-radius: 50%; box-shadow: var(--shadow-glow), inset 0 2px 5px rgba(255,255,255,0.4); border: 4px solid var(--bg-main); color: #fff;}
            .mobile-nav-item.story i { font-size: 1.8rem; color: #fff;}
            .mobile-nav-item.story span { display: none; }
            
            .top-header { padding: 0 24px; height: 72px; width: 100%; right: 0;}
            .content-wrapper { padding: 100px 24px 32px; }
            .side-panel { width: 100%; max-width: 380px; }
            .episodes-panel { position: relative; top: 0; max-height: none; min-height: 350px; }
        }

        @media (max-width: 768px) {
            .top-header { height: 70px; padding: 0 20px; background: rgba(11,15,25,0.9); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border-glass); }
            .top-header.scrolled { padding-left: 20px; height: 70px; }
            [data-theme="light"] .top-header { background: rgba(241,245,249,0.95); }
            
            .mobile-logo { display: block !important; font-size: 1.6rem; font-weight: 900; font-style: italic; cursor: pointer; text-shadow: var(--shadow-glow);}
            #desktop-search { display: none; }
            
            .mobile-search-wrapper { display: block; padding: 0 20px; margin-top: -10px; margin-bottom: 24px;}
            .mobile-search-wrapper .search-container { max-width: 100%; }
            .mobile-search-wrapper .search-box { border-radius: 100px; padding: 12px 20px; background: var(--bg-card); border: 1px solid var(--border-glass-strong); box-shadow: var(--shadow-inner);}
            .mobile-search-wrapper .search-dropdown { width: 100%; left: 0; top: calc(100% + 8px); }
            
            .content-wrapper { padding: 80px 0 60px; gap: 24px;}
            .hero-section { gap: 16px; padding: 0;}
            
            .player-container { border-radius: 0; border: none; box-shadow: none; border-top: 1px solid var(--border-glass); border-bottom: 1px solid var(--border-glass);}
            .player-glow { display: none; }
            
            .movie-info-panel { margin-top: 8px; gap: 16px; padding: 0 20px;}
            .movie-title { font-size: 2rem; letter-spacing: -0.5px; }
            
            .action-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%;}
            .btn-pill { padding: 12px 4px; font-size: 0.85rem; width: 100%; border-radius: 12px; gap: 6px;}
            .btn-pill.primary { grid-column: span 3; font-size: 1.1rem; padding: 14px;}
            
            .episodes-panel { padding: 20px; margin: 0 20px; min-height: auto; border-radius: 20px;}
            .episodes-grid { max-height: 280px; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 8px; }
            .btn-episode { padding: 10px 4px; font-size: 0.85rem; border-radius: 10px;}
            
            .explore-section, .schedule-section { padding: 0 20px; }
            .anime-grid { grid-template-columns: repeat(2, 1fr); gap: 16px; }
            
            .sc-card { padding: 12px; gap: 16px; border-radius: 16px;}
            .sc-thumb { width: 70px; height: 100px; border-radius: 10px;}
            .sc-title { font-size: 1.1rem; }
            .sc-btn { width: 40px; height: 40px; font-size: 1.1rem; margin-right: 8px;}

            /* Onboarding Scale cho Mobile */
            .modal-content.onboarding { padding: 40px 24px; border-radius: 32px;}
            .step-1, .step-2 { width: 95%; max-width: 100%; }
        }

        /* ==========================================================================
           9. T-STORY
           ========================================================================== */
        .story-modal { position: fixed; inset: 0; background: rgba(5, 8, 15, 0.98); z-index: 4000; display: none; flex-direction: column; height: 100dvh; backdrop-filter: blur(30px);}
        .story-header { position: absolute; top: 0; left: 0; width: 100%; padding: 24px 32px; display: flex; justify-content: space-between; align-items: center; z-index: 4010; }
        .story-logo { font-size: 1.8rem; font-weight: 900; font-style: italic; color: white; text-transform: uppercase; text-shadow: var(--shadow-glow);}
        .btn-close-story { color: white; background: rgba(255,255,255,0.1); border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); transition: var(--transition); cursor: pointer; border: 1px solid var(--border-glass-strong);}
        .btn-close-story:hover { background: var(--accent-red); transform: scale(1.1); border-color: transparent;}
        
        .story-container { flex: 1; width: 100%; height: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; scrollbar-width: none; }
        .story-container::-webkit-scrollbar { display: none; }
        .story-item { position: relative; width: 100%; height: 100dvh; scroll-snap-align: start; display: flex; align-items: center; justify-content: center; overflow: hidden; padding: 90px 32px 32px;}
        
        .story-layout-container {
            display: flex; gap: 32px; width: 100%; max-width: 1400px; height: 100%; max-height: 850px;
            background: linear-gradient(145deg, rgba(22, 29, 47, 0.8), rgba(11, 15, 25, 0.95)); 
            border-radius: 32px; padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.08); backdrop-filter: blur(40px);
            box-shadow: 0 40px 80px rgba(0, 0, 0, 0.8), inset 0 1px 1px rgba(255, 255, 255, 0.1);
        }

        .story-video-area { flex: 2; border-radius: 20px; overflow: hidden; background: #000; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.6);}
        .story-video-loader { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 0; }
        .story-video-area iframe { width: 100%; height: 100%; border: none; position: absolute; inset: 0; z-index: 1;}
        
        .story-content-area { flex: 1; min-width: 340px; max-width: 400px; display: flex; flex-direction: column; gap: 20px; overflow: hidden; position: relative;}
        .story-overlay-bg { display: none; }
        
        .story-meta { display: flex; flex-direction: column; gap: 16px; flex-shrink: 0;}
        .story-title { font-size: 2.2rem; font-weight: 900; background: linear-gradient(to right, #fff, #94A3B8); -webkit-background-clip: text; color: transparent; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;}
        .story-desc { font-size: 1rem; color: #94A3B8; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.6;}
        
        .btn-watch-now { align-self: flex-start; background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan)); color: #FFF !important; padding: 14px 28px; border-radius: 100px; font-weight: 800; display: flex; align-items: center; gap: 10px; transition: var(--transition); font-size: 1.05rem; border: none; cursor: pointer; box-shadow: var(--shadow-glow);}
        .btn-watch-now:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 12px 30px rgba(6, 182, 212, 0.6); }

        .story-actions { display: flex; gap: 12px; align-items: center;}
        .action-icon { display: flex; align-items: center; gap: 8px; color: white; background: var(--bg-card); border: 1px solid var(--border-glass-strong); padding: 12px 20px; border-radius: 16px; cursor: pointer; transition: var(--transition); font-weight: 700; font-size: 0.95rem; box-shadow: inset 0 2px 4px rgba(255,255,255,0.05);}
        .action-icon:hover { background: var(--bg-glass-hover); border-color: var(--accent-cyan); transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.4);}
        .action-icon i { font-size: 1.5rem; color: var(--accent-cyan);}
        .action-icon.liked i { color: var(--accent-red); }
        .action-icon span { text-shadow: none; }
        .action-ep-btn { display: none; } 

        .story-episodes-sheet { flex: 1; display: flex; flex-direction: column; background: rgba(0,0,0,0.3); border-radius: 20px; border: 1px solid var(--border-glass-strong); overflow: hidden; padding: 20px; box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);}
        .se-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; color: white; font-weight: 900; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px;}
        .se-close-btn { display: none; }

        .story-hint { position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%); color: rgba(255,255,255,0.5); font-size: 0.9rem; font-weight: 700; pointer-events: none; animation: bounce 2s infinite; text-transform: uppercase; letter-spacing: 2px;}

        @media (max-width: 1024px) {
            .story-header { padding: 20px; z-index: 4050;}
            .story-logo { font-size: 1.4rem; }
            .story-item { padding: 0; }
            .story-layout-container { display: block; width: 100%; height: 100%; max-height: none; border-radius: 0; padding: 0; border: none; background: transparent; backdrop-filter: none; position: relative; box-shadow: none;}
            .story-video-area { width: 100%; height: 100%; border-radius: 0; border: none; box-shadow: none;}
            .story-content-area { position: absolute; inset: 0; pointer-events: none; display: flex; flex-direction: column; justify-content: flex-end; min-width: auto; max-width: none;}
            .story-overlay-bg { display: block; position: absolute; inset: 0; background: linear-gradient(to top, rgba(5, 8, 15, 1) 0%, rgba(5, 8, 15, 0.4) 50%, transparent 100%); z-index: 1;}
            .story-meta { position: relative; z-index: 2; padding: 32px 90px 40px 24px; pointer-events: auto; gap: 10px;}
            .story-title { font-size: 1.6rem; color: #fff;}
            .story-desc { font-size: 0.9rem; -webkit-line-clamp: 3; margin-bottom: 12px;}
            .btn-watch-now { padding: 10px 20px; font-size: 0.9rem;}
            .story-actions { position: absolute; z-index: 2; right: 16px; bottom: 100px; flex-direction: column; gap: 24px; pointer-events: auto;}
            .action-icon { flex-direction: column; padding: 0; background: transparent; border: none; gap: 6px; border-radius: 0; box-shadow: none;}
            .action-icon:hover { background: transparent; border: none; transform: scale(1.1);}
            .action-icon .icon-bg { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(15px); border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255, 255, 255, 0.2); transition: transform 0.2s;}
            .action-icon i { font-size: 1.8rem; color: white;}
            .action-icon.liked i { color: var(--accent-red); }
            .action-icon span { text-shadow: 0 2px 4px rgba(0,0,0,0.8); font-size: 0.75rem; display: block;}
            .action-ep-btn { display: flex; } 
            .story-episodes-sheet { position: absolute; bottom: 0; left: 0; width: 100%; height: 65vh; background: var(--bg-main); z-index: 4100; border-radius: 32px 32px 0 0; border: 1px solid var(--border-glass-strong); padding: 24px; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); pointer-events: auto; box-shadow: 0 -20px 50px rgba(0,0,0,0.9);}
            .story-item.show-episodes .story-episodes-sheet { transform: translateY(0); }
            .se-close-btn { display: block; color: var(--text-white); background: var(--bg-card); padding: 8px; border-radius: 50%; border: 1px solid var(--border-glass); cursor: pointer;}
            .story-hint { bottom: calc(24px + env(safe-area-inset-bottom)); }
        }
    </style>
</head>
<body>

    <!-- AMBIENT BACKGROUND -->
    <div id="app-bg"></div>
    <div id="app-bg-overlay"></div>

    <!-- LOADER -->
    <div id="loader" class="flex-center">
        <div class="spinner"></div>
        <div class="loader-text">ĐANG KHỞI ĐỘNG...</div>
    </div>

    <!-- ONBOARDING MODAL (THIẾT KẾ MỚI 2 BƯỚC) -->
    <div id="onboarding-modal" class="modal-overlay">
        
        <!-- BƯỚC 1: XIN CHÀO & TÊN -->
        <div class="modal-content onboarding step-1" id="ob-step-1">
            <h2 class="ob-title"><span class="gradient-text">Xin Chào!</span></h2>
            <p class="ob-desc">Chào mừng bạn đến với hệ thống T-ANIME. Hãy cho chúng tôi biết tên của bạn nhé.</p>
            
            <div class="ob-profile-setup" style="margin-bottom: 40px;">
                <input type="text" id="ob-input-name" class="ob-input-large" placeholder="Nhập tên của bạn..." autocomplete="off">
            </div>

            <button class="btn-primary" id="btn-next-step" disabled onclick="goToOnboardingStep2()">
                Tiếp Tục <i class="ph-bold ph-arrow-right"></i>
            </button>
        </div>

        <!-- BƯỚC 2: DIỆN MẠO MỚI & THỂ LOẠI -->
        <div class="modal-content onboarding step-2" id="ob-step-2">
            <h2 class="ob-title"><span class="gradient-text">Diện Mạo Mới</span></h2>
            <p class="ob-desc">Chọn ảnh đại diện thật chất và thể loại bạn yêu thích để tối ưu hoá trải nghiệm.</p>
            
            <div class="ob-avatar-section">
                <div class="ob-avatar-preview">
                    <img id="ob-preview-img" src="https://api.dicebear.com/7.x/adventurer/svg?seed=Felix" alt="Avatar">
                    <div class="avatar-badge"><i class="ph-bold ph-check"></i></div>
                </div>
                <div class="ob-preset-avatars">
                    <img src="https://api.dicebear.com/7.x/adventurer/svg?seed=Felix" onclick="selectPresetAvatar(this)" class="preset-img active">
                    <img src="https://api.dicebear.com/7.x/adventurer/svg?seed=Aneka" onclick="selectPresetAvatar(this)" class="preset-img">
                    <img src="https://api.dicebear.com/7.x/adventurer/svg?seed=Mimi" onclick="selectPresetAvatar(this)" class="preset-img">
                    <img src="https://api.dicebear.com/7.x/adventurer/svg?seed=Nala" onclick="selectPresetAvatar(this)" class="preset-img">
                    <img src="https://api.dicebear.com/7.x/adventurer/svg?seed=Leo" onclick="selectPresetAvatar(this)" class="preset-img">
                </div>
            </div>

            <div class="ob-divider">Thể Loại Yêu Thích</div>

            <div class="ob-grid custom-scrollbar" id="ob-genres-grid"></div>
            
            <div style="display: flex; gap: 16px; justify-content: center; width: 100%;">
                <button class="btn-pill" style="padding: 14px 24px; min-width: 120px;" onclick="goToOnboardingStep1()">Quay Lại</button>
                <button class="btn-primary" style="flex: 1; margin: 0;" id="btn-save-prefs" disabled onclick="savePreferences()">
                    Hoàn Tất <i class="ph-bold ph-check"></i>
                </button>
            </div>
        </div>

    </div>

    <!-- SCAN MODAL -->
    <div id="scan-modal" class="modal-overlay">
        <div class="modal-content scan">
            <h3 class="ob-title" style="font-size: 1.8rem; margin-bottom: 12px;"><i class="ph-fill ph-database"></i> Quét Dữ Liệu</h3>
            <div id="scan-init-view">
                <p class="ob-desc" style="font-size: 0.95rem; margin-bottom: 32px;">Hệ thống sẽ quét toàn bộ danh sách phim để lấy thông tin. Vui lòng chọn định dạng:</p>
                <div class="ob-grid" style="gap: 16px; margin-bottom: 0;">
                    <!-- Đã sửa lỗi tàng hình bằng !important trong css .btn-primary -->
                    <button class="btn-primary" style="min-width: unset; width: 100%; padding: 16px;" onclick="startScan('json')"><i class="ph-bold ph-file-code"></i> Tải JSON</button>
                    <button class="btn-pill" style="width: 100%; background: var(--bg-card); border: 1px solid var(--border-glass-strong); font-size: 1.1rem; padding: 16px;" onclick="startScan('csv')"><i class="ph-bold ph-file-csv"></i> Tải CSV</button>
                    <button class="btn-pill" style="width: 100%; background: transparent; border-color: transparent; font-size: 1rem;" onclick="closeScanModal()">Hủy</button>
                </div>
            </div>
            <div id="scan-progress-view" style="display: none;">
                <p class="ob-desc" style="font-size: 0.9rem; margin-bottom: 20px;">Vui lòng không đóng trình duyệt lúc này.</p>
                <div style="width: 100%; height: 10px; background: var(--bg-glass-hover); border-radius: 5px; overflow: hidden; margin-bottom: 16px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);">
                    <div id="scan-progress-fill" style="height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent-purple), var(--accent-cyan)); transition: width 0.3s; box-shadow: var(--shadow-glow);"></div>
                </div>
                <div id="scan-status" style="color: var(--accent-cyan); font-weight: 800; margin-bottom: 8px; font-size: 0.95rem;">Khởi động hệ thống quét...</div>
                <div id="scan-stats" style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 32px; font-weight: 600;">Đã quét: 0 phim</div>
                <button class="btn-pill" style="width: 100%; color: var(--accent-red); border-color: rgba(244,63,94,0.3); justify-content: center; background: rgba(244,63,94,0.1);" onclick="stopScan()">
                    <i class="ph-bold ph-stop-circle"></i> Dừng & Lưu Tạm
                </button>
            </div>
        </div>
    </div>

    <!-- APP WRAPPER -->
    <div class="app-wrapper" id="app-wrapper" style="display: none;">
        
        <!-- SIDEBAR -->
        <div class="sidebar-wrapper">
            <aside class="sidebar">
                <div class="sidebar-logo gradient-text" onclick="switchMainTab('home')">T-ANIME</div>
                
                <div class="nav-label">Main Menu</div>
                <div class="nav-menu">
                    <a href="#" class="nav-item active" id="nav-home" onclick="switchMainTab('home')">
                        <i class="ph-fill ph-house"></i> Trang Chủ
                    </a>
                    <a href="#" class="nav-item" id="nav-explore" onclick="switchMainTab('explore')">
                        <i class="ph-fill ph-compass"></i> Khám Phá
                    </a>
                    <a href="#" class="nav-item" id="nav-schedule" onclick="switchMainTab('schedule')">
                        <i class="ph-fill ph-calendar-check"></i> Lịch Chiếu
                    </a>
                    <button class="nav-item story-btn" onclick="openStoryMode()">
                        <i class="ph-fill ph-play-circle"></i> T-Story
                    </button>
                </div>

                <div class="nav-label" style="margin-top: 32px;">Library</div>
                <div class="nav-menu">
                    <button class="nav-item" onclick="openSidePanel('fav')">
                        <i class="ph-fill ph-heart"></i> Phim Yêu Thích
                    </button>
                    <button class="nav-item" onclick="openSidePanel('history')">
                        <i class="ph-fill ph-clock-counter-clockwise"></i> Lịch Sử Xem
                    </button>
                    <button class="nav-item" onclick="openSidePanel('download')">
                        <i class="ph-fill ph-download-simple"></i> Đã Tải Xuống
                    </button>
                </div>

                <div class="nav-label" style="margin-top: 32px;">Settings</div>
                <div class="nav-menu" style="margin-bottom: 24px;">
                    <button class="nav-item" onclick="toggleTheme()">
                        <i class="ph-fill ph-moon" id="theme-icon"></i> <span id="theme-text">Giao Diện Tối</span>
                    </button>
                    <button class="nav-item" onclick="openSidePanel('theme')">
                        <i class="ph-fill ph-palette"></i> Chủ Đề App
                    </button>
                </div>

                <div class="sidebar-footer" onclick="openSidePanel('fav')">
                    <div class="sf-avatar display-user-avatar"><i class="ph-fill ph-user"></i></div>
                    <div class="sf-info">
                        <div class="sf-name display-user-name">Guest</div>
                        <div class="sf-sub">Pro User <i class="ph-fill ph-check-circle"></i></div>
                    </div>
                    <i class="ph-bold ph-caret-right" style="color: var(--text-muted);"></i>
                </div>
            </aside>
        </div>

        <!-- MAIN COLUMN -->
        <main class="main-column">
            
            <!-- TOP HEADER -->
            <header class="top-header">
                <div class="mobile-logo gradient-text" onclick="switchMainTab('home')">T-ANIME</div>
                
                <div class="search-container" id="desktop-search">
                    <div class="search-box">
                        <i class="ph-bold ph-magnifying-glass" style="color: var(--text-muted); font-size: 1.2rem;"></i>
                        <input type="text" id="search-input" placeholder="Tìm kiếm kho phim..." autocomplete="off">
                    </div>
                    <div class="search-dropdown" id="search-dropdown"></div>
                </div>

                <div class="header-actions">
                    <button class="header-btn" onclick="openScanModal()" title="Công Cụ Quét Dữ Liệu">
                        <i class="ph-bold ph-database"></i>
                    </button>
                    <button class="header-btn"><i class="ph-bold ph-bell"></i><span class="badge"></span></button>
                </div>
            </header>

            <!-- CONTENT WRAPPER -->
            <div class="content-wrapper">
                
                <!-- Mobile Search -->
                <div class="mobile-search-wrapper page-section" id="mobile-search-sec">
                    <div class="search-container">
                        <div class="search-box">
                            <i class="ph-bold ph-magnifying-glass" style="color: var(--text-muted); font-size: 1.2rem;"></i>
                            <input type="text" id="m-search-input" placeholder="Tìm kiếm Anime..." autocomplete="off">
                        </div>
                        <div class="search-dropdown" id="m-search-dropdown"></div>
                    </div>
                </div>

                <!-- 1. TRANG CHỦ (PLAYER) -->
                <div class="hero-section page-section active" id="sec-home">
                    <div class="hero-left">
                        <div class="player-container group" id="main-player-container">
                            <div class="player-glow"></div>
                            <div id="player-wrapper" style="width: 100%; height: 100%;"></div>
                        </div>
                        
                        <div class="movie-info-panel">
                            <div class="meta-tags" id="movie-meta">
                                <div class="skeleton-block" style="width: 60%; height: 28px;"></div>
                            </div>
                            <h1 class="movie-title" id="movie-title">
                                <div class="skeleton-block" style="width: 80%; height: 48px; margin-bottom: 12px;"></div>
                                <div class="skeleton-block" style="width: 50%; height: 48px;"></div>
                            </h1>
                            
                            <div class="action-bar">
                                <button class="btn-pill primary" id="btn-play-now" onclick="document.querySelector('.btn-episode').click()">
                                    <i class="ph-fill ph-play-circle" style="font-size: 1.4rem;"></i> Xem Ngay
                                </button>
                                <button class="btn-pill" id="btn-save" onclick="toggleFavoriteFromMain()">
                                    <i class="ph-bold ph-heart"></i> <span class="action-text">Lưu</span>
                                </button>
                                <button class="btn-pill" id="btn-download" onclick="downloadCurrentEpisode()">
                                    <i class="ph-bold ph-download-simple"></i> <span class="action-text">Tải Về</span>
                                </button>
                                <button class="btn-pill" onclick="shareStory()">
                                    <i class="ph-bold ph-share-network"></i>
                                </button>
                            </div>

                            <div class="movie-desc" id="movie-desc">
                                <div class="skeleton-block" style="width: 100%; height: 18px; margin-bottom: 10px;"></div>
                                <div class="skeleton-block" style="width: 90%; height: 18px; margin-bottom: 10px;"></div>
                                <div class="skeleton-block" style="width: 70%; height: 18px;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="glass-panel episodes-panel hero-right">
                        <div class="ep-header">
                            <div class="ep-title"><i class="ph-fill ph-monitor-play"></i> Danh Sách Tập</div>
                            <div class="ep-controls">
                                <span class="ep-count" id="ep-count">0</span>
                                <select id="ep-chunk-select" class="ep-chunk-select" style="display: none;" onchange="changeEpChunk(this.value)"></select>
                            </div>
                        </div>
                        <div class="episodes-grid custom-scrollbar" id="episodes-grid"></div>
                    </div>
                </div>

                <!-- 2. KHÁM PHÁ -->
                <section class="explore-section page-section" id="sec-explore">
                    <h2 class="section-heading">Khám Phá Anime</h2>
                    <div class="genre-tabs custom-scrollbar" id="genre-tabs-container"></div>
                    <div class="anime-grid" id="explore-grid"></div>
                    <div class="lazy-loader" id="lazy-loader"><i class="ph-bold ph-spinner-gap"></i> Đang tải thêm dữ liệu...</div>
                    <div id="scroll-anchor" style="height: 10px; width: 100%;"></div>
                </section>

                <!-- 3. LỊCH CHIẾU -->
                <section class="explore-section page-section" id="sec-schedule">
                    <h2 class="section-heading">Mới Cập Nhật</h2>
                    <div class="schedule-grid" id="schedule-grid">
                        <div class="flex-center" style="padding: 100px; color: var(--accent-cyan);"><i class="ph-bold ph-spinner-gap" style="font-size: 3rem; animation: spin 1s linear infinite;"></i></div>
                    </div>
                </section>
                
            </div>
        </main>

        <!-- MOBILE BOTTOM NAV -->
        <nav class="mobile-bottom-nav">
            <a href="#" class="mobile-nav-item active" id="m-nav-home" onclick="switchMainTab('home')">
                <i class="ph-fill ph-house"></i>
            </a>
            <a href="#" class="mobile-nav-item" id="m-nav-explore" onclick="switchMainTab('explore')">
                <i class="ph-fill ph-compass"></i>
            </a>
            <div class="mobile-nav-item story" onclick="openStoryMode()">
                <i class="ph-fill ph-play-circle"></i>
            </div>
            <a href="#" class="mobile-nav-item" id="m-nav-schedule" onclick="switchMainTab('schedule')">
                <i class="ph-fill ph-calendar-check"></i>
            </a>
            <div class="mobile-nav-item" onclick="openSidePanel('fav')">
                <div class="display-user-avatar" style="width: 26px; height: 26px; border-radius: 50%; overflow: hidden; display: flex; align-items: center; justify-content: center; background: linear-gradient(45deg, var(--accent-purple), var(--accent-cyan));">
                    <i class="ph-fill ph-user" style="color: white; font-size: 1.2rem;"></i>
                </div>
            </div>
        </nav>
    </div>

    <!-- RIGHT SIDE-PANEL (Library / Profile) -->
    <div class="side-panel-overlay" id="sp-overlay" onclick="closeSidePanel()"></div>
    <aside class="side-panel" id="side-panel">
        <div class="sp-header">
            <div class="sp-title" id="sp-title"><i class="ph-fill ph-bookmark"></i> Thư Viện</div>
            <div class="sp-close" onclick="closeSidePanel()"><i class="ph-bold ph-x"></i></div>
        </div>
        
        <div style="display: flex; align-items: center; gap: 16px; padding: 24px; border-bottom: 1px solid var(--border-glass); background: rgba(0,0,0,0.2);">
            <div class="display-user-avatar" style="width: 64px; height: 64px; border-radius: 16px; overflow: hidden; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan)); flex-shrink: 0; box-shadow: var(--shadow-glow);">
                <i class="ph-fill ph-user" style="color: white; font-size: 2.5rem;"></i>
            </div>
            <div>
                <div class="display-user-name" style="font-weight: 900; font-size: 1.3rem; color: var(--text-white);">Guest User</div>
                <div style="font-size: 0.85rem; color: var(--accent-cyan); font-weight: 800; background: rgba(6,182,212,0.1); padding: 4px 8px; border-radius: 6px; display: inline-block; margin-top: 4px;">Pro User <i class="ph-fill ph-check-circle"></i></div>
            </div>
        </div>

        <div class="sp-content custom-scrollbar" id="sp-content"></div>
    </aside>

    <!-- T-STORY MODAL -->
    <div class="story-modal" id="story-modal">
        <div class="story-header">
            <div class="story-logo">T-STORY</div>
            <button class="btn-close-story" onclick="closeStoryMode()"><i class="ph-bold ph-x"></i></button>
        </div>
        <div class="story-container" id="story-container">
            <div class="story-item flex-center" id="story-loading-init">
                <div class="spinner" style="border-color: rgba(255,255,255,0.2); border-top-color: var(--accent-cyan);"></div>
            </div>
        </div>
    </div>

    <!-- ==========================================================================
         JAVASCRIPT LOGIC
         ========================================================================== -->
    <script>
        // --- XỬ LÝ SCROLL TRẠNG THÁI NAV ---
        window.addEventListener('scroll', () => {
            const topHeader = document.querySelector('.top-header');
            if (window.scrollY > 50) topHeader.classList.add('scrolled');
            else topHeader.classList.remove('scrolled');
        });

        document.addEventListener("DOMContentLoaded", () => {
            if(window.innerWidth <= 768) {
                const mainInput = document.getElementById('search-input');
                const mobInput = document.getElementById('m-search-input');
                if (mainInput && mobInput) {
                    mobInput.addEventListener('input', (e) => { mainInput.value = e.target.value; });
                    mainInput.addEventListener('input', (e) => { mobInput.value = e.target.value; });
                }
            }
        });

        // --- DATA DICTIONARY ---
        const ALL_GENRES = [
            { name: 'Hành Động', slug: 'hanh-dong' }, { name: 'Tình Cảm', slug: 'tinh-cam' },
            { name: 'Hài Hước', slug: 'hai-huoc' }, { name: 'Cổ Trang', slug: 'co-trang' },
            { name: 'Tâm Lý', slug: 'tam-ly' }, { name: 'Hình Sự', slug: 'hinh-su' },
            { name: 'Chiến Tranh', slug: 'chien-tranh' }, { name: 'Thể Thao', slug: 'the-thao' },
            { name: 'Võ Thuật', slug: 'vo-thuat' }, { name: 'Viễn Tưởng', slug: 'vien-tuong' },
            { name: 'Phiêu Lưu', slug: 'phieu-luu' }, { name: 'Khoa Học', slug: 'khoa-hoc' },
            { name: 'Kinh Dị', slug: 'kinh-di' }, { name: 'Âm Nhạc', slug: 'am-nhac' },
            { name: 'Thần Thoại', slug: 'than-thoai' }, { name: 'Tài Liệu', slug: 'tai-lieu' },
            { name: 'Gia Đình', slug: 'gia-dinh' }, { name: 'Chính kịch', slug: 'chinh-kich' },
            { name: 'Bí ẩn', slug: 'bi-an' }, { name: 'Học Đường', slug: 'hoc-duong' },
            { name: 'Kinh Điển', slug: 'kinh-dien' }, { name: 'Phim 18+', slug: 'phim-18' },
            { name: 'Short Drama', slug: 'short-drama' }
        ];

        // --- STATE ---
        let selectedPrefs = new Set(); 
        let userPrefsSlugs = []; 
        let favorites = []; 
        let historyList = [];
        let downloadList = [];
        let currentPanelTab = 'fav';
        let currentAvatarUrl = 'https://api.dicebear.com/7.x/adventurer/svg?seed=Felix';
        
        let currentMovieData = null;
        let currentEpisodesList = [];
        let activeEpisode = null;
        let currentEpChunk = 0; 
        const EP_CHUNK_SIZE = 100;
        let exploreState = { currentTabSlug: '', apiPage: 1, localData: [], renderCount: 0, isFetching: false, hasMoreData: true };
        let scheduleLoaded = false;

        // --- DOM ---
        const ui = {
            appBg: document.getElementById('app-bg'),
            appWrapper: document.getElementById('app-wrapper'),
            loader: document.getElementById('loader'),
            
            onboardingModal: document.getElementById('onboarding-modal'),
            obStep1: document.getElementById('ob-step-1'),
            obStep2: document.getElementById('ob-step-2'),
            obInputName: document.getElementById('ob-input-name'),
            btnNextStep: document.getElementById('btn-next-step'),
            obGrid: document.getElementById('ob-genres-grid'),
            btnSavePrefs: document.getElementById('btn-save-prefs'),
            obInputAvatar: document.getElementById('ob-input-avatar'),
            
            playerWrapper: document.getElementById('player-wrapper'),
            movieTitle: document.getElementById('movie-title'),
            movieMeta: document.getElementById('movie-meta'),
            movieDesc: document.getElementById('movie-desc'),
            
            epGrid: document.getElementById('episodes-grid'),
            epCount: document.getElementById('ep-count'),
            epChunkSelect: document.getElementById('ep-chunk-select'),
            
            genreTabs: document.getElementById('genre-tabs-container'),
            exploreGrid: document.getElementById('explore-grid'),
            lazyLoader: document.getElementById('lazy-loader'),
            scrollAnchor: document.getElementById('scroll-anchor'),

            spOverlay: document.getElementById('sp-overlay'),
            sidePanel: document.getElementById('side-panel'),
            spTitle: document.getElementById('sp-title'),
            spContent: document.getElementById('sp-content'),
            
            themeIcon: document.getElementById('theme-icon'),
            themeText: document.getElementById('theme-text')
        };

        // ==========================================
        // 0. LOGIC THEME
        // ==========================================
        function initTheme() {
            const theme = localStorage.getItem('tanime_theme') || 'dark';
            if (theme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
                ui.themeIcon.className = 'ph-fill ph-moon';
                ui.themeText.textContent = 'Giao Diện Tối';
            }
            const color = localStorage.getItem('tanime_color') || 'default';
            if (color !== 'default') document.documentElement.setAttribute('data-color', color);
        }

        window.toggleTheme = () => {
            const current = document.documentElement.getAttribute('data-theme');
            if (current === 'light') {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('tanime_theme', 'dark');
                ui.themeIcon.className = 'ph-fill ph-sun';
                ui.themeText.textContent = 'Giao Diện Sáng';
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                localStorage.setItem('tanime_theme', 'light');
                ui.themeIcon.className = 'ph-fill ph-moon';
                ui.themeText.textContent = 'Giao Diện Tối';
            }
        };

        window.changeColorTheme = (themeId) => {
            document.documentElement.setAttribute('data-color', themeId);
            localStorage.setItem('tanime_color', themeId);
            renderSidePanel(); 
        };

        // ==========================================
        // 0.5. SPA ROUTING LOGIC
        // ==========================================
        window.switchMainTab = (tabId) => {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.mobile-nav-item').forEach(el => el.classList.remove('active'));
            
            const dNav = document.getElementById(`nav-${tabId}`);
            const mNav = document.getElementById(`m-nav-${tabId}`);
            if(dNav) dNav.classList.add('active');
            if(mNav) mNav.classList.add('active');

            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`sec-${tabId}`).classList.add('active');
            
            const mSearch = document.getElementById('mobile-search-sec');
            if(mSearch) mSearch.style.display = tabId === 'explore' ? 'block' : 'none';

            window.scrollTo({top: 0, behavior: 'smooth'});

            if (tabId === 'schedule' && !scheduleLoaded) loadScheduleData();
        };

        // ==========================================
        // 1. QUẢN LÝ RIGHT SIDE-PANEL
        // ==========================================
        function loadUserData() {
            const savedFavs = localStorage.getItem('tanime_favorites');
            if (savedFavs) favorites = JSON.parse(savedFavs);
            const savedHistory = localStorage.getItem('tanime_history');
            if (savedHistory) historyList = JSON.parse(savedHistory);
            const savedDownloads = localStorage.getItem('tanime_downloads');
            if (savedDownloads) downloadList = JSON.parse(savedDownloads);
        }

        window.openSidePanel = (tab) => {
            currentPanelTab = tab;
            const headers = { 
                'fav': '<i class="ph-fill ph-heart" style="color:var(--accent-red)"></i> Phim Yêu Thích', 
                'history': '<i class="ph-fill ph-clock-counter-clockwise" style="color:var(--accent-yellow)"></i> Lịch Sử Xem', 
                'download': '<i class="ph-fill ph-download-simple" style="color:var(--accent-cyan)"></i> Đã Tải Xuống', 
                'theme': '<i class="ph-fill ph-palette" style="color:var(--accent-purple)"></i> Chủ Đề Màu Sắc' 
            };
            ui.spTitle.innerHTML = headers[tab];
            
            ui.spOverlay.classList.add('show');
            ui.sidePanel.classList.add('open');
            renderSidePanel();
        };

        window.closeSidePanel = () => {
            ui.sidePanel.classList.remove('open');
            setTimeout(() => ui.spOverlay.classList.remove('show'), 400);
        };

        function renderSidePanel() {
            if (currentPanelTab === 'theme') {
                const themes = [
                    { id: 'default', color1: '#1E50FF', color2: '#00D1F5', name: 'Deep Space' },
                    { id: 'emerald', color1: '#059669', color2: '#10B981', name: 'Neon Emerald' },
                    { id: 'rose', color1: '#BE123C', color2: '#F43F5E', name: 'Crimson Surge' },
                    { id: 'amber', color1: '#D97706', color2: '#F59E0B', name: 'Solar Flare' },
                    { id: 'purple', color1: '#7C3AED', color2: '#A855F7', name: 'Cyber Glow' }
                ];
                const currentTheme = localStorage.getItem('tanime_color') || 'default';
                
                ui.spContent.innerHTML = `
                    <div class="theme-grid">
                        ${themes.map(t => `
                            <div class="theme-card ${currentTheme === t.id ? 'active' : ''}" onclick="changeColorTheme('${t.id}')">
                                <div class="theme-swatch-box" style="background: linear-gradient(135deg, ${t.color1} 0%, ${t.color2} 100%);"></div>
                                <div class="theme-name">${t.name}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                return;
            }

            let data = [];
            let emptyMsg = "";
            let onRemove = "";
            
            if (currentPanelTab === 'fav') { data = favorites; emptyMsg = "Kho phim trống."; onRemove = "removeFromFav"; } 
            else if (currentPanelTab === 'history') { data = historyList; emptyMsg = "Chưa có lịch sử."; onRemove = "removeFromHistory"; } 
            else if (currentPanelTab === 'download') { data = downloadList; emptyMsg = "Chưa có phim tải về."; onRemove = "removeFromDownloads"; }

            if (data.length === 0) {
                ui.spContent.innerHTML = `<div class="sp-empty"><i class="ph-fill ph-ghost" style="font-size:3rem; margin-bottom:16px; opacity:0.3;"></i><br>${emptyMsg}</div>`;
                return;
            }
            
            ui.spContent.innerHTML = data.map((item, index) => `
                <div class="sp-list-item" onclick="loadMovieDetailAndGoHome('${item.slug}'); closeSidePanel();">
                    <div class="sp-thumb"><img src="${item.thumb_url.startsWith('http') ? item.thumb_url : 'https://img.ophim.live/uploads/movies/' + item.thumb_url}" onerror="this.src='https://via.placeholder.com/64x90/1F2937/00D1F5'"></div>
                    <div class="sp-info">
                        <div class="sp-item-title">${item.name}</div>
                        ${item.epName ? `<div class="sp-item-sub">${item.epName}</div>` : ''}
                        ${item.time ? `<div class="sp-item-time">${item.time}</div>` : ''}
                    </div>
                    <button class="sp-btn-remove" onclick="event.stopPropagation(); window.${onRemove}(${index})"><i class="ph-bold ph-trash"></i></button>
                </div>
            `).join('');
        }

        window.loadMovieDetailAndGoHome = (slug) => {
            switchMainTab('home');
            loadMovieDetailAndScroll(slug);
        }

        window.removeFromFav = (idx) => { favorites.splice(idx, 1); localStorage.setItem('tanime_favorites', JSON.stringify(favorites)); renderSidePanel(); updateMainPlayerFavUI(); };
        window.removeFromHistory = (idx) => { historyList.splice(idx, 1); localStorage.setItem('tanime_history', JSON.stringify(historyList)); renderSidePanel(); };
        window.removeFromDownloads = (idx) => { downloadList.splice(idx, 1); localStorage.setItem('tanime_downloads', JSON.stringify(downloadList)); renderSidePanel(); };

        function toggleFavorite(movieObj) {
            const index = favorites.findIndex(f => f.slug === movieObj.slug);
            if (index > -1) favorites.splice(index, 1); 
            else favorites.unshift({ slug: movieObj.slug, name: movieObj.name, thumb_url: movieObj.thumb_url });
            localStorage.setItem('tanime_favorites', JSON.stringify(favorites));
            if(currentPanelTab === 'fav') renderSidePanel();
            updateMainPlayerFavUI();
            return index === -1; 
        }

        function addToHistory(movie, episode) {
            if (!movie || !episode) return;
            const now = new Date();
            const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')} - ${now.getDate()}/${now.getMonth()+1}/${now.getFullYear()}`;
            historyList = historyList.filter(h => h.slug !== movie.slug);
            historyList.unshift({ slug: movie.slug, name: movie.name, thumb_url: movie.thumb_url, epName: episode.name, time: timeStr });
            if (historyList.length > 30) historyList.pop(); 
            localStorage.setItem('tanime_history', JSON.stringify(historyList));
            if (currentPanelTab === 'history') renderSidePanel();
        }

        // ==========================================
        // 1.5 CRAWL DATA SCRIPT
        // ==========================================
        let isScanning = false;
        let scanFormat = 'json';
        let scannedData = [];
        
        const scanUI = {
            modal: document.getElementById('scan-modal'),
            initView: document.getElementById('scan-init-view'),
            progressView: document.getElementById('scan-progress-view'),
            progressFill: document.getElementById('scan-progress-fill'),
            status: document.getElementById('scan-status'),
            stats: document.getElementById('scan-stats')
        };

        window.openScanModal = () => { scanUI.modal.style.display = 'flex'; scanUI.initView.style.display = 'block'; scanUI.progressView.style.display = 'none'; };
        window.closeScanModal = () => { if (isScanning && !confirm("Bạn có chắc muốn đóng? Quá trình quét sẽ bị dừng lại!")) return; isScanning = false; scanUI.modal.style.display = 'none'; };

        window.startScan = async (format) => {
            scanFormat = format; isScanning = true; scannedData = [];
            scanUI.initView.style.display = 'none'; scanUI.progressView.style.display = 'block'; scanUI.progressFill.style.width = '0%'; scanUI.stats.textContent = 'Đã quét: 0 phim';

            try {
                scanUI.status.textContent = "Đang phân tích cấu trúc dữ liệu...";
                const initialRes = await fetch('https://ophim1.com/v1/api/danh-sach/hoat-hinh?page=1');
                const initialData = await initialRes.json();
                const totalPages = initialData.data?.params?.pagination?.totalPages || 1442;
                
                for (let page = 1; page <= totalPages; page++) {
                    if (!isScanning) break;
                    scanUI.status.textContent = `Đang lấy danh sách phim trang ${page} / ${totalPages}...`;
                    const pageRes = await fetch(`https://ophim1.com/v1/api/danh-sach/hoat-hinh?page=${page}`);
                    const pageData = await pageRes.json();
                    const items = pageData.data.items;

                    for (let i = 0; i < items.length; i += 5) {
                        if (!isScanning) break;
                        const batch = items.slice(i, i + 5);
                        scanUI.status.textContent = `Đang quét chi tiết phim trang ${page}... (${i+1} đến ${i + batch.length} / ${items.length})`;
                        
                        await Promise.all(batch.map(async (item) => {
                            try {
                                const detailRes = await fetch(`https://ophim1.com/phim/${item.slug}`);
                                const detailData = await detailRes.json();
                                if (detailData.status && detailData.movie) {
                                    const m = detailData.movie;
                                    let m3u8_links = "";
                                    if (detailData.episodes && detailData.episodes.length > 0 && detailData.episodes[0].server_data) {
                                        m3u8_links = detailData.episodes[0].server_data.map(ep => ep.link_m3u8).filter(link => link).join(', ');
                                    }
                                    scannedData.push({
                                        id: m._id, name: m.name, origin_name: m.origin_name, year: m.year,
                                        quality: m.quality, lang: m.lang, episode_current: m.episode_current,
                                        content: m.content ? m.content.replace(/<[^>]*>?/gm, '').replace(/(\r\n|\n|\r)/gm, " ").trim() : "",
                                        thumb_url: m.thumb_url, poster_url: m.poster_url, m3u8_links: m3u8_links 
                                    });
                                }
                            } catch (e) { console.error(e); }
                        }));
                        scanUI.stats.textContent = `Đã quét: ${scannedData.length} phim`;
                    }
                    scanUI.progressFill.style.width = `${(page / totalPages) * 100}%`;
                }
                if (isScanning) { scanUI.status.textContent = "Hoàn tất quét dữ liệu!"; finishScan(); }
            } catch (error) { scanUI.status.textContent = "Có lỗi xảy ra!"; isScanning = false; }
        };

        window.stopScan = () => { isScanning = false; scanUI.status.textContent = "Đã dừng. Đang chuẩn bị file tải xuống..."; setTimeout(finishScan, 1000); };

        function finishScan() {
            isScanning = false;
            if (scannedData.length === 0) { alert("Không có dữ liệu nào được quét!"); closeScanModal(); return; }
            if (scanFormat === 'json') {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(scannedData, null, 2));
                triggerDownload(dataStr, `ophim_data_${Date.now()}.json`);
            } else {
                const header = Object.keys(scannedData[0]);
                const replacer = (key, value) => value === null ? '' : value.toString().replace(/"/g, '""');
                const csv = scannedData.map(row => header.map(fieldName => `"${replacer(fieldName, row[fieldName])}"`).join(','));
                csv.unshift(header.join(','));
                const blob = new Blob(["\uFEFF" + csv.join('\r\n')], { type: 'text/csv;charset=utf-8;' });
                triggerDownload(URL.createObjectURL(blob), `ophim_data_${Date.now()}.csv`);
            }
            closeScanModal();
        }

        function triggerDownload(url, filename) {
            const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
        }

        // ==========================================
        // 2. ONBOARDING & INIT 
        // ==========================================
        function checkOnboarding() {
            initTheme();
            loadUserData(); 
            const saved = localStorage.getItem('tanime_prefs');
            if (saved) {
                userPrefsSlugs = JSON.parse(saved);
                applyUserProfile();
                initApp(); 
            } else {
                ui.obGrid.innerHTML = ALL_GENRES.map(g => `<div class="ob-pill" data-slug="${g.slug}" onclick="togglePref(this)">${g.name}</div>`).join('');
                
                ui.obInputName.addEventListener('input', () => {
                    ui.btnNextStep.disabled = ui.obInputName.value.trim() === '';
                });

                ui.loader.style.display = 'none';
                ui.onboardingModal.style.display = 'flex';
                ui.obStep1.style.display = 'block';
                ui.obStep2.style.display = 'none';
            }
        }

        window.goToOnboardingStep2 = () => {
            ui.obStep1.style.display = 'none';
            ui.obStep2.style.display = 'block';
            validateStep2();
        };

        window.goToOnboardingStep1 = () => {
            ui.obStep2.style.display = 'none';
            ui.obStep1.style.display = 'block';
        };

        window.selectPresetAvatar = (el) => {
            document.querySelectorAll('.preset-img').forEach(img => img.classList.remove('active'));
            el.classList.add('active');
            currentAvatarUrl = el.src;
            document.getElementById('ob-preview-img').src = currentAvatarUrl;
        };

        window.updateAvatarPreview = (val) => {
            const previewImg = document.getElementById('ob-preview-img');
            if(val) previewImg.src = val;
            else previewImg.src = 'https://api.dicebear.com/7.x/adventurer/svg?seed=Felix';
        };

        window.togglePref = (el) => {
            const slug = el.getAttribute('data-slug');
            if (selectedPrefs.has(slug)) { selectedPrefs.delete(slug); el.classList.remove('active'); } 
            else { selectedPrefs.add(slug); el.classList.add('active'); }
            validateStep2();
        };

        function validateStep2() {
            ui.btnSavePrefs.disabled = selectedPrefs.size === 0;
        }

        window.savePreferences = () => {
            userPrefsSlugs = Array.from(selectedPrefs);
            localStorage.setItem('tanime_prefs', JSON.stringify(userPrefsSlugs));
            
            const nameInput = ui.obInputName.value.trim();
            const userProfile = {
                name: nameInput || 'Guest User',
                avatar: currentAvatarUrl
            };
            localStorage.setItem('tanime_profile', JSON.stringify(userProfile));

            applyUserProfile();
            ui.onboardingModal.style.display = 'none';
            ui.loader.style.display = 'flex';
            initApp();
        };

        function applyUserProfile() {
            const savedProfile = localStorage.getItem('tanime_profile');
            if (savedProfile) {
                const profile = JSON.parse(savedProfile);
                
                document.querySelectorAll('.display-user-name').forEach(el => {
                    el.textContent = profile.name;
                });
                
                if (profile.avatar) {
                    const fallbackHTML = `<i class='ph-fill ph-user' style='color: white; font-size: inherit;'></i>`;
                    const avatarImgHTML = `<img src="${profile.avatar}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.outerHTML=\`${fallbackHTML}\`">`;
                    
                    document.querySelectorAll('.display-user-avatar').forEach(el => {
                        el.innerHTML = avatarImgHTML;
                    });
                }
            }
        }

        async function initApp() {
            try {
                const searchRes = await fetch('https://ophim1.com/v1/api/tim-kiem?keyword=overlord');
                const searchData = await searchRes.json();
                
                if (searchData.status === 'success' && searchData.data.items.length > 0) {
                    await loadMovieDetail(searchData.data.items[0].slug);
                } else {
                    const res = await fetch('https://ophim1.com/v1/api/danh-sach/hoat-hinh?page=1');
                    const data = await res.json();
                    if (data.status === 'success' && data.data.items.length > 0) {
                        await loadMovieDetail(data.data.items[0].slug);
                    }
                }

                renderGenreTabs();
                switchTab(userPrefsSlugs.length > 0 ? userPrefsSlugs[0] : ALL_GENRES[0].slug);
                
                ui.appWrapper.style.display = 'flex';
                setTimeout(() => { ui.appWrapper.style.opacity = '1'; }, 100);

            } catch (error) { console.error(error); } 
            finally { ui.loader.style.display = 'none'; }
        }

        // ==========================================
        // 3. MAIN PLAYER LOGIC
        // ==========================================
        function setHeroLoadingState() {
            ui.playerWrapper.innerHTML = `<div class="flex-center" style="width:100%;height:100%;"><div class="spinner"></div></div>`;
            ui.movieTitle.innerHTML = `<div class="skeleton-block" style="width: 80%; height: 40px; margin-bottom: 8px;"></div><div class="skeleton-block" style="width: 50%; height: 40px;"></div>`;
            ui.movieDesc.innerHTML = `<div class="skeleton-block" style="width: 100%; height: 16px; margin-bottom: 8px;"></div><div class="skeleton-block" style="width: 90%; height: 16px; margin-bottom: 8px;"></div><div class="skeleton-block" style="width: 70%; height: 16px;"></div>`;
            
            const btnSave = document.getElementById('btn-save');
            if(btnSave) {
                btnSave.className = 'btn-pill';
                btnSave.innerHTML = `<i class="ph-bold ph-heart"></i> <span class="action-text">Lưu</span>`;
            }
        }

        async function loadMovieDetail(slug) {
            setHeroLoadingState();
            try {
                const res = await fetch(`https://ophim1.com/phim/${slug}`);
                const data = await res.json();
                if (data.status) {
                    currentEpChunk = 0; 
                    currentMovieData = data.movie;
                    currentEpisodesList = data.episodes[0]?.server_data || [];
                    activeEpisode = currentEpisodesList.length > 0 ? currentEpisodesList[0] : null;

                    const bgUrl = `https://img.ophim.live/uploads/movies/${currentMovieData.poster_url || currentMovieData.thumb_url}`;
                    ui.appBg.style.backgroundImage = `url('${bgUrl}')`;

                    renderPlayer();
                    renderMovieInfo();
                    renderEpisodes();
                }
            } catch (error) { console.error(error); }
        }

        function renderPlayer() {
            if (activeEpisode) {
                ui.playerWrapper.innerHTML = `<iframe src="${activeEpisode.link_embed}" allowfullscreen title="Anime Player"></iframe>`;
            } else {
                ui.playerWrapper.innerHTML = `<div class="flex-center" style="width:100%;height:100%;color:var(--text-muted);"><i class="ph-bold ph-monitor-play" style="font-size:48px;"></i></div>`;
            }
        }

        function renderMovieInfo() {
            const m = currentMovieData;
            ui.movieTitle.textContent = m.name;
            ui.movieDesc.innerHTML = m.content ? m.content.replace(/<[^>]*>?/gm, '').substring(0, 450) + '...' : 'Đang cập nhật...';
            
            ui.movieMeta.innerHTML = `
                <span class="tag-rating"><i class="ph-fill ph-star"></i> ${m.tmdb?.vote_average || '9.5'}</span>
                <span class="tag-box">${m.quality || 'FHD'}</span>
                <span class="tag-box">${m.lang || 'Vietsub'}</span>
                <span class="tag-box">${m.year}</span>
                <span style="color: var(--text-muted);"><i class="ph-bold ph-clock"></i> ${m.time || '24 Phút/Tập'}</span>
            `;
            updateMainPlayerFavUI();
        }

        function updateMainPlayerFavUI() {
            if(!currentMovieData) return;
            const isLiked = favorites.some(f => f.slug === currentMovieData.slug);
            const btnSave = document.getElementById('btn-save'); 
            if(btnSave) {
                btnSave.className = `btn-pill ${isLiked ? 'saved' : ''}`;
                btnSave.innerHTML = `<i class="${isLiked ? 'ph-fill' : 'ph-bold'} ph-heart"></i> <span class="action-text">${isLiked ? 'Đã Lưu' : 'Lưu'}</span>`;
            }
        }

        function renderEpisodes() {
            ui.epCount.textContent = `${currentEpisodesList.length} Tập`;
            const totalChunks = Math.ceil(currentEpisodesList.length / EP_CHUNK_SIZE);
            if (totalChunks > 1) {
                ui.epChunkSelect.style.display = 'block';
                ui.epChunkSelect.innerHTML = Array.from({length: totalChunks}).map((_, i) => {
                    const start = i * EP_CHUNK_SIZE + 1;
                    const end = Math.min((i + 1) * EP_CHUNK_SIZE, currentEpisodesList.length);
                    return `<option value="${i}" ${i === currentEpChunk ? 'selected' : ''}>Tập ${start} - ${end}</option>`;
                }).join('');
            } else ui.epChunkSelect.style.display = 'none';

            const startIdx = currentEpChunk * EP_CHUNK_SIZE;
            const endIdx = startIdx + EP_CHUNK_SIZE;
            const epsToRender = currentEpisodesList.slice(startIdx, endIdx);

            ui.epGrid.innerHTML = epsToRender.map((ep, idx) => {
                const realIdx = startIdx + idx; 
                const isActive = activeEpisode && activeEpisode.slug === ep.slug;
                return `<button class="btn-episode ${isActive ? 'active' : ''}" title="${ep.name}" onclick="selectEpisode(${realIdx}, this)">${ep.name}</button>`;
            }).join('');
        }

        window.changeEpChunk = (val) => { currentEpChunk = parseInt(val); renderEpisodes(); };
        
        window.selectEpisode = (idx, btnEl) => {
            activeEpisode = currentEpisodesList[idx];
            currentEpChunk = Math.floor(idx / EP_CHUNK_SIZE); 
            renderPlayer(); 
            renderEpisodes(); 
            addToHistory(currentMovieData, activeEpisode);
            
            setTimeout(() => {
                const activeBtn = document.querySelector('.btn-episode.active');
                if(activeBtn && ui.epGrid) {
                    const scrollPos = activeBtn.offsetTop - ui.epGrid.offsetTop - (ui.epGrid.clientHeight / 2) + (activeBtn.clientHeight / 2);
                    ui.epGrid.scrollTo({ top: scrollPos, behavior: 'smooth' });
                }
            }, 100);

            const offset = window.innerWidth <= 1024 ? 80 : 0;
            const mainCol = document.querySelector('.main-column');
            if (mainCol) {
                const topPos = mainCol.getBoundingClientRect().top + window.pageYOffset - offset;
                window.scrollTo({ top: topPos, behavior: 'smooth' });
            } else {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        // --- TẢI VIDEO ---
        window.downloadCurrentEpisode = async () => {
            if (!currentMovieData || !activeEpisode) return;
            const btn = document.getElementById('btn-download');
            if (btn.classList.contains('downloading')) return;
            const m3u8Link = activeEpisode.link_m3u8;
            if (!m3u8Link) { alert("Lỗi tải video!"); return; }

            btn.classList.add('downloading');
            btn.innerHTML = `<i class="ph-bold ph-spinner-gap" style="animation: spin 1s linear infinite;"></i> <span class="action-text">Đang phân tích...</span>`;
            try {
                const fetchText = async (url) => { const res = await fetch(url); return await res.text(); };
                let manifest = await fetchText(m3u8Link);
                let baseUrl = m3u8Link.substring(0, m3u8Link.lastIndexOf('/') + 1);

                if (manifest.includes('#EXT-X-STREAM-INF')) {
                    const lines = manifest.split('\n'); let bestUrl = '';
                    for (let i = 0; i < lines.length; i++) {
                        if (lines[i].includes('#EXT-X-STREAM-INF')) { let n = lines[i+1].trim(); if(n) bestUrl = n; }
                    }
                    if (bestUrl) {
                        if (!bestUrl.startsWith('http')) bestUrl = baseUrl + bestUrl;
                        manifest = await fetchText(bestUrl); baseUrl = bestUrl.substring(0, bestUrl.lastIndexOf('/') + 1);
                    }
                }

                const tsUrls = [];
                for (let line of manifest.split('\n')) {
                    line = line.trim(); if (line && !line.startsWith('#')) tsUrls.push(line.startsWith('http') ? line : baseUrl + line);
                }
                if (tsUrls.length === 0) throw new Error("No TS");

                const chunks = new Array(tsUrls.length); let dlCount = 0;
                for (let i = 0; i < tsUrls.length; i += 5) {
                    const batch = tsUrls.slice(i, i + 5);
                    const promises = batch.map(async (url, idx) => {
                        const res = await fetch(url); const buffer = await res.arrayBuffer();
                        return { index: i + idx, buffer };
                    });
                    const results = await Promise.all(promises);
                    for (const r of results) chunks[r.index] = r.buffer;
                    dlCount += batch.length;
                    btn.innerHTML = `<i class="ph-bold ph-spinner-gap" style="animation: spin 1s linear infinite;"></i> <span class="action-text">${Math.floor((dlCount / tsUrls.length) * 100)}%</span>`;
                }

                btn.innerHTML = `<i class="ph-bold ph-spinner-gap" style="animation: spin 1s linear infinite;"></i> <span class="action-text">Đang ghép...</span>`;
                const blob = new Blob(chunks, { type: 'video/mp2t' });
                const url = window.URL.createObjectURL(blob);
                
                const a = document.createElement('a'); a.style.display = 'none'; a.href = url;
                a.download = `${currentMovieData.slug}-tap-${activeEpisode.name}.ts`;
                document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); document.body.removeChild(a);
                
                if (!downloadList.some(d => d.slug === currentMovieData.slug && d.epName === activeEpisode.name)) {
                    downloadList.unshift({ slug: currentMovieData.slug, name: currentMovieData.name, thumb_url: currentMovieData.thumb_url, epName: activeEpisode.name, time: `Đã tải hôm nay` });
                    localStorage.setItem('tanime_downloads', JSON.stringify(downloadList));
                    if (currentPanelTab === 'download') renderSidePanel();
                }
                
                btn.classList.remove('downloading'); btn.innerHTML = `<i class="ph-bold ph-check"></i> <span class="action-text">Hoàn tất</span>`;
                setTimeout(() => { if(btn) btn.innerHTML = `<i class="ph-bold ph-download-simple"></i> <span class="action-text">Tải Về</span>`; }, 3000);
            } catch (error) {
                if (confirm("Lỗi mạng/CORS. Mở link gốc để tải bằng phần mềm thứ 3?")) {
                    const a = document.createElement('a'); a.href = m3u8Link; a.target = '_blank'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
                }
                btn.classList.remove('downloading'); btn.innerHTML = `<i class="ph-bold ph-download-simple"></i> <span class="action-text">Tải Về</span>`;
            }
        };

        // ==========================================
        // 4. BINDING SEARCH LOGIC
        // ==========================================
        function initSearchLogic(inputId, dropdownId) {
            let searchTimeout;
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            if(!input || !dropdown) return;

            input.addEventListener('input', (e) => {
                const query = e.target.value.trim(); clearTimeout(searchTimeout);
                if (!query) { dropdown.style.display = 'none'; return; }
                dropdown.style.display = 'block';
                dropdown.innerHTML = `<div class="search-msg"><i class="ph-bold ph-spinner-gap" style="animation:spin 1s linear infinite;"></i> Đang dò tìm tín hiệu...</div>`;
                
                searchTimeout = setTimeout(async () => {
                    try {
                        const res = await fetch(`https://ophim1.com/v1/api/tim-kiem?keyword=${encodeURIComponent(query)}`);
                        const data = await res.json();
                        if (data.status === 'success' && data.data.items.length > 0) {
                            dropdown.innerHTML = data.data.items.map(item => `
                                <div class="search-item" onclick="loadMovieDetailAndGoHome('${item.slug}'); document.getElementById('${dropdownId}').style.display='none'; document.getElementById('${inputId}').value='';">
                                    <div class="search-thumb"><img src="https://img.ophim.live/uploads/movies/${item.thumb_url}" onerror="this.src='https://via.placeholder.com/54x76/1F2937/00D1F5'"></div>
                                    <div class="search-info">
                                        <div class="search-title">${item.name}</div>
                                        <div class="search-origin">${item.origin_name}</div>
                                    </div>
                                </div>
                            `).join('');
                        } else dropdown.innerHTML = `<div class="search-msg">Không tìm thấy Anime.</div>`;
                    } catch (error) {}
                }, 500);
            });

            document.addEventListener('click', (e) => { if (!input.contains(e.target) && !dropdown.contains(e.target)) dropdown.style.display = 'none'; });
            input.addEventListener('focus', () => { if(input.value.trim()) dropdown.style.display = 'block'; });
        }

        initSearchLogic('search-input', 'search-dropdown');
        initSearchLogic('m-search-input', 'm-search-dropdown');

        // ==========================================
        // 5. LOGIC EXPLORE
        // ==========================================
        function renderGenreTabs() {
            const sortedGenres = [...ALL_GENRES].sort((a, b) => userPrefsSlugs.includes(b.slug) - userPrefsSlugs.includes(a.slug));
            ui.genreTabs.innerHTML = sortedGenres.map(g => `<button class="tab-btn ${userPrefsSlugs.includes(g.slug) ? 'recommended' : ''}" id="tab-${g.slug}" onclick="switchTab('${g.slug}')">${g.name}</button>`).join('');
        }

        window.switchTab = async (slug) => {
            if (exploreState.currentTabSlug === slug) return;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const aTab = document.getElementById(`tab-${slug}`);
            if(aTab) { aTab.classList.add('active'); aTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' }); }

            exploreState = { currentTabSlug: slug, apiPage: 1, localData: [], renderCount: 0, isFetching: false, hasMoreData: true };
            ui.exploreGrid.innerHTML = '';
            await fetchMoreGenreData();
        };

        async function fetchMoreGenreData() {
            if (exploreState.isFetching || !exploreState.hasMoreData) return;
            exploreState.isFetching = true; ui.lazyLoader.style.display = 'block';
            try {
                const res = await fetch(`https://ophim1.com/v1/api/the-loai/${exploreState.currentTabSlug}?page=${exploreState.apiPage}`);
                const data = await res.json();
                if (data.status === 'success' && data.data.items.length > 0) {
                    exploreState.localData.push(...data.data.items); exploreState.apiPage++; append10ItemsToGrid();
                } else exploreState.hasMoreData = false;
            } catch (error) { console.error(error); } 
            finally { exploreState.isFetching = false; ui.lazyLoader.style.display = 'none'; }
        }

        function append10ItemsToGrid() {
            const items = exploreState.localData.slice(exploreState.renderCount, exploreState.renderCount + 10);
            if (items.length === 0) { if(exploreState.hasMoreData && !exploreState.isFetching) fetchMoreGenreData(); return; }

            const html = items.map(item => `
                <div class="anime-card" onclick="loadMovieDetailAndGoHome('${item.slug}')">
                    <div class="ac-thumb">
                        <img src="https://img.ophim.live/uploads/movies/${item.thumb_url}" onerror="this.src='https://via.placeholder.com/200x300/1F2937/00D1F5'">
                        <div class="ac-overlay"></div>
                        <div class="ac-ep">${item.episode_current || 'Tập 1'}</div>
                        <div class="ac-play-btn"><i class="ph-fill ph-play"></i></div>
                    </div>
                    <div class="ac-info">
                        <div class="ac-title">${item.name}</div>
                        <div class="ac-year">${item.year}</div>
                    </div>
                </div>
            `).join('');
            ui.exploreGrid.insertAdjacentHTML('beforeend', html);
            exploreState.renderCount += items.length;
        }

        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting) { exploreState.renderCount >= exploreState.localData.length ? fetchMoreGenreData() : append10ItemsToGrid(); }
        }, { rootMargin: '0px 0px 800px 0px' }); 
        observer.observe(ui.scrollAnchor);

        // ==========================================
        // 5B. LOGIC SCHEDULE
        // ==========================================
        async function loadScheduleData() {
            if(scheduleLoaded) return;
            const scheduleGrid = document.getElementById('schedule-grid');
            try {
                const res = await fetch('https://ophim1.com/danh-sach/phim-moi-cap-nhat?page=1');
                const data = await res.json();
                if(data.status && data.items) {
                    scheduleGrid.innerHTML = data.items.map(item => {
                        const date = new Date(item.modified.time);
                        const timeStr = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')} - ${date.getDate()}/${date.getMonth()+1}`;
                        return `
                        <div class="sc-card" onclick="loadMovieDetailAndGoHome('${item.slug}')">
                            <div class="sc-thumb"><img src="https://img.ophim.live/uploads/movies/${item.thumb_url}" onerror="this.src='https://via.placeholder.com/80x110/1F2937/00D1F5'"></div>
                            <div class="sc-info">
                                <h3 class="sc-title">${item.name}</h3>
                                <div class="sc-ep">${item.episode_current || 'Tập mới'}</div>
                                <div class="sc-time"><i class="ph-fill ph-clock"></i> Cập nhật: ${timeStr}</div>
                            </div>
                            <div class="sc-btn"><i class="ph-bold ph-play"></i></div>
                        </div>
                    `}).join('');
                    scheduleLoaded = true;
                }
            } catch(e) {
                scheduleGrid.innerHTML = `<div style="color:var(--text-muted); text-align:center;">Lỗi tải lịch chiếu.</div>`;
            }
        }

        // ==========================================
        // 6. T-STORY LOGIC
        // ==========================================
        const storyDOM = { modal: document.getElementById('story-modal'), container: document.getElementById('story-container'), loadingInit: document.getElementById('story-loading-init') };
        let storyCache = []; let isLoadingStory = false; let storyObserver; let videoPlaybackObserver;

        window.openStoryMode = () => { document.body.classList.add('modal-open'); storyDOM.modal.style.display = 'flex'; if (storyCache.length === 0) { initStoryObserver(); loadMoreStories(3); } };
        window.closeStoryMode = () => { document.body.classList.remove('modal-open'); storyDOM.modal.style.display = 'none'; storyDOM.container.querySelectorAll('iframe').forEach(iframe => iframe.src = ''); };

        function initStoryObserver() {
            storyObserver = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting && entry.target.dataset.isLast === 'true') { entry.target.dataset.isLast = 'false'; loadMoreStories(2); } }); }, { threshold: 0.5 });
            videoPlaybackObserver = new IntersectionObserver((entries) => { 
                entries.forEach(entry => { 
                    const iframe = entry.target.querySelector('iframe'); 
                    if (!iframe) return; 
                    if (entry.isIntersecting) { 
                        if (!iframe.src || iframe.src.includes('about:blank')) {
                            const loader = entry.target.querySelector('.story-video-loader');
                            if(loader) loader.style.display = 'flex';
                            iframe.src = iframe.dataset.src; 
                            iframe.onload = () => { if(loader) loader.style.display = 'none'; };
                        } 
                    } 
                }); 
            }, { threshold: 0.6 }); 
        }

        async function loadMoreStories(count) {
            if (isLoadingStory) return; isLoadingStory = true;
            try {
                const initRes = await fetch(`https://ophim1.com/v1/api/danh-sach/hoat-hinh?page=1`);
                const initData = await initRes.json();
                const totalPages = initData.data?.params?.pagination?.totalPages || 10;
                const randomPage = Math.floor(Math.random() * Math.min(totalPages, 50)) + 1;
                
                const listRes = await fetch(`https://ophim1.com/v1/api/danh-sach/hoat-hinh?page=${randomPage}`);
                const listData = await listRes.json();
                if (listData.status === 'success') {
                    const items = listData.data.items.sort(() => 0.5 - Math.random()).slice(0, count);
                    for (const item of items) {
                        const detailRes = await fetch(`https://ophim1.com/phim/${item.slug}`); const detailData = await detailRes.json();
                        if (detailData.status && detailData.episodes[0]?.server_data.length > 0) {
                            const m = detailData.movie; const eps = detailData.episodes[0].server_data; 
                            const firstEpIndex = 0; 
                            const firstEp = eps[firstEpIndex];
                            
                            const storyObj = { 
                                slug: m.slug, name: m.name, content: m.content ? m.content.replace(/<[^>]*>?/gm, '').substring(0, 150) + '...' : '', 
                                thumb_url: m.thumb_url, poster_url: m.poster_url, link: firstEp.link_embed, isLiked: favorites.some(f => f.slug === m.slug),
                                episodes: eps, currentEpIndex: firstEpIndex
                            };
                            storyCache.push(storyObj); appendStoryToDOM(storyObj);
                        }
                    }
                }
            } catch (error) {} finally { isLoadingStory = false; if(storyDOM.loadingInit) storyDOM.loadingInit.style.display = 'none'; }
        }

        function appendStoryToDOM(story) {
            const itemDiv = document.createElement('div'); itemDiv.className = 'story-item';
            const safeObjStr = JSON.stringify({slug: story.slug, name: story.name, thumb_url: story.thumb_url}).replace(/"/g, '&quot;');
            
            const epsHtml = story.episodes.map((ep, idx) =>
                `<button class="btn-episode ${idx === story.currentEpIndex ? 'active' : ''}" onclick="playStoryEpisode(this, '${ep.link_embed}')" title="${ep.name}">${ep.name}</button>`
            ).join('');

            itemDiv.innerHTML = `
                <div class="story-layout-container">
                    <div class="story-video-area">
                        <div class="story-video-loader">
                            <div class="spinner" style="border-color: rgba(255,255,255,0.1); border-top-color: var(--accent-cyan); width: 40px; height: 40px; border-width: 3px;"></div>
                        </div>
                        <iframe data-src="${story.link}" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                    </div>

                    <div class="story-content-area">
                        <div class="story-overlay-bg"></div>
                        
                        <div class="story-meta">
                            <h3 class="story-title">${story.name}</h3>
                            <p class="story-desc">${story.content}</p>
                            <button class="btn-watch-now" onclick="watchFromStory('${story.slug}')"><i class="ph-fill ph-play"></i> Xem Full Bộ</button>
                        </div>
                        
                        <div class="story-actions">
                            <button class="action-icon ${story.isLiked ? 'liked' : ''}" onclick="toggleStoryLike(this, ${safeObjStr})">
                                <div class="icon-bg"><i class="${story.isLiked ? 'ph-fill' : 'ph-bold'} ph-heart"></i></div><span>Thích</span>
                            </button>
                            <button class="action-icon action-ep-btn" onclick="toggleMobileEpisodes(this)">
                                <div class="icon-bg"><i class="ph-bold ph-list-dashes"></i></div><span>Tập phim</span>
                            </button>
                            <button class="action-icon" onclick="shareStory()">
                                <div class="icon-bg"><i class="ph-fill ph-share-fat"></i></div><span>Chia sẻ</span>
                            </button>
                        </div>
                        
                        <div class="story-episodes-sheet">
                            <div class="se-header">
                                <h4>Danh Sách Tập</h4>
                                <button class="se-close-btn" onclick="toggleMobileEpisodes(this)"><i class="ph-bold ph-x"></i></button>
                            </div>
                            <div class="episodes-grid custom-scrollbar">
                                ${epsHtml}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="story-hint"><i class="ph-bold ph-caret-up"></i> Vuốt xem tiếp</div>
            `;
            storyDOM.container.appendChild(itemDiv); itemDiv.dataset.isLast = 'true';
            storyObserver.observe(itemDiv); videoPlaybackObserver.observe(itemDiv); 
        }

        window.playStoryEpisode = (btn, link) => {
            const storyItem = btn.closest('.story-item');
            const iframe = storyItem.querySelector('iframe');
            const loader = storyItem.querySelector('.story-video-loader');
            if(loader) loader.style.display = 'flex';
            iframe.src = link;
            iframe.onload = () => { if(loader) loader.style.display = 'none'; };
            const grid = storyItem.querySelector('.episodes-grid');
            grid.querySelectorAll('.btn-episode').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        };

        window.toggleMobileEpisodes = (btn) => {
            const storyItem = btn.closest('.story-item');
            storyItem.classList.toggle('show-episodes');
        };

        window.toggleStoryLike = (btnElement, movieObj) => { 
            const isAdded = toggleFavorite(movieObj); 
            const iconObj = btnElement.querySelector('i');
            if (isAdded) { 
                btnElement.classList.add('liked'); 
                iconObj.className = 'ph-fill ph-heart'; 
            } else { 
                btnElement.classList.remove('liked'); 
                iconObj.className = 'ph-bold ph-heart'; 
            } 
        };
        window.watchFromStory = (slug) => { closeStoryMode(); loadMovieDetailAndGoHome(slug); };
        window.shareStory = () => { alert("Đã copy link phim vào khay nhớ tạm!"); };

        // Init
        window.onload = checkOnboarding;
    </script>
</body>
</html>
